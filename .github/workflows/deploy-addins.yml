name: Add-in Continuous Deployment

on:
  push:
    branches: [ main, staging ]
  pull_request:
    branches: [ main, staging ]

permissions:
  contents: read
  security-events: write
  actions: read

env:
  NODE_VERSION: '20'
  GCP_PROJECT_ID: 'attrix'

jobs:
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up matrix
        id: set-matrix
        run: |
          MATRIX=$(jq -c '{addin: .addins}' .github/addins-to-deploy.json)
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Matrix configuration:"
          echo "$MATRIX" | jq .

  install:
    runs-on: ubuntu-latest
    needs: setup-matrix
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Generate cache key
        id: cache-key
        run: echo "key=node-modules-${{ matrix.addin.name }}-${{ hashFiles(format('{0}/package-lock.json', matrix.addin.path)) }}" >> $GITHUB_OUTPUT

      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ${{ matrix.addin.path }}/node_modules
          key: ${{ steps.cache-key.outputs.key }}
          restore-keys: |
            node-modules-${{ matrix.addin.name }}-

      - name: Configure npm registry
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ${{ matrix.addin.path }}/.npmrc
          echo "@attrix:registry=https://registry.npmjs.org/" >> ${{ matrix.addin.path }}/.npmrc

      - name: Install dependencies
        working-directory: ${{ matrix.addin.path }}
        run: npm install

  test:
    runs-on: ubuntu-latest
    needs: [setup-matrix, install]
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node modules cache
        uses: actions/cache@v3
        with:
          path: ${{ matrix.addin.path }}/node_modules
          key: node-modules-${{ matrix.addin.name }}-${{ hashFiles(format('{0}/package-lock.json', matrix.addin.path)) }}

      - name: Run tests
        working-directory: ${{ matrix.addin.path }}
        run: |
          if npm run test 2>/dev/null; then
            echo "Tests completed successfully"
          else
            echo "No test script found or tests failed. Skipping tests."
            echo "To add tests, add a 'test' script to your package.json"
          fi
        continue-on-error: true

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.addin.name }}
          path: |
            ${{ matrix.addin.path }}/node_modules/
            ${{ matrix.addin.path }}/src/config.json
          retention-days: 1

  build:
    runs-on: ubuntu-latest
    needs: [setup-matrix, install, test]
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node modules cache
        uses: actions/cache@v3
        with:
          path: ${{ matrix.addin.path }}/node_modules
          key: node-modules-${{ matrix.addin.name }}-${{ hashFiles(format('{0}/package-lock.json', matrix.addin.path)) }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Configure build environment
        working-directory: ${{ matrix.addin.path }}
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          ADDIN_NAME=${{ matrix.addin.name }}
          HOST="https://storage.googleapis.com/geotab-addins/$BRANCH_NAME/$ADDIN_NAME/"
          jq --arg HOST "$HOST" '.dev.dist.host = $HOST' src/config.json > src/config.json.tmp
          mv src/config.json.tmp src/config.json
          cat src/config.json

      - name: Configure npm registry
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ${{ matrix.addin.path }}/.npmrc
          echo "@attrix:registry=https://registry.npmjs.org/" >> ${{ matrix.addin.path }}/.npmrc

      - name: Install webpack
        working-directory: ${{ matrix.addin.path }}
        run: npm install --save-dev webpack webpack-cli

      - name: Build project
        working-directory: ${{ matrix.addin.path }}
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-dist-${{ matrix.addin.name }}
          path: ${{ matrix.addin.path }}/dist/
          retention-days: 1

  deploy:
    runs-on: ubuntu-latest
    needs: [setup-matrix, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging'
    strategy:
      matrix: ${{ fromJson(needs.setup-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-dist-${{ matrix.addin.name }}
          path: dist/

      - name: Decode and setup Google Cloud credentials
        run: |
          echo "${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}" | base64 --decode > /tmp/gcs-key.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcs-key.json" >> $GITHUB_ENV

      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Authenticate with Google Cloud
        run: |
          gcloud auth activate-service-account --key-file=/tmp/gcs-key.json
          gcloud config set project ${{ env.GCP_PROJECT_ID }}

      - name: Deploy to Google Cloud Storage
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          ADDIN_NAME=${{ matrix.addin.name }}
          gsutil rsync -r ./dist gs://geotab-addins/$BRANCH_NAME/vibe/$ADDIN_NAME/

      - name: Cleanup credentials
        if: always()
        run: |
          rm -f /tmp/gcs-key.json

  post-deploy:
    runs-on: ubuntu-latest
    needs: [deploy]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure npm registry
        run: |
          echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > .npmrc

      - name: Install and run post-deploy package
        run: |
          npm install @attrix/vectorize-addin-source
          node -e "process.env.GCS_SERVICE_ACCOUNT_KEY = '${{ secrets.GCS_SERVICE_ACCOUNT_KEY }}'; require('./node_modules/@attrix/vectorize-addin-source/main.js');"

  # Security scanning (equivalent to GitLab SAST)
  security:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: Setup Node.js for npm audit
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run npm audit
        run: |
          npm audit --audit-level moderate
        continue-on-error: true
