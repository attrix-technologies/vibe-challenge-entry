"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FiltersSavedChipComponent = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const chip_1 = require("../../chip/chip");
const iconDisk_1 = require("../../icons/iconDisk");
const controlledPopup_1 = require("../../controlledPopup/controlledPopup");
const classNames_1 = require("../../commonHelpers/classNames/classNames");
const button_1 = require("../../button/button");
const iconClose_1 = require("../../icons/iconClose");
const useLanguage_1 = require("../../utils/localization/useLanguage");
const modal_1 = require("../../modal/modal");
const filtersSavedItemsProvider_1 = require("./filtersSavedItemsProvider");
const filtersSaveModal_1 = require("./filtersSaveModal");
const useDriveClassName_1 = require("../../utils/theme/useDriveClassName");
const FiltersSavedChipComponent = () => {
    const { translate } = (0, useLanguage_1.useLanguage)();
    const iconDriveClassName = (0, useDriveClassName_1.useDriveClassName)("icon");
    const contentDriveClassName = (0, useDriveClassName_1.useDriveClassName)("zen-filters-saved-popup__content");
    const { items, active, onRemove, onApply, onSave } = (0, filtersSavedItemsProvider_1.useFiltersSavedItems)();
    const [savedChipOpen, setSavedChipOpen] = (0, react_1.useState)(false);
    const [removeModalOpen, setRemoveModalOpen] = (0, react_1.useState)(false);
    const [saveModalOpen, setSaveModalOpen] = (0, react_1.useState)(false);
    const savedChipRef = (0, react_1.useRef)(null);
    const removeChipRef = (0, react_1.useRef)("");
    const handleRemove = (0, react_1.useCallback)((itemKey) => () => {
        removeChipRef.current = itemKey;
        setRemoveModalOpen(true);
    }, []);
    const toggleSavedChipOpen = (0, react_1.useCallback)(() => {
        setSavedChipOpen((prev) => !prev);
    }, []);
    const toggleRemoveModal = (0, react_1.useCallback)(() => {
        setRemoveModalOpen((prev) => !prev);
    }, []);
    const toggleSaveModal = (0, react_1.useCallback)(() => {
        setSaveModalOpen((prev) => !prev);
    }, []);
    const handleCancelRemoveModal = (0, react_1.useCallback)(() => {
        setRemoveModalOpen(false);
        removeChipRef.current = "";
    }, []);
    const handleRemoveItem = (0, react_1.useCallback)((e) => {
        e.stopPropagation();
        setRemoveModalOpen(false);
        onRemove && onRemove(removeChipRef.current);
        removeChipRef.current = "";
    }, [onRemove]);
    const handleFilterSelect = (0, react_1.useCallback)((e) => {
        const filterName = e.target.dataset.filterName;
        filterName && onApply && onApply(filterName);
    }, [onApply]);
    const handleItemKeyDown = (0, react_1.useCallback)((e) => {
        if (e.key === "Enter" || e.key === " ") {
            const filterName = e.currentTarget.dataset.filterName;
            filterName && onApply && onApply(filterName);
        }
    }, [onApply]);
    const saveButton = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsxs)("button", { type: "button", onClick: toggleSaveModal, className: "zen-filters-saved-popup__action-button", title: translate("Save new filters"), children: [(0, jsx_runtime_1.jsx)(iconDisk_1.IconDisk, { description: translate("Save"), className: "svgIcon", size: iconDriveClassName ? "huge" : "large" }), (0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)(["", "zen-ellipsis"]), children: translate("Save new") })] }), [iconDriveClassName, toggleSaveModal, translate]);
    const memoizedItems = (0, react_1.useMemo)(() => Array.from(items), [items]);
    const popupContent = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)(["zen-filters-saved-popup__content", contentDriveClassName || ""]), children: [onSave ? saveButton : null, (0, jsx_runtime_1.jsx)("div", { onClick: handleFilterSelect, children: memoizedItems.map((filterName) => ((0, jsx_runtime_1.jsxs)("div", { tabIndex: 0, onKeyDown: handleItemKeyDown, "data-filter-name": filterName, className: (0, classNames_1.classNames)(["zen-filters-saved-popup__item", active.has(filterName) ? "zen-filters-saved-popup__item--active" : ""]), children: [(0, jsx_runtime_1.jsx)("div", { className: "zen-filters-saved-popup__name", "data-filter-name": filterName, children: filterName }), onRemove ? (0, jsx_runtime_1.jsx)(button_1.Button, { type: "tertiary-black", className: "zen-filters-saved-popup__action", onClick: handleRemove(filterName), title: translate("Remove"), "aria-label": translate("Remove"), children: (0, jsx_runtime_1.jsx)(iconClose_1.IconClose, { size: iconDriveClassName ? "huge" : "large", className: "zen-filters-saved-popup__close-icon" }) }) : null] }, filterName))) })] }), [active, contentDriveClassName, handleFilterSelect, handleItemKeyDown, handleRemove, iconDriveClassName, memoizedItems, onRemove, onSave, saveButton, translate]);
    const memoizedStatus = (0, react_1.useMemo)(() => (active.size > 0 && Array.from(items).some(item => active.has(item)) ? "active" : undefined), [active, items]);
    return ((0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(chip_1.Chip, { className: "zen-filters-saved-chip", isOpen: savedChipOpen, status: memoizedStatus, onClick: toggleSavedChipOpen, title: translate("Saved filters"), icon: iconDisk_1.IconDisk, triggerRef: savedChipRef }), (0, jsx_runtime_1.jsx)(controlledPopup_1.ControlledPopup, { isOpen: savedChipOpen, className: (0, classNames_1.classNames)(["zen-filters-saved-popup"]), onOpenChange: toggleSavedChipOpen, useTrapFocusWithTrigger: "on", shouldHoldScroll: true, triggerRef: savedChipRef, ariaLabel: translate("Saved filters"), recalculateOnScroll: true, children: popupContent }), (0, jsx_runtime_1.jsxs)(modal_1.Modal, { isOpen: removeModalOpen, onClose: toggleRemoveModal, title: translate("Remove saved {name} filter?").replace("{name}", removeChipRef.current), children: [(0, jsx_runtime_1.jsx)(modal_1.Modal.SecondaryButton, { onClick: handleCancelRemoveModal, children: translate("Cancel") }), (0, jsx_runtime_1.jsx)(modal_1.Modal.PrimaryButton, { onClick: handleRemoveItem, type: "destructive", children: translate("Confirm") })] }), onSave ? (0, jsx_runtime_1.jsx)(filtersSaveModal_1.FiltersSaveModal, { isOpen: saveModalOpen, onClose: setSaveModalOpen, onSave: onSave }) : null] }));
};
exports.FiltersSavedChipComponent = FiltersSavedChipComponent;
