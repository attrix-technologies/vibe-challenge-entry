"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.FiltersContainer = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const classNames_1 = require("../../commonHelpers/classNames/classNames");
const chip_1 = require("../../chip/chip");
const react_2 = __importDefault(require("react"));
const iconFilter_1 = require("../../icons/iconFilter");
const iconPin2_1 = require("../../icons/iconPin2");
const filtersHelper_1 = require("../filtersHelper");
const filtersSavedChipComponent_1 = require("./filtersSavedChipComponent");
const iconClose_1 = require("../../icons/iconClose");
const chipStatusProvider_1 = require("../../chip/chipStatusProvider");
const useLanguage_1 = require("../../utils/localization/useLanguage");
const FiltersContainer = ({ className, isPinned = false, onPinChange, filtersClickHandler, hasSavedFilters, filtersForCalculation, children }) => {
    const chipStatus = (0, chipStatusProvider_1.useChipStatus)();
    const { translate } = (0, useLanguage_1.useLanguage)();
    const numberOfChangedFilters = (0, react_1.useMemo)(() => {
        const suppressedFilters = new Set();
        filtersForCalculation.forEach(filter => {
            const inhibited = (filter.props).inhibit;
            if (inhibited) {
                inhibited.forEach((id) => suppressedFilters.add(id));
            }
        });
        const filteredState = (0, filtersHelper_1.getFiltersState)(filtersForCalculation.filter(f => !suppressedFilters.has(f.props.id)));
        return (0, filtersHelper_1.getNumberOfChangedFilters)(filteredState);
    }, [filtersForCalculation]);
    const filtersChipRef = (0, react_1.useRef)(null);
    const handlePinChange = (0, react_1.useCallback)((newIsPinned) => {
        onPinChange && onPinChange(newIsPinned);
    }, [onPinChange]);
    const pinComponent = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsx)(chip_1.Chip, { active: isPinned, status: isPinned ? "accent" : undefined, onChange: handlePinChange, icon: iconPin2_1.IconPin2, children: isPinned ? "" : "+" }), [isPinned, handlePinChange]);
    const filtersChipComponent = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsx)(chip_1.Chip, { quantity: numberOfChangedFilters, isOpen: false, status: numberOfChangedFilters > 0 ? chipStatus || "active" : undefined, onClick: filtersClickHandler, icon: iconFilter_1.IconFilter, title: translate("All Filters"), triggerRef: filtersChipRef, children: "+" }), [numberOfChangedFilters, chipStatus, filtersClickHandler, translate]);
    const childrenSignature = (0, react_1.useMemo)(() => {
        const childrenArray = react_2.default.Children.toArray(children).filter(Boolean);
        return childrenArray
            .map(child => {
            if (!react_2.default.isValidElement(child)) {
                return "invalid";
            }
            const childId = child.props.id || "no-id";
            const state = child.props.state;
            const defaultState = child.props.defaultState;
            const childPropsQuery = JSON.stringify(child.props.fetchState || {});
            const stateHash = (0, filtersHelper_1.createStateHash)(state);
            const defaultStateHash = (0, filtersHelper_1.createStateHash)(defaultState);
            const propsHash = (0, filtersHelper_1.createPropsHash)(child.props);
            return `${childId}|${stateHash}|${defaultStateHash}|${propsHash}|${childPropsQuery}`;
        })
            .join("||");
    }, [children]);
    const memoizedChildren = (0, react_1.useMemo)(() => (0, filtersHelper_1.stabilizeChildrenWithId)(children).filter(Boolean), 
    // eslint-disable-next-line react-hooks/exhaustive-deps
    [childrenSignature]);
    const handleRemovalClick = (0, react_1.useCallback)(() => {
        const defaultState = (0, filtersHelper_1.createStateObject)(filtersForCalculation, "defaultState");
        filtersForCalculation.forEach((child) => {
            var _a, _b;
            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
            if (child) {
                const childDefaultState = defaultState[child.props.id];
                (_b = (_a = child.props).onChange) === null || _b === void 0 ? void 0 : _b.call(_a, childDefaultState);
            }
        });
        onPinChange === null || onPinChange === void 0 ? void 0 : onPinChange(false);
    }, [filtersForCalculation, onPinChange]);
    const chipRemovalComponent = (0, react_1.useMemo)(() => numberOfChangedFilters ?
        (0, jsx_runtime_1.jsx)(chip_1.Chip, { title: translate("Clear"), className: "zen-filters-container__removal-chip", active: false, status: isPinned ? "accent" : undefined, onChange: handleRemovalClick, icon: iconClose_1.IconClose })
        : null, [isPinned, handleRemovalClick, translate, numberOfChangedFilters]);
    return (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)(["zen-filters-container", className || ""]), children: [memoizedChildren, onPinChange ? pinComponent : null, hasSavedFilters ? (0, jsx_runtime_1.jsx)(filtersSavedChipComponent_1.FiltersSavedChipComponent, {}) : null, filtersChipComponent, chipRemovalComponent] });
};
exports.FiltersContainer = FiltersContainer;
