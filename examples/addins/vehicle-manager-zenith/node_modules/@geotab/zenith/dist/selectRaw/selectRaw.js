"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SelectRaw = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const checkboxState_1 = require("../checkbox/checkboxState");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const keyboard_1 = require("../commonHelpers/keyboard");
const selectList_1 = require("../selectList/selectList");
const selectList_actionTypes_1 = require("../selectList/selectList.actionTypes");
const select_actionTypes_1 = require("./select.actionTypes");
const select_reducer_1 = require("./select.reducer");
const select_helpers_1 = require("./select.helpers");
const isChildOf_1 = require("../utils/isChildOf");
const iconChevronDownSmall_1 = require("../icons/iconChevronDownSmall");
const absolute_1 = require("../absolute/absolute");
const usePopupWidth_1 = require("./hooks/usePopupWidth");
// get default active item (based on items array)
const getItemById = (items, id) => items.find(item => item.id === id);
const closedListActionGetters = {
    "ArrowDown": (items) => ({ type: select_actionTypes_1.SelectAction.Expand, payload: { items } }),
    "Alt+ArrowDown": (items) => ({ type: select_actionTypes_1.SelectAction.Expand, payload: { items } }),
    "ArrowUp": (items) => ({ type: select_actionTypes_1.SelectAction.FocusFirstAndExpand, payload: { items } }),
    "Enter": (items) => ({ type: select_actionTypes_1.SelectAction.Expand, payload: { items } }),
    "Space": (items) => ({ type: select_actionTypes_1.SelectAction.Expand, payload: { items } }),
    "Home": (items) => ({ type: select_actionTypes_1.SelectAction.Expand, payload: { items } }),
    "End": (items) => ({ type: select_actionTypes_1.SelectAction.Expand, payload: { items } }),
    "default": (items, e) => ({ type: select_actionTypes_1.SelectAction.SearchAndExpand, payload: { items, key: e.key } })
};
const openListActionGetters = {
    "Enter": () => ({ type: selectList_actionTypes_1.ListAction.ToggleCurrent, payload: { multiselect: false } }),
    "Space": () => ({ type: selectList_actionTypes_1.ListAction.ToggleCurrent, payload: { multiselect: false } }),
    "Tab": () => ({ type: selectList_actionTypes_1.ListAction.Blur, payload: { multiselect: false } }),
    "Escape": () => ({ type: select_actionTypes_1.SelectAction.Collapse, payload: {} }),
    "ArrowDown": (items) => ({ type: selectList_actionTypes_1.ListAction.FocusNext, payload: { items } }),
    "ArrowUp": (items) => ({ type: selectList_actionTypes_1.ListAction.FocusPrev, payload: { items } }),
    "Alt+ArrowUp": () => ({ type: selectList_actionTypes_1.ListAction.ToggleCurrent, payload: { multiselect: false } }),
    "Home": (items) => ({ type: selectList_actionTypes_1.ListAction.FocusFirst, payload: { items } }),
    "End": (items) => ({ type: selectList_actionTypes_1.ListAction.FocusLast, payload: { items } }),
    "PageUp": (items, _, pageSize) => ({ type: selectList_actionTypes_1.ListAction.FocusPrevPage, payload: { items, pageSize } }),
    "PageDown": (items, _, pageSize) => ({ type: selectList_actionTypes_1.ListAction.FocusNextPage, payload: { items, pageSize } }),
    "default": (items, e) => ({ type: selectList_actionTypes_1.ListAction.SearchItem, payload: { items, key: e.key } })
};
const PassiveSelectListComp = react_1.default.memo(selectList_1.PassiveSelectList);
exports.SelectRaw = react_1.default.forwardRef((props, selectRef) => {
    var _a;
    const { id, title, pageSize = 10, placeholder, disabled, className, classNamePopup, items: outerItems, value: outerValue, isError, onChange, forceSelection = false } = props;
    const items = react_1.default.useMemo(() => outerItems, [outerItems]);
    const [state, dispatchState] = react_1.default.useReducer(select_reducer_1.selectReducer, { items, value: outerValue }, select_helpers_1.getSelectInitialState);
    const value = (0, select_helpers_1.getSelectValue)(state.itemsState, items);
    const innerTriggerRef = react_1.default.useRef(null);
    const ref = react_1.default.useRef(null);
    const [isOpen, setIsOpen] = (0, react_1.useState)(false);
    const onPopupVisibilityChange = (0, react_1.useCallback)(() => {
        setIsOpen(!isOpen);
    }, [isOpen]);
    const collapsePopup = (0, react_1.useCallback)(() => {
        setIsOpen(false);
    }, []);
    react_1.default.useImperativeHandle(selectRef, () => innerTriggerRef.current, []);
    const listId = react_1.default.useId();
    const classes = (0, classNames_1.classNames)(["zen-select zen-text-input-layout", disabled ? "zen-select--disabled" : "", className || ""]);
    const text = value ? (_a = getItemById(items, value)) === null || _a === void 0 ? void 0 : _a.children : placeholder;
    // Reset state when value changed
    react_1.default.useEffect(() => {
        const itemsValue = (0, select_helpers_1.getSelectInitialState)({ items, value: outerValue }).itemsState;
        dispatchState({ type: selectList_actionTypes_1.ListAction.Reset, payload: { items, value: itemsValue, multiselect: false } });
    }, [outerValue, items]);
    react_1.default.useEffect(() => {
        if (state.activeIndex >= 0 && document.activeElement && ref.current && (0, isChildOf_1.isChildOf)(document.activeElement, ref.current)) {
            const itemEl = ref.current.querySelector(`.zen-select-list__item:nth-child(${state.activeIndex + 1})`);
            itemEl === null || itemEl === void 0 ? void 0 : itemEl.scrollIntoView({ block: "nearest" });
        }
    }, [state.activeIndex]);
    function onBlur(e) {
        if (!innerTriggerRef.current || !state.expanded || disabled) {
            return;
        }
        if (!e.relatedTarget || !(0, isChildOf_1.isChildOf)(e.relatedTarget, innerTriggerRef.current.parentElement)) {
            dispatchState({ type: select_actionTypes_1.SelectAction.CollapseAndSelect, payload: { items: items } });
            return;
        }
        innerTriggerRef.current.focus();
        return;
    }
    const onChangeItem = react_1.default.useCallback((updatedId, updatedState) => {
        const blockOnChange = updatedState === checkboxState_1.CheckboxState.Off && forceSelection;
        if (disabled) {
            return;
        }
        onPopupVisibilityChange();
        if (blockOnChange) {
            return;
        }
        dispatchState({ type: selectList_actionTypes_1.ListAction.ChangeItemState, payload: { updatedId, updatedState, multiselect: false } });
    }, [disabled, onPopupVisibilityChange, forceSelection]);
    const onTriggerKeyDown = (e) => {
        if (disabled) {
            return;
        }
        const handlerName = (0, keyboard_1.getKeysPressed)(e);
        const getAction = !state.expanded
            ? closedListActionGetters[handlerName] || ((0, keyboard_1.isKeyForSearch)(e.code) && closedListActionGetters["default"])
            : openListActionGetters[handlerName] || ((0, keyboard_1.isKeyForSearch)(e.code) && openListActionGetters["default"]);
        if (getAction) {
            dispatchState(getAction(items, e, pageSize));
            if (e.code !== "Tab") {
                e.preventDefault();
                e.stopPropagation();
            }
            if (e.code === "Enter" || e.code === "Space") {
                onPopupVisibilityChange();
            }
            if (e.code === "Escape") {
                collapsePopup();
            }
        }
    };
    const popupId = (0, react_1.useId)();
    react_1.default.useEffect(() => {
        if (disabled || !state.isItemsStateChanged || !onChange) {
            return;
        }
        onChange(value);
    }, [state.isItemsStateChanged, value, disabled, onChange]);
    const { width, maxWidth, minWidth } = (0, usePopupWidth_1.usePopupWidth)(ref);
    return (0, jsx_runtime_1.jsxs)("div", { className: classes, ref: ref, children: [(0, jsx_runtime_1.jsxs)("div", { "aria-controls": listId, "aria-expanded": state.expanded, "aria-haspopup": "listbox", "aria-label": title, "aria-disabled": disabled, id: id, className: (0, classNames_1.classNames)([
                    "zen-select__trigger",
                    "zen-text-input",
                    isError ? "zen-text-input--error" : "",
                    "zen-caption zen-caption--full-width"
                ]), role: "combobox", tabIndex: disabled ? -1 : 0, "aria-activedescendant": (isOpen && state.activeIndex > -1) ? items[state.activeIndex].id : undefined, onClick: onPopupVisibilityChange, onKeyDown: onTriggerKeyDown, onBlur: onBlur, ref: innerTriggerRef, children: [(0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)(["zen-select__text", "zen-ellipsis", "zen-caption__content", !value ? "zen-select__text--placeholder" : ""]), children: text }), (0, jsx_runtime_1.jsx)(iconChevronDownSmall_1.IconChevronDownSmall, { className: "zen-select__arrow zen-caption__post-content", size: "large" })] }), (0, jsx_runtime_1.jsx)(absolute_1.Absolute, { recalculateOnScroll: true, className: (0, classNames_1.classNames)(["zen-select__popup", classNamePopup || ""]), triggerRef: innerTriggerRef, id: popupId, isOpen: isOpen, onOpenChange: onPopupVisibilityChange, children: (0, jsx_runtime_1.jsx)(PassiveSelectListComp, { id: listId, title: title, disabled: disabled, multiselect: false, items: items.map(item => (Object.assign(Object.assign({}, item), { state: value === item.id ? checkboxState_1.CheckboxState.On : checkboxState_1.CheckboxState.Off }))), value: new Map(items.map(item => ([item.id, value === item.id ? checkboxState_1.CheckboxState.On : checkboxState_1.CheckboxState.Off]))), activeIndex: state.activeIndex, size: pageSize, onChangeItem: onChangeItem, style: { width, minWidth, maxWidth } }) })] });
});
exports.SelectRaw.displayName = "SelectRaw";
