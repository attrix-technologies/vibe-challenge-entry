"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Toolbar = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const toolbarContent_1 = require("./toolbarContent");
const toolbarMoreButton_1 = require("./toolbarMoreButton");
const getDisplayingElementsIndex_1 = require("./helpers/getDisplayingElementsIndex");
const useResize_1 = require("../commonHelpers/hooks/useResize");
const useThrottle_1 = require("../commonHelpers/hooks/useThrottle");
const getWidthWithoutPadding_1 = require("./helpers/getWidthWithoutPadding");
const getToolbarChildren_1 = require("./helpers/getToolbarChildren");
/**
    @deprecated - will be removed in future releases
*/
const Toolbar = ({ className, children }) => {
    const [toolbarWidthChanges, setToolbarWidthChanges] = (0, react_1.useState)(0);
    const toolbarRef = (0, react_1.useRef)(null);
    const defaultBlock = "start";
    const moreBlockRef = (0, react_1.useRef)(null);
    const customizableMoreRef = (0, react_1.useRef)(null);
    const [width, setWidth] = (0, react_1.useState)(null);
    const [toolbarRectWidth, setToolbarRectWidth] = (0, react_1.useState)(null);
    const resizeCallBack = (0, useThrottle_1.useThrottle)(() => {
        setWidth(null);
        setToolbarRectWidth(null);
        setToolbarWidthChanges((val) => val + 1);
    }, 500);
    (0, useResize_1.useResize)(resizeCallBack, toolbarRef.current !== null);
    let more;
    let block = new Map();
    const toolbarChildren = (0, getToolbarChildren_1.getToolbarChildren)(children);
    if (toolbarChildren) {
        const extraBlock = new Map();
        toolbarChildren.forEach((child) => {
            var _a;
            if (child.type === toolbarContent_1.ToolbarContent && child.props.children) {
                const childToAdd = Array.isArray(child.props.children) ? [...child.props.children] : [Object.assign({}, child.props.children)];
                const moreContentIndex = childToAdd.findIndex(elem => elem.type === toolbarMoreButton_1.ToolbarMoreButton);
                const moreContent = moreContentIndex >= 0 ? childToAdd[moreContentIndex] : undefined;
                if (moreContent && ((_a = moreContent.props) === null || _a === void 0 ? void 0 : _a.children)) {
                    const cleanMoreContent = Object.assign(Object.assign({}, moreContent), { props: Object.assign(Object.assign({}, moreContent.props), { children: undefined }) });
                    childToAdd.splice(moreContentIndex, 1, cleanMoreContent);
                }
                const field = child.props.blockName || undefined;
                field && extraBlock.set(field, extraBlock.has(field) ? [...extraBlock.get(field) || [], childToAdd]
                    : [...childToAdd]);
            }
        });
        if (toolbarChildren.every((el) => el.type !== toolbarContent_1.ToolbarContent)) {
            toolbarChildren.forEach(el => {
                if (extraBlock.has(defaultBlock)) {
                    extraBlock.set(defaultBlock, [...extraBlock.get(defaultBlock) || [], el]);
                }
                else {
                    extraBlock.set(defaultBlock, [el]);
                }
            });
        }
        more = undefined;
        block = new Map(extraBlock);
    }
    if (width && toolbarRectWidth && width >= toolbarRectWidth && toolbarRef.current) {
        const toolbarChildNodes = toolbarRef.current.childNodes;
        const displayingElementsIndexes = (0, getDisplayingElementsIndex_1.getDisplayingElementsIndex)(toolbarRectWidth, toolbarChildNodes);
        const newBlock = new Map();
        const newMore = [];
        for (const [key, value] of block.entries()) {
            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
            if (displayingElementsIndexes.displayingElements[key]) {
                const newValue = value === null || value === void 0 ? void 0 : value.filter((_, ind) => displayingElementsIndexes.displayingElements[key].includes(ind));
                const moreValue = value === null || value === void 0 ? void 0 : value.filter((_, ind) => !displayingElementsIndexes.displayingElements[key].includes(ind));
                newBlock.set(key, newValue);
                (moreValue === null || moreValue === void 0 ? void 0 : moreValue.length) && newMore.push(moreValue);
            }
            else {
                (value === null || value === void 0 ? void 0 : value.length) && newMore.push(value);
            }
        }
        if (Object.keys(displayingElementsIndexes.customizableMore).length) {
            const newCustomizableMore = newBlock.get(Object.keys(displayingElementsIndexes.customizableMore)[0]);
            const moreEltInd = newCustomizableMore.findIndex(el => el.type === toolbarMoreButton_1.ToolbarMoreButton);
            let moreElt = newCustomizableMore[moreEltInd];
            if (moreElt) {
                moreElt = Object.assign(Object.assign({}, moreElt), { props: Object.assign(Object.assign({}, moreElt.props), { children: [...newMore].reduce((acc, child) => acc.concat(child), []) }) });
                newCustomizableMore.splice(moreEltInd, 1, moreElt);
            }
        }
        more = newMore.length ? [...newMore] : undefined;
        block = new Map(newBlock);
    }
    (0, react_1.useLayoutEffect)(() => {
        if (!toolbarRef.current) {
            return;
        }
        const currToolbarReactWidth = (0, getWidthWithoutPadding_1.getWidthWithoutPadding)(toolbarRef.current);
        const toolbarChildNodes = toolbarRef.current.childNodes;
        let currWidth = 0;
        toolbarChildNodes.forEach(el => {
            currWidth += el.getBoundingClientRect().width;
        });
        setWidth(currWidth);
        setToolbarRectWidth(currToolbarReactWidth);
    }, [toolbarWidthChanges]);
    const createExtraContent = (0, react_1.useCallback)((blockEl) => {
        const content = [];
        if (blockEl.size) {
            for (const [key, value] of blockEl.entries()) {
                content.push((0, jsx_runtime_1.jsx)(toolbarContent_1.ToolbarContent, { blockName: key, ref: customizableMoreRef, children: value }, key));
            }
        }
        return content.length ? content : undefined;
    }, []);
    return (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)(["zen-toolbar", className ? className : "", "zen-toolbar--separate"]), ref: toolbarRef, children: [createExtraContent(block), !customizableMoreRef.current && more && (0, jsx_runtime_1.jsx)("div", { className: "zen-toolbar__dropdown-block", ref: moreBlockRef, "data-name": "more", children: (0, jsx_runtime_1.jsx)(toolbarMoreButton_1.ToolbarMoreButton, { children: more.reduce((acc, element) => acc.concat(element), []) }) })] });
};
exports.Toolbar = Toolbar;
