"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSLATIONS = exports.AdvancedGroupsFilterFormSection = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = __importStar(require("react"));
const groupButton_1 = require("../groupButton/groupButton");
const groupsFilterInterfaces_1 = require("../groupsFilter/groupsFilterInterfaces");
const advancedGroupsFilterSectionTooltip_1 = require("./advancedGroupsFilterSectionTooltip");
const dropdown_1 = require("../dropdown/dropdown");
const comboboxSelected_1 = require("../comboboxSelected/comboboxSelected");
const advancedGroupsFilterHelper_1 = require("./advancedGroupsFilterHelper");
const groupsHelper_1 = require("../groupsFilter/groupsHelper");
const useLanguage_1 = require("../utils/localization/useLanguage");
const focusableSelector_1 = require("../utils/focusableSelector");
const AdvancedGroupsFilterFormSection = ({ state, interSectionRelation, itemId, onInterSectionChange, onRelationChange, onRemoveCondition, onStateChange, getData, errorHandler, dataItems, isHasRemoveConditionButton, isHasTooltip, tooltipText }) => {
    const { translate } = (0, useLanguage_1.useLanguage)();
    const inputItem = (0, react_1.useId)();
    const [currentSelection, setCurrentSelection] = react_1.default.useState((0, advancedGroupsFilterHelper_1.getCurrentSelectionFromIds)(state.items, dataItems));
    const isPrevEmptyComboItems = (0, react_1.useRef)(dataItems.length === 0);
    const comboboxRef = (0, react_1.useRef)(null);
    const pillBoxRef = (0, react_1.useRef)(null);
    const handleInterSectionRelationChange = () => {
        onInterSectionChange(itemId);
    };
    const handleFocusOnRemove = (0, react_1.useCallback)((newSelectedFirstItem) => {
        var _a, _b, _c;
        if (newSelectedFirstItem) {
            const pillBoxElement = (_a = pillBoxRef.current) === null || _a === void 0 ? void 0 : _a.querySelector(`.zen-pill-box__pill[data-id="${newSelectedFirstItem}"]`);
            const focusable = pillBoxElement ?
                [...Array.from(pillBoxElement.querySelectorAll(focusableSelector_1.FOCUSABLE_SELECTOR))] : undefined;
            (_b = focusable === null || focusable === void 0 ? void 0 : focusable[0]) === null || _b === void 0 ? void 0 : _b.focus();
        }
        else {
            const focusable = comboboxRef.current ? [...Array.from(comboboxRef.current.querySelectorAll(focusableSelector_1.FOCUSABLE_SELECTOR))] : undefined;
            (_c = focusable === null || focusable === void 0 ? void 0 : focusable[0]) === null || _c === void 0 ? void 0 : _c.focus();
        }
    }, []);
    const handleRelationChange = () => {
        onRelationChange(itemId);
    };
    const handleRemove = (item) => {
        var _a;
        const newValue = currentSelection.filter(el => el.id !== item);
        setCurrentSelection(newValue);
        onStateChange(itemId, newValue.map((el) => el.id));
        handleFocusOnRemove((_a = newValue[0]) === null || _a === void 0 ? void 0 : _a.id);
    };
    const handleSelection = (newSelection) => {
        setCurrentSelection(newSelection);
        onStateChange(itemId, newSelection.map((el) => el.id));
    };
    (0, react_1.useEffect)(() => {
        if (isPrevEmptyComboItems.current && dataItems.length > 0) {
            isPrevEmptyComboItems.current = false;
            setCurrentSelection((0, advancedGroupsFilterHelper_1.getCurrentSelectionFromIds)(state.items, dataItems));
        }
    }, [dataItems, state.items]);
    return (0, jsx_runtime_1.jsxs)("li", { className: "zen-advanced-groups-filter-form__section", children: [interSectionRelation ? (0, jsx_runtime_1.jsx)("div", { className: "zen-advanced-groups-filter-form__section", children: (0, jsx_runtime_1.jsx)("div", { className: "zen-advanced-groups-filter-form__inter-section-switcher", children: (0, jsx_runtime_1.jsx)(groupButton_1.GroupButton, { onChange: handleInterSectionRelationChange, groupData: [
                            { name: translate("And"), value: groupsFilterInterfaces_1.RelationOperator.AND, selected: interSectionRelation === groupsFilterInterfaces_1.RelationOperator.AND },
                            { name: translate("Or"), value: groupsFilterInterfaces_1.RelationOperator.OR, selected: interSectionRelation === groupsFilterInterfaces_1.RelationOperator.OR }
                        ] }) }) }) : null, (0, jsx_runtime_1.jsxs)("div", { className: "zen-advanced-groups-filter-form__main-section", children: [(0, jsx_runtime_1.jsxs)("div", { className: "zen-advanced-groups-filter-form__section-column zen-advanced-groups-filter-form__section-column--left", children: [(0, jsx_runtime_1.jsxs)("div", { className: "zen-advanced-groups-filter-form__section-label zen-advanced-groups-filter-form__operator-section", children: [(0, jsx_runtime_1.jsx)("div", { className: "zen-advanced-groups-filter-form__operator-label", children: translate("Operator") }), isHasTooltip && (0, jsx_runtime_1.jsx)(advancedGroupsFilterSectionTooltip_1.AdvancedGroupsFilterSectionTooltip, { ariaLabel: "Information", text: tooltipText })] }), (0, jsx_runtime_1.jsx)(groupButton_1.GroupButton, { onChange: handleRelationChange, groupData: [
                                    { name: translate("And"), value: groupsFilterInterfaces_1.RelationOperator.AND, selected: state.relation === groupsFilterInterfaces_1.RelationOperator.AND },
                                    { name: translate("Or"), value: groupsFilterInterfaces_1.RelationOperator.OR, selected: state.relation === groupsFilterInterfaces_1.RelationOperator.OR }
                                ] })] }), (0, jsx_runtime_1.jsxs)("div", { className: "zen-advanced-groups-filter-form__section-column zen-advanced-groups-filter-form__section-column--right", children: [(0, jsx_runtime_1.jsx)("label", { className: "zen-advanced-groups-filter-form__section-label", children: translate("Groups") }), isHasRemoveConditionButton && (0, jsx_runtime_1.jsx)("button", { type: "button", className: "zen-advanced-groups-filter-form__remove-button", "data-item": itemId, onClick: onRemoveCondition, children: translate("Remove condition") }), (0, jsx_runtime_1.jsxs)("div", { className: "zen-advanced-groups-filter-form__combo-section", children: [(0, jsx_runtime_1.jsx)("div", { className: "zen-advanced-groups-filter-form__combo-box", ref: comboboxRef, children: (0, jsx_runtime_1.jsx)(dropdown_1.Dropdown, { classNamePopup: "zen-advanced-groups-filter-form__popup", getData: getData, errorHandler: errorHandler, dataItems: dataItems, onChange: handleSelection, value: state.items.map((el) => el.id), placeholder: translate("Select groups…"), inputId: `${inputItem}-dropdown-${itemId}`, showCounterPill: true }) }), (0, jsx_runtime_1.jsx)("div", { className: "zen-advanced-groups-filter-form__selected-box", ref: pillBoxRef, children: (0, jsx_runtime_1.jsx)(comboboxSelected_1.ComboboxSelected, { selection: (0, advancedGroupsFilterHelper_1.getCurrentSelectionFromIds)(state.items, dataItems).map((el) => ({ id: el.id, name: el.name })), onRemove: handleRemove, pillEmptyText: groupsHelper_1.ENTIRE_ORGANIZATION_GROUP_ID }) })] })] })] })] });
};
exports.AdvancedGroupsFilterFormSection = AdvancedGroupsFilterFormSection;
exports.TRANSLATIONS = [
    ...advancedGroupsFilterSectionTooltip_1.TRANSLATIONS,
    ...dropdown_1.TRANSLATIONS,
    ...comboboxSelected_1.TRANSLATIONS,
    "Operator",
    "Information",
    "Groups",
    "Remove condition",
    "Remove selection",
    "Select groups…",
    "And",
    "Or"
];
