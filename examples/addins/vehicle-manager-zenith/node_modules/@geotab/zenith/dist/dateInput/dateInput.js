"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSLATIONS = exports.DateInput = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const textIconButton_1 = require("../textIconButton/textIconButton");
const button_1 = require("../button/button");
const iconCalendar_1 = require("../icons/iconCalendar");
const react_1 = require("react");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const buttonType_1 = require("../button/buttonType");
const useLanguage_1 = require("../utils/localization/useLanguage");
const userFormatContext_1 = require("../utils/userFormat/userFormatContext");
const useUniqueId_1 = require("../commonHelpers/useUniqueId");
const formatDate_1 = require("../utils/formatDate");
const controlledPopup_1 = require("../controlledPopup/controlledPopup");
const dateInputInner_1 = require("../dateInputInner/dateInputInner");
const cutSeconds_1 = require("./cutSeconds");
const getLabel_1 = require("./getLabel");
const useMobile_1 = require("../commonHelpers/hooks/useMobile");
const formFieldError_1 = require("../formFieldError/formFieldError");
const footerButtons_1 = require("../footerButtons/footerButtons");
const mobileSheet_1 = require("../mobileSheet/mobileSheet");
const useDriveClassName_1 = require("../utils/theme/useDriveClassName");
const DateInput = ({ className, classNamePopup, defaultValue, value, onChange, id, disabled, dropDownTitle, timeSelect, disableFutureDates, disablePastDates, disableDatesBefore, disableDatesAfter, error, requireSelection = false, buttonLabel }) => {
    const { translate } = (0, useLanguage_1.useLanguage)();
    const isMobile = (0, useMobile_1.useMobile)();
    const drivePopupClassName = (0, useDriveClassName_1.useDriveClassName)("zen-date-input-popup");
    const driveWrapperClassName = (0, useDriveClassName_1.useDriveClassName)("zen-date-input-popup-wrapper");
    const { dateFormat, timeFormat, weekStartsOnSunday, toLocalDateTime } = (0, react_1.useContext)(userFormatContext_1.userFormatContext);
    const dateFormatter = (0, react_1.useCallback)((d) => (0, formatDate_1.formatDate)(toLocalDateTime(d), dateFormat, translate), [dateFormat, toLocalDateTime, translate]);
    const dateDeformatter = (0, react_1.useCallback)((d) => (0, formatDate_1.deformatDate)(d, dateFormat, translate) || new Date(""), [dateFormat, translate]);
    const [isOpen, setIsOpen] = (0, react_1.useState)(false);
    const [renderContent, setRenderContent] = (0, react_1.useState)(false);
    const prevIsOpenRef = (0, react_1.useRef)(false);
    const [customDate, setCustomDate] = (0, react_1.useState)(value);
    const triggerRef = (0, react_1.useRef)(null);
    const [prevValue, setPrevValue] = (0, react_1.useState)(value);
    const isDefaultState = (0, react_1.useMemo)(() => (0, cutSeconds_1.cutSeconds)(defaultValue) === (0, cutSeconds_1.cutSeconds)(customDate), [defaultValue, customDate]);
    const isValueState = (0, react_1.useMemo)(() => (0, cutSeconds_1.cutSeconds)(value) === (0, cutSeconds_1.cutSeconds)(customDate), [value, customDate]);
    const componentId = (0, useUniqueId_1.useUniqueId)();
    const cssClass = (0, classNames_1.classNames)([
        "zen-date-input",
        error ? "zen-date-input--error" : "",
        className !== null && className !== void 0 ? className : "",
        !value || (0, cutSeconds_1.cutSeconds)(defaultValue) === (0, cutSeconds_1.cutSeconds)(value) ? "" : "zen-date-input--active"
    ]);
    const title = (0, react_1.useMemo)(() => dropDownTitle || translate("Pick a date"), [dropDownTitle, translate]);
    const toggleVisibility = (0, react_1.useCallback)(() => setIsOpen(currentIsOpen => !currentIsOpen), []);
    const getButtonLabel = (0, react_1.useCallback)((getTitle) => (0, getLabel_1.getLabel)(value, dateFormat, timeFormat, translate, toLocalDateTime, timeSelect, buttonLabel, getTitle), [value, dateFormat, timeFormat, timeSelect, translate, toLocalDateTime, buttonLabel]);
    (0, react_1.useEffect)(() => {
        if (prevValue !== value) {
            setPrevValue(value);
        }
    }, [prevValue, value]);
    const onCalendarChange = (0, react_1.useCallback)((val) => {
        setCustomDate(val.from);
    }, []);
    const handleRangeSelection = (0, react_1.useCallback)(() => {
        const newState = customDate;
        setPrevValue(newState);
        onChange(newState);
        setCustomDate(newState);
        setIsOpen(false);
    }, [customDate, onChange]);
    const handleApplyClick = (0, react_1.useCallback)(() => {
        setIsOpen(false);
        handleRangeSelection();
    }, [handleRangeSelection]);
    const handleClearClick = (0, react_1.useCallback)(() => {
        setCustomDate(defaultValue);
    }, [defaultValue]);
    (0, react_1.useEffect)(() => {
        setCustomDate(value);
    }, [value]);
    const memoizedHandleClose = (0, react_1.useCallback)(() => {
        setIsOpen(false);
    }, [setIsOpen]);
    const onReadyForFocus = (0, react_1.useCallback)((isCurrentOpen) => {
        if (!isMobile) {
            return;
        }
        if (isCurrentOpen) {
            setRenderContent(true);
            return;
        }
        setRenderContent(false);
        prevIsOpenRef.current = isCurrentOpen;
    }, [isMobile]);
    const component = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsx)("div", { className: "zen-date-input-inner__calendar-wrapper", children: (0, jsx_runtime_1.jsx)(dateInputInner_1.DateInputInner, { id: id || componentId, value: { from: customDate, to: undefined }, onChange: onCalendarChange, dateFormat: dateFormat, dateFormatter: dateFormatter, dateDeformatter: dateDeformatter, startDayOfWeek: weekStartsOnSunday ? 0 : 1, dateRangeMode: false, selectTime: timeSelect, disableFutureDates: disableFutureDates, disablePastDates: disablePastDates, disableDatesAfter: disableDatesAfter, disableDatesBefore: disableDatesBefore, title: "", isMobileView: isMobile, requireSelection: requireSelection }) }), [componentId, customDate, dateDeformatter, dateFormat, dateFormatter, disableDatesAfter, disableDatesBefore, disableFutureDates, disablePastDates, id, isMobile, onCalendarChange, requireSelection, timeSelect, weekStartsOnSunday]);
    const memoizedDesktopView = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsx)(controlledPopup_1.ControlledPopup, { className: (0, classNames_1.classNames)(["zen-date-input-popup-wrapper", driveWrapperClassName || ""]), ariaLabel: translate("Pick a date"), useTrapFocusWithTrigger: "on", triggerRef: triggerRef, onOpenChange: setIsOpen, shouldHoldScroll: true, isOpen: isOpen, recalculateOnScroll: true, children: (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)(["zen-date-input-popup", drivePopupClassName || "", classNamePopup !== null && classNamePopup !== void 0 ? classNamePopup : ""]), children: [(0, jsx_runtime_1.jsx)("div", { className: "zen-date-input-popup__header", children: title }), component, (0, jsx_runtime_1.jsxs)("div", { className: "zen-date-input-popup__footer", children: [(0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-date-input-popup__button-clear", type: buttonType_1.ButtonType.Tertiary, disabled: isDefaultState, onClick: handleClearClick, children: translate("Clear") }), (0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-date-input-popup__button-apply", type: buttonType_1.ButtonType.Primary, disabled: isValueState || (requireSelection && !customDate), onClick: handleApplyClick, children: translate("Apply") })] })] }) }), [classNamePopup, component, customDate, drivePopupClassName, driveWrapperClassName, handleApplyClick, handleClearClick, isDefaultState, isOpen, isValueState, requireSelection, title, translate]);
    const memoizedMobileFooter = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsxs)(footerButtons_1.FooterButtons, { children: [(0, jsx_runtime_1.jsx)(button_1.Button, { type: buttonType_1.ButtonType.Primary, disabled: isValueState || (requireSelection && !customDate), onClick: handleApplyClick, children: translate("Apply") }), (0, jsx_runtime_1.jsx)(button_1.Button, { type: buttonType_1.ButtonType.Tertiary, disabled: isDefaultState, onClick: handleClearClick, children: translate("Clear") })] }), [customDate, handleApplyClick, handleClearClick, isDefaultState, isValueState, requireSelection, translate]);
    const memoizedMobileView = (0, react_1.useMemo)(() => (0, jsx_runtime_1.jsxs)(mobileSheet_1.MobileSheet, { className: (0, classNames_1.classNames)(["zen-date-input-mobile-sheet", classNamePopup ? `${classNamePopup}--mobile-sheet` : ""]), label: translate("Pick a date"), triggerRef: triggerRef, isOpen: isOpen, onHidePanel: memoizedHandleClose, onCloseClick: memoizedHandleClose, useTrapFocusWithTrigger: true, onReadyForFocus: onReadyForFocus, children: [(0, jsx_runtime_1.jsx)(mobileSheet_1.MobileSheet.Title, { children: title }), (0, jsx_runtime_1.jsx)(mobileSheet_1.MobileSheet.Content, { children: renderContent ? component : null }), (0, jsx_runtime_1.jsx)(mobileSheet_1.MobileSheet.Footer, { children: memoizedMobileFooter })] }), [classNamePopup, component, isOpen, memoizedHandleClose, memoizedMobileFooter, onReadyForFocus, renderContent, title, translate]);
    (0, react_1.useEffect)(() => {
        if (!isMobile && !isOpen && prevIsOpenRef.current) {
            setTimeout(() => {
                var _a;
                (_a = triggerRef.current) === null || _a === void 0 ? void 0 : _a.focus();
            }, 0);
        }
        prevIsOpenRef.current = isOpen;
    }, [isOpen, isMobile]);
    const buttonCurrentLabel = getButtonLabel();
    const buttonCurrentTitle = getButtonLabel(true);
    return (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(textIconButton_1.TextIconButton, { id: id || undefined, htmlType: "button", title: buttonCurrentTitle, icon: iconCalendar_1.IconCalendar, iconPosition: textIconButton_1.ButtonIconPosition.Start, className: cssClass, disabled: disabled, onClick: toggleVisibility, ref: triggerRef, children: buttonCurrentLabel }), isMobile ? memoizedMobileView : memoizedDesktopView, (0, jsx_runtime_1.jsx)(formFieldError_1.FormFieldError, { error: error })] });
};
exports.DateInput = DateInput;
exports.TRANSLATIONS = [
    "Pick a date",
    "Clear",
    "Apply",
    "Today"
];
