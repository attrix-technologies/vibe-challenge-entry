"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Nav = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const nav_context_1 = require("./context/nav.context");
const react_1 = require("react");
const generateId_1 = require("../commonHelpers/generateId");
const navDivider_1 = require("./navDivider/navDivider");
const navUtils_1 = require("./utils/navUtils");
const useResize_1 = require("../commonHelpers/hooks/useResize");
const react_dom_1 = require("react-dom");
const navMobileBar_1 = require("./navMobileBar/navMobileBar");
const useMobile_1 = require("../commonHelpers/hooks/useMobile");
const focusableSelector_1 = require("../utils/focusableSelector");
const NavContent = ({ children }) => {
    const contentRef = (0, react_1.useRef)(null);
    const [hasScrollbar, setHasScrollbar] = (0, react_1.useState)(false);
    const [showTopShadow, setShowTopShadow] = (0, react_1.useState)(false);
    const [showBottomShadow, setShowBottomShadow] = (0, react_1.useState)(false);
    const [hasOverlayScrollbar, setHasOverlayScrollbar] = (0, react_1.useState)(false);
    const handleScroll = (0, react_1.useCallback)(() => {
        if (!contentRef.current) {
            return;
        }
        const { scrollTop, scrollHeight, clientHeight } = contentRef.current;
        // Show top shadow if scrolled down
        setShowTopShadow(scrollTop > 0);
        // Show bottom shadow if not fully scrolled to bottom
        setShowBottomShadow(scrollTop + clientHeight < scrollHeight - 1);
        // Check if scrollbar is present
        setHasScrollbar(scrollHeight > clientHeight);
    }, [setShowTopShadow, setShowBottomShadow, setHasScrollbar]);
    const handleResize = (0, react_1.useCallback)(() => {
        setHasOverlayScrollbar((0, navUtils_1.detectOverlayScrollbar)());
        handleScroll();
    }, [setHasOverlayScrollbar, handleScroll]);
    (0, useResize_1.useResize)(() => {
        handleResize();
    }, true);
    (0, react_1.useEffect)(() => {
        // Initial check
        handleResize();
    }, [handleResize]);
    return (0, jsx_runtime_1.jsx)("div", { ref: contentRef, onScroll: handleScroll, className: (0, classNames_1.classNames)([
            "zen-nav__content",
            showTopShadow ? "zen-nav__content--show-top-shadow" : "",
            showBottomShadow ? "zen-nav__content--show-bottom-shadow" : "",
            hasScrollbar ? "zen-nav__content--has-scrollbar" : "",
            hasOverlayScrollbar ? "zen-nav__content--overlay-scrollbar" : ""
        ]), children: (0, jsx_runtime_1.jsx)("div", { className: "zen-nav__content-inner", children: children }) });
};
/**
 * @beta This component is not fully ready yet and may change in future releases.
 */
const Nav = ({ children, className, collapsed = false, onCollapseToggle, onMenuVisibilityToggle, mobileBarContainer }) => {
    const [isMobileMenuOpen, setIsMobileMenuOpen] = (0, react_1.useState)(false);
    const menuRef = (0, react_1.useRef)(null);
    const [isSearchOpen, setIsSearchOpen] = (0, react_1.useState)(false);
    const [searchTerm, setSearchTerm] = (0, react_1.useState)("");
    const isMobile = (0, useMobile_1.useMobile)();
    const prevIsMobileRef = (0, react_1.useRef)();
    // Focus the first active element inside the Nav when mobile menu opens
    (0, react_1.useLayoutEffect)(() => {
        var _a;
        if (isMobile && isMobileMenuOpen && menuRef.current) {
            const currentFocus = document.activeElement;
            // If focused element is not inside the nav, focus the first focusable element
            if (!currentFocus.closest(".zen-nav")) {
                (_a = menuRef.current.querySelector(focusableSelector_1.FOCUSABLE_SELECTOR)) === null || _a === void 0 ? void 0 : _a.focus();
            }
        }
    }, [isMobile, isMobileMenuOpen]);
    const childrenArray = react_1.Children.toArray(children);
    const header = childrenArray.find(child => { var _a; return ((_a = child.type) === null || _a === void 0 ? void 0 : _a.displayName) === "NavHeader"; });
    const sections = childrenArray.filter(child => { var _a; return ((_a = child.type) === null || _a === void 0 ? void 0 : _a.displayName) === "NavSection"; });
    const footer = childrenArray.find(child => { var _a; return ((_a = child.type) === null || _a === void 0 ? void 0 : _a.displayName) === "NavFooter"; });
    const secondarySections = sections.map(section => (0, navUtils_1.filterPrimaryNavItems)(section, true)).filter(section => !!section && react_1.Children.count(section.props.children) > 0);
    const primarySections = sections.map(section => (0, navUtils_1.filterPrimaryNavItems)(section, false)).filter(section => !!section && react_1.Children.count(section.props.children) > 0);
    const sectionsToRender = isMobile ? secondarySections : sections;
    const secondaryFooter = footer && (0, navUtils_1.filterPrimaryNavItems)(footer, true);
    const primaryFooter = footer && (0, navUtils_1.filterPrimaryNavItems)(footer, false);
    const footerToRender = isMobile ? secondaryFooter : footer;
    const primaryItems = [...primarySections, ...(primaryFooter ? [primaryFooter] : [])].flatMap(e => (0, navUtils_1.collectNavItems)(e));
    const onSearchOpen = (0, react_1.useCallback)((isOpen) => {
        isOpen && onCollapseToggle && onCollapseToggle(false);
        setIsSearchOpen(isOpen || isMobile);
    }, [onCollapseToggle, setIsSearchOpen, isMobile]);
    const onMobileMenuToggle = (0, react_1.useCallback)(() => {
        setIsMobileMenuOpen(!isMobileMenuOpen);
        onMenuVisibilityToggle === null || onMenuVisibilityToggle === void 0 ? void 0 : onMenuVisibilityToggle(!isMobileMenuOpen);
    }, [isMobileMenuOpen, setIsMobileMenuOpen, onMenuVisibilityToggle]);
    (0, react_1.useEffect)(() => {
        const wasMobile = prevIsMobileRef.current;
        prevIsMobileRef.current = isMobile;
        // Close mobile menu when switching to desktop
        if (wasMobile && !isMobile) {
            setIsMobileMenuOpen(false);
        }
        // Close search input when collapsed
        if (collapsed) {
            setIsSearchOpen(false);
            return;
        }
        // If menu is expanded open search if there is a search term
        if (searchTerm.trim() !== "") {
            setIsSearchOpen(true);
            return;
        }
        // Always show search input on mobile
        if (isMobile) {
            setIsSearchOpen(true);
            return;
        }
        // When switching from mobile to desktop, close search if term is empty
        if (wasMobile && !searchTerm.trim()) {
            setIsSearchOpen(false);
        }
    }, [collapsed, setIsSearchOpen, setIsMobileMenuOpen, searchTerm, isMobile]);
    return (0, jsx_runtime_1.jsxs)(nav_context_1.NavContext.Provider, { value: { collapsed, onCollapseToggle, searchOpen: isSearchOpen, onSearchToggle: onSearchOpen, searchTerm, onSearch: setSearchTerm }, children: [(!isMobile || isMobileMenuOpen)
                ? (0, jsx_runtime_1.jsxs)("div", { ref: menuRef, className: (0, classNames_1.classNames)(["zen-nav", isMobile ? "zen-nav--mobile" : "", collapsed ? "zen-nav--collapsed" : "", className || ""]), children: [header ? (0, react_1.cloneElement)(header, Object.assign(Object.assign({}, header.props), { className: (0, classNames_1.classNames)(["zen-nav__header", header.props.className || ""]) })) : null, (0, jsx_runtime_1.jsx)(NavContent, { children: sectionsToRender.map((section, index) => {
                                const sectionKey = (0, generateId_1.generateId)();
                                return ((0, jsx_runtime_1.jsxs)(react_1.Fragment, { children: [(0, react_1.cloneElement)(section, {
                                            className: (0, classNames_1.classNames)(["zen-nav__section", section.props.className || ""])
                                        }), isMobile || index < sectionsToRender.length - 1 ? (0, jsx_runtime_1.jsx)(navDivider_1.NavDivider, {}) : null] }, sectionKey));
                            }) }), footerToRender] })
                : null, mobileBarContainer && isMobile && (0, react_dom_1.createPortal)((0, jsx_runtime_1.jsx)(navMobileBar_1.NavMobileBar, { onMenuToggle: onMobileMenuToggle, isMenuOpen: isMobileMenuOpen, children: primaryItems }), mobileBarContainer)] });
};
exports.Nav = Nav;
