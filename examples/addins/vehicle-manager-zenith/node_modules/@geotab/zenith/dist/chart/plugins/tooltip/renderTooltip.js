"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.destroyTooltip = exports.hideTooltip = exports.renderTooltip = void 0;
const escapeHtml_1 = require("../../../utils/escapeHtml");
const calculatePositions_1 = require("./calculatePositions");
const isOutOfViewport_1 = require("./isOutOfViewport");
const getOrCreateTooltip = (id, isDark) => {
    let tooltipEl = document.body.querySelector(`#${id}`);
    if (!tooltipEl) {
        tooltipEl = document.createElement("div");
        tooltipEl.id = id;
        tooltipEl.className = "zen-chart-tooltip";
        tooltipEl.setAttribute("role", "tooltip");
        tooltipEl.setAttribute("aria-hidden", "true");
        document.body.appendChild(tooltipEl);
    }
    tooltipEl.classList.toggle("zen-dark", isDark);
    return tooltipEl;
};
const renderTooltip = (tooltipId, x, y, position, items, title, subtitle, note, isDark) => {
    const element = getOrCreateTooltip(tooltipId, isDark);
    element.style.display = "block";
    const titleHtml = title ? `<div class="zen-chart-tooltip__header">${(0, escapeHtml_1.htmlEscape)(title)}</div>` : "";
    const subtitleHtml = subtitle ? `<div class="zen-chart-tooltip__subheader">${(0, escapeHtml_1.htmlEscape)(subtitle)}</div>` : "";
    const noteHtml = note ? `<div class="zen-chart-tooltip__note">${(0, escapeHtml_1.htmlEscape)(note)}</div>` : "";
    const itemsList = items.map((item) => `<div class="zen-chart-tooltip__item">
            <div class="zen-chart-tooltip__color" style="background-color: ${item.color}"></div>
            <div class="zen-chart-tooltip__label">${(0, escapeHtml_1.htmlEscape)(item.label)}</div>
            ${item.value !== undefined ? `<div class="zen-chart-tooltip__value">${(0, escapeHtml_1.htmlEscape)(item.value)}</div>` : ""}
        </div>`);
    const itemsHtml = `<div class="zen-chart-tooltip__items">${itemsList.join("")}</div>`;
    element.innerHTML = `${titleHtml}${subtitleHtml}${itemsHtml}${noteHtml}`;
    const arrow = document.createElement("div");
    arrow.className = "zen-chart-tooltip__arrow";
    element.appendChild(arrow);
    const tooltipRect = element.getBoundingClientRect();
    const positionsOrder = [position, ...calculatePositions_1.positionOrder[position]];
    const bodyRect = document.body.getBoundingClientRect();
    let finalPosition = undefined;
    for (let i = 0; i < positionsOrder.length; i++) {
        const pos = positionsOrder[i];
        const calcPosition = calculatePositions_1.calculatePositions[pos];
        const { left, top } = calcPosition.calculate(x, y, tooltipRect);
        if (!(0, isOutOfViewport_1.isOutOfViewport)(left, top, tooltipRect, bodyRect)) {
            finalPosition = { left, top, className: calcPosition.className };
            break;
        }
    }
    if (!finalPosition) {
        const calcPosition = calculatePositions_1.calculatePositions[position];
        const { left, top } = calcPosition.calculate(x, y, tooltipRect);
        finalPosition = { left, top, className: calcPosition.className };
    }
    const arrowPosition = finalPosition.className;
    const arrowElement = element.querySelector(".zen-chart-tooltip__arrow");
    if (arrowElement) {
        arrowElement.classList.remove("zen-chart-tooltip__arrow--top", "zen-chart-tooltip__arrow--right", "zen-chart-tooltip__arrow--bottom", "zen-chart-tooltip__arrow--left");
        arrowElement.classList.add(arrowPosition);
    }
    element.style.left = finalPosition.left + "px";
    element.style.top = finalPosition.top + "px";
    element.style.opacity = "1";
};
exports.renderTooltip = renderTooltip;
const hideTooltip = (tooltipId) => {
    const element = document.body.querySelector(`#${tooltipId}`);
    if (element) {
        element.style.display = "none";
    }
};
exports.hideTooltip = hideTooltip;
const destroyTooltip = (tooltipId) => {
    const element = document.body.querySelector(`#${tooltipId}`);
    if (element) {
        document.body.removeChild(element);
    }
};
exports.destroyTooltip = destroyTooltip;
