"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.BarChart = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const typedCharts_1 = require("../react-chartjs/typedCharts");
const auto_1 = require("chart.js/auto");
require("../react-chartjs/dateAdapter");
const utils_1 = require("../commonHelpers/utils");
const useDrive_1 = require("../utils/theme/useDrive");
const useMobile_1 = require("../commonHelpers/hooks/useMobile");
const themeContext_1 = require("../utils/theme/themeContext");
const generateId_1 = require("../commonHelpers/generateId");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const legendPlugin_1 = require("./plugins/legend/legendPlugin");
const chartAxis_1 = require("./chartAxis/chartAxis");
const useLanguage_1 = require("../utils/localization/useLanguage");
const isDateRange_1 = require("./utils/isDateRange");
const getYAxisMeta_1 = require("./utils/getYAxisMeta");
const getDefaultOptions_1 = require("./barChart/getDefaultOptions");
const convertDates_1 = require("./utils/convertDates");
const useAxisLabels_1 = require("./lineChart/useAxisLabels");
const useSummary_1 = require("./lineChart/useSummary");
const getDefaultDatasetStyle_1 = require("./barChart/getDefaultDatasetStyle");
const useHidden_1 = require("./utils/useHidden");
const tooltipPlugin_1 = require("./plugins/tooltip/tooltipPlugin");
const chartInsight_1 = require("./chartInsight/chartInsight");
const userFormatContext_1 = require("../utils/userFormat/userFormatContext");
const summary_1 = require("../summary/summary");
const accessibleChart_1 = require("./accessibleChart/accessibleChart");
auto_1.Chart.register(auto_1.BarController, auto_1.BarElement, auto_1.CategoryScale, auto_1.LinearScale);
const BarChart = (_a) => {
    var { data, options = {}, axis, insight, summary, legend, tooltip, plugins, className } = _a, rest = __rest(_a, ["data", "options", "axis", "insight", "summary", "legend", "tooltip", "plugins", "className"]);
    const { translate } = (0, useLanguage_1.useLanguage)();
    const isDrive = (0, useDrive_1.useDrive)();
    const isMobile = (0, useMobile_1.useMobile)();
    const fontSize = (0, react_1.useMemo)(() => isDrive ? (isMobile ? 14 : 16) : 12, [isDrive, isMobile]);
    const { dark } = (0, react_1.useContext)(themeContext_1.themeContext);
    (0, react_1.useEffect)(() => {
        auto_1.Chart.defaults.font = {
            family: "Roboto",
            size: fontSize
        };
        auto_1.Chart.defaults.color = dark ? "#FFFFFF" : "#1F2833";
    }, [fontSize, dark]);
    const legendId = (0, react_1.useMemo)(() => (0, generateId_1.generateId)(), []);
    const tooltipId = (0, react_1.useMemo)(() => (0, generateId_1.generateId)(), []);
    const { toLocalDateTime } = (0, react_1.useContext)(userFormatContext_1.userFormatContext);
    const isTimedData = (0, react_1.useMemo)(() => (0, isDateRange_1.isDateRange)(data, false), [data]);
    const yAxisMeta = (0, react_1.useMemo)(() => (0, getYAxisMeta_1.getYAxisMeta)(data), [data]);
    const defOptions = (0, react_1.useMemo)(() => (0, getDefaultOptions_1.getDefaultOptions)(yAxisMeta, isTimedData, dark, translate), [yAxisMeta, isTimedData, dark, translate]);
    const chartOptions = (0, utils_1.deepMerge)(defOptions, options);
    const { isHidden, toggleHidden } = (0, useHidden_1.useHidden)();
    const chartData = (0, react_1.useMemo)(() => {
        const chData = (0, convertDates_1.convertDates)(data, toLocalDateTime);
        chData.datasets = chData.datasets.map((ds, i) => (0, getDefaultDatasetStyle_1.getDefaultDatasetStyle)(ds, i));
        chData.datasets = chData.datasets.map((ds, i) => (Object.assign(Object.assign({}, ds), { hidden: isHidden(i) })));
        return chData;
    }, [data, isHidden, toLocalDateTime]);
    // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-arguments
    const chartTooltip = (0, react_1.useMemo)(() => (0, tooltipPlugin_1.TooltipPlugin)(tooltipId, tooltip, "top", isHidden, dark), [tooltipId, tooltip, isHidden, dark]);
    const chartLegend = (0, react_1.useMemo)(() => (0, legendPlugin_1.legendPlugin)(legendId, legend, isDrive, isHidden, toggleHidden), [isDrive, isHidden, legend, legendId, toggleHidden]);
    const chartPlugins = (0, react_1.useMemo)(() => [...(plugins || []), chartTooltip, chartLegend], [chartLegend, chartTooltip, plugins]);
    const { xLabels, yLabels } = (0, useAxisLabels_1.useAxisLabels)(axis, chartOptions);
    const intSummary = (0, useSummary_1.useSummary)(summary, chartData);
    const isMainHidden = (0, react_1.useMemo)(() => isHidden(0), [isHidden]);
    const toggleMainData = (0, react_1.useCallback)(() => toggleHidden(0), [toggleHidden]);
    return (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)(["zen-chart", className || ""]), children: [insight
                ? (0, jsx_runtime_1.jsx)(chartInsight_1.ChartInsight, Object.assign({}, insight))
                : null, summary
                ? (0, jsx_runtime_1.jsx)(summary_1.Summary, Object.assign({ onToggle: toggleMainData, isEnabled: isMainHidden }, intSummary))
                : null, xLabels || yLabels.length > 0
                ? (0, jsx_runtime_1.jsx)(chartAxis_1.ChartAxis, { xLabel: xLabels, yLabels: yLabels })
                : null, (0, jsx_runtime_1.jsx)("div", { className: "zen-chart__chart", children: (0, jsx_runtime_1.jsx)(typedCharts_1.Bar, Object.assign({ options: chartOptions, data: chartData, plugins: chartPlugins }, rest, { "aria-hidden": true })) }), (0, jsx_runtime_1.jsx)("div", { className: "zen-chart__legend", id: legendId }), (0, jsx_runtime_1.jsx)(accessibleChart_1.AccessibleChart, { type: "bar", data: chartData, options: chartOptions })] });
};
exports.BarChart = BarChart;
