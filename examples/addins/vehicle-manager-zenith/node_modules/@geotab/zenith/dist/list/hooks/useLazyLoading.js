"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useLazyLoading = void 0;
const react_1 = require("react");
const getScrollableParent_1 = require("../../utils/getScrollableParent");
const useLazyLoading = (ref, isLoading, onListEnd) => {
    const [scrollableParent, setScrollableParent] = (0, react_1.useState)(null);
    const observerRef = (0, react_1.useRef)(null);
    const updateScrollableParent = (0, react_1.useCallback)(() => {
        const parent = (0, getScrollableParent_1.getScrollableParent)(ref.current);
        setScrollableParent(parent || null);
        return parent;
    }, [ref]);
    (0, react_1.useEffect)(() => {
        var _a;
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        if (!observerRef.current && ResizeObserver) {
            observerRef.current = new ResizeObserver(updateScrollableParent);
        }
        const parent = updateScrollableParent();
        if (parent) {
            (_a = observerRef.current) === null || _a === void 0 ? void 0 : _a.observe(parent);
        }
        return () => {
            var _a;
            if (parent) {
                (_a = observerRef.current) === null || _a === void 0 ? void 0 : _a.unobserve(parent);
            }
        };
    }, [ref, updateScrollableParent]);
    (0, react_1.useEffect)(() => {
        if (!onListEnd) {
            return () => { };
        }
        if (!scrollableParent) {
            return () => { };
        }
        const handleScroll = () => {
            const scrollTop = scrollableParent.scrollTop;
            const scrollHeight = scrollableParent.scrollHeight;
            const clientHeight = scrollableParent.clientHeight;
            if (scrollTop + clientHeight >= scrollHeight - 50 && !isLoading) {
                onListEnd();
            }
        };
        scrollableParent.addEventListener("scroll", handleScroll);
        return () => {
            scrollableParent.removeEventListener("scroll", handleScroll);
        };
    }, [scrollableParent, onListEnd, isLoading]);
};
exports.useLazyLoading = useLazyLoading;
