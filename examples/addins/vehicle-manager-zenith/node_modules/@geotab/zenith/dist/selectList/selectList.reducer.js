"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.selectListReducer = void 0;
const checkboxState_1 = require("../checkbox/checkboxState");
const selectList_actionTypes_1 = require("./selectList.actionTypes");
const selectList_helpers_1 = require("./selectList.helpers");
const selectItem = (state, itemIndex, multiselect) => {
    const itemId = (0, selectList_helpers_1.getItemIdByIndex)(state.itemsState, itemIndex);
    if (!itemId) {
        return Object.assign({}, state);
    }
    const [itemsState, isUpdated] = (0, selectList_helpers_1.updateItemState)(state.itemsState, multiselect, itemId, checkboxState_1.CheckboxState.On);
    return Object.assign(Object.assign({}, state), { activeIndex: itemIndex, itemsState, isItemsStateChanged: isUpdated, searchStr: "" });
};
const toggleItems = (items, state, activeIndex, direction, multiselect, newState) => {
    if (!multiselect) {
        return Object.assign({}, state);
    }
    let newItemsState = new Map(state.itemsState);
    let isUpdated = false;
    const startIndex = direction === selectList_actionTypes_1.SelectDirection.Up ? 0 : activeIndex;
    const endIndex = direction === selectList_actionTypes_1.SelectDirection.Up ? activeIndex + 1 : items.length;
    const itemsSlice = items.slice(startIndex, endIndex);
    itemsSlice.forEach(item => {
        if (!item.disabled) {
            const itemState = newItemsState.get(item.id);
            const newItemState = newState || (itemState === checkboxState_1.CheckboxState.On ? checkboxState_1.CheckboxState.Off : checkboxState_1.CheckboxState.On); // Toggle state if newState is not defined
            const [updatedState, isItemUpdated] = (0, selectList_helpers_1.updateItemState)(newItemsState, multiselect, item.id, newItemState);
            newItemsState = updatedState;
            isUpdated = isUpdated || isItemUpdated;
        }
    });
    return Object.assign(Object.assign({}, state), { activeIndex, itemsState: newItemsState, isItemsStateChanged: isUpdated, searchStr: "" });
};
// eslint-disable-next-line complexity
const selectListReducer = (state, action) => {
    const { type, payload } = action;
    switch (type) {
        case selectList_actionTypes_1.ListAction.ChangeItemState: {
            const [newState, isUpdated] = (0, selectList_helpers_1.updateItemState)(state.itemsState, payload.multiselect, payload.updatedId, payload.updatedState);
            return Object.assign(Object.assign({}, state), { itemsState: newState, isItemsStateChanged: isUpdated, activeIndex: (0, selectList_helpers_1.getItemIndexById)(newState, payload.updatedId), searchStr: "" });
        }
        case selectList_actionTypes_1.ListAction.ToggleCurrent: {
            const currentItemId = (0, selectList_helpers_1.getItemIdByIndex)(state.itemsState, state.activeIndex);
            const currentState = currentItemId && state.itemsState.get(currentItemId) || checkboxState_1.CheckboxState.Off;
            const [newItemsState, isUpdated] = currentItemId
                ? (0, selectList_helpers_1.updateItemState)(state.itemsState, payload.multiselect, currentItemId, currentState === checkboxState_1.CheckboxState.On ? checkboxState_1.CheckboxState.Off : checkboxState_1.CheckboxState.On)
                : [state.itemsState, false];
            return Object.assign(Object.assign({}, state), { itemsState: newItemsState, isItemsStateChanged: isUpdated, searchStr: "" });
        }
        case selectList_actionTypes_1.ListAction.FocusFirst: return Object.assign(Object.assign({}, state), { activeIndex: (0, selectList_helpers_1.getFirstIndex)(payload.items), isItemsStateChanged: false, searchStr: "" });
        case selectList_actionTypes_1.ListAction.FocusLast: return Object.assign(Object.assign({}, state), { activeIndex: (0, selectList_helpers_1.getLastIndex)(payload.items), isItemsStateChanged: false, searchStr: "" });
        case selectList_actionTypes_1.ListAction.FocusNext: return Object.assign(Object.assign({}, state), { activeIndex: (0, selectList_helpers_1.getNextIndex)(state.activeIndex, payload.items), isItemsStateChanged: false, searchStr: "" });
        case selectList_actionTypes_1.ListAction.FocusPrev: return Object.assign(Object.assign({}, state), { activeIndex: (0, selectList_helpers_1.getPrevIndex)(state.activeIndex, payload.items), isItemsStateChanged: false, searchStr: "" });
        case selectList_actionTypes_1.ListAction.SelectFirst: return selectItem(state, (0, selectList_helpers_1.getFirstIndex)(payload.items), payload.multiselect);
        case selectList_actionTypes_1.ListAction.SelectLast: return selectItem(state, (0, selectList_helpers_1.getLastIndex)(payload.items), payload.multiselect);
        case selectList_actionTypes_1.ListAction.SelectNext: return selectItem(state, (0, selectList_helpers_1.getNextIndex)(state.activeIndex, payload.items), payload.multiselect);
        case selectList_actionTypes_1.ListAction.SelectPrev: return selectItem(state, (0, selectList_helpers_1.getPrevIndex)(state.activeIndex, payload.items), payload.multiselect);
        case selectList_actionTypes_1.ListAction.SelectAllToTheBeginning: return toggleItems(payload.items, state, state.activeIndex, selectList_actionTypes_1.SelectDirection.Up, payload.multiselect, checkboxState_1.CheckboxState.On);
        case selectList_actionTypes_1.ListAction.SelectAllToTheEnd: return toggleItems(payload.items, state, state.activeIndex, selectList_actionTypes_1.SelectDirection.Down, payload.multiselect, checkboxState_1.CheckboxState.On);
        case selectList_actionTypes_1.ListAction.ToggleAll: return toggleItems(payload.items, state, 0, selectList_actionTypes_1.SelectDirection.Down, payload.multiselect);
        case selectList_actionTypes_1.ListAction.SearchItem: {
            const isSymbol = payload.key.length === 1;
            const isBackSpace = payload.key === "Backspace";
            let searchStr = state.searchStr;
            if (isSymbol) {
                searchStr += payload.key;
            }
            if (isBackSpace) {
                searchStr = searchStr.slice(0, -1);
            }
            return Object.assign(Object.assign({}, state), { activeIndex: state.searchStr !== searchStr ? (0, selectList_helpers_1.searchItemIndex)(payload.items, searchStr) : state.activeIndex, isItemsStateChanged: false, searchStr });
        }
        case selectList_actionTypes_1.ListAction.Blur: {
            return Object.assign(Object.assign({}, state), { isItemsStateChanged: false, searchStr: "", activeIndex: -1 });
        }
        case selectList_actionTypes_1.ListAction.Focus: {
            return Object.assign(Object.assign({}, state), { isItemsStateChanged: false, activeIndex: state.activeIndex > -1 ? state.activeIndex : (0, selectList_helpers_1.getFirstActiveIndex)(state.itemsState, payload.items, payload.multiselect) });
        }
        case selectList_actionTypes_1.ListAction.FocusPrevPage: {
            const prevPage = state.activeIndex - payload.pageSize;
            const prevIndex = prevPage > -1 ? prevPage : 0;
            return Object.assign(Object.assign({}, state), { isItemsStateChanged: false, activeIndex: (0, selectList_helpers_1.getPrevIndex)(prevIndex + 1, payload.items), searchStr: "" });
        }
        case selectList_actionTypes_1.ListAction.FocusNextPage: {
            const nextPage = state.activeIndex + payload.pageSize;
            const nextIndex = nextPage < payload.items.length ? nextPage : payload.items.length - 1;
            return Object.assign(Object.assign({}, state), { isItemsStateChanged: false, activeIndex: (0, selectList_helpers_1.getNextIndex)(nextIndex - 1, payload.items), searchStr: "" });
        }
        case selectList_actionTypes_1.ListAction.Reset: {
            const newState = payload.value;
            const filteredMergedState = [...payload.value, ...state.itemsState].filter(([key]) => payload.items.find(item => item.id === key));
            let newItemsState = new Map(filteredMergedState);
            payload.items.forEach(item => {
                const newItemState = newState.get(item.id) || checkboxState_1.CheckboxState.Off;
                const [updatedState] = (0, selectList_helpers_1.updateItemState)(newItemsState, payload.multiselect, item.id, newItemState);
                newItemsState = updatedState;
            });
            const prevActiveItemId = (0, selectList_helpers_1.getItemIdByIndex)(state.itemsState, state.activeIndex);
            const newActiveItemIndex = !!prevActiveItemId && (0, selectList_helpers_1.getItemIndexById)(newItemsState, prevActiveItemId);
            const activeIndex = newActiveItemIndex ? newActiveItemIndex : -1;
            return Object.assign(Object.assign({}, state), { itemsState: newItemsState, activeIndex, isItemsStateChanged: false });
        }
        case selectList_actionTypes_1.ListAction.SetLevel: {
            const item = payload ? payload.items[state.activeIndex] : undefined;
            const newLevel = item && item.multiLevel ? item.id : "";
            return Object.assign(Object.assign({}, state), { level: newLevel });
        }
        default: throw new Error("Unknown action");
    }
};
exports.selectListReducer = selectListReducer;
