"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DropdownOld = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const filterButton_1 = require("../filterButton/filterButton");
const selectList_1 = require("../selectList/selectList");
const checkboxState_1 = require("../checkbox/checkboxState");
const controlledPopup_1 = require("../controlledPopup/controlledPopup");
const select_helpers_1 = require("../selectRaw/select.helpers");
const isDropdownStateTheSame_1 = require("./dropdownOldHelpers/isDropdownStateTheSame");
const useUniqueId_1 = require("../commonHelpers/useUniqueId");
// get default active item (based on items array)
const getItemById = (items, id) => items.find(item => item.id === id);
const DropdownOld = (props) => {
    var _a;
    const { fullWidth, footer, multiselect, disabled, placeholder, title, id, className, selectedOption, items: outerItems, onChange } = props;
    const [isOpen, setIsOpen] = (0, react_1.useState)(false);
    const innerTriggerRef = (0, react_1.useRef)(null);
    // items IDs
    const buttonReactId = (0, useUniqueId_1.useUniqueId)();
    const selectListId = (0, useUniqueId_1.useUniqueId)();
    const popupId = (0, useUniqueId_1.useUniqueId)();
    // memoized items
    const items = (0, react_1.useMemo)(() => outerItems, [outerItems]);
    const itemsMap = (0, react_1.useMemo)(() => items.reduce((acc, obj) => acc.set(obj.id, selectedOption.includes(obj.id) ? checkboxState_1.CheckboxState.On : checkboxState_1.CheckboxState.Off), new Map()), [items, selectedOption]);
    // trigger button text value
    const value = (0, select_helpers_1.getSelectValue)(itemsMap, items);
    const triggerValue = value ? (_a = getItemById(items, value)) === null || _a === void 0 ? void 0 : _a.children : placeholder;
    const onOptionsToggle = (isCurrentlyOpen) => {
        setIsOpen(isCurrentlyOpen);
    };
    const onOptionChange = (0, react_1.useCallback)((newItemState) => {
        const newSelection = [...newItemState].reduce((res, [selectedId, checkedState]) => {
            if (checkedState === checkboxState_1.CheckboxState.On) {
                res.push(selectedId);
            }
            return res;
        }, []);
        if (!(0, isDropdownStateTheSame_1.isDropdownStateTheSame)(newSelection, selectedOption)) {
            onChange(newSelection);
        }
    }, [onChange, selectedOption]);
    return (0, jsx_runtime_1.jsxs)(react_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(filterButton_1.FilterButton, { ref: innerTriggerRef, id: id || buttonReactId, className: className, onClick: () => {
                    setIsOpen(!isOpen);
                }, disabled: disabled, isActive: isOpen, fullWidth: fullWidth, quantity: multiselect && selectedOption.length > 0 ? selectedOption.length : undefined, children: triggerValue }), (0, jsx_runtime_1.jsx)(controlledPopup_1.ControlledPopup, { id: popupId, useTrapFocusWithTrigger: "withTrigger", alignment: "bottom-left", onOpenChange: (isCurrentlyOpen) => {
                    onOptionsToggle(isCurrentlyOpen);
                }, isOpen: isOpen, triggerRef: innerTriggerRef, children: (0, jsx_runtime_1.jsxs)("div", { className: "zen-dropdown-old", children: [title ? (0, jsx_runtime_1.jsx)("div", { className: "zen-dropdown-old__header", children: title }) : null, (0, jsx_runtime_1.jsx)(selectList_1.SelectList, { id: selectListId, title: title, showCheckbox: multiselect, value: itemsMap, multiselect: multiselect, items: [
                                ...items.reduce((acc, obj) => acc.set(obj.id, Object.assign(Object.assign({}, obj), { state: selectedOption.includes(obj.id) ? checkboxState_1.CheckboxState.On : checkboxState_1.CheckboxState.Off })), new Map()).values()
                            ], onChange: onOptionChange }), footer
                            ? (0, jsx_runtime_1.jsx)("div", { className: "zen-dropdown-old__footer", children: footer })
                            : null] }) })] });
};
exports.DropdownOld = DropdownOld;
