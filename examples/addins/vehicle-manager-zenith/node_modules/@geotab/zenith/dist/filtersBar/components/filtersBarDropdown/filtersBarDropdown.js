"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSLATIONS = exports.FiltersBarDropdown = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const sidePanelCell_1 = require("../../../sidePanel/sidePanelCell/sidePanelCell");
const dropdown_1 = require("../../../dropdown/dropdown");
const filtersBarSidePanelRadioGroup_1 = require("../../filtersBarSidePanel/components/filtersBarSidePanelRadioGroup/filtersBarSidePanelRadioGroup");
const filtersBarSidePanelCheckboxGroup_1 = require("../../filtersBarSidePanel/components/filtersBarSidePanelCheckboxGroup/filtersBarSidePanelCheckboxGroup");
const useUniqueId_1 = require("../../../commonHelpers/useUniqueId");
const pillBox_1 = require("../../../pillBox/pillBox");
const classNames_1 = require("../../../commonHelpers/classNames/classNames");
const groupsHelper_1 = require("../../../groupsFilter/groupsHelper");
const useLanguage_1 = require("../../../utils/localization/useLanguage");
const dropdownHelper_1 = require("../../../dropdown/dropdownHelper");
const focusableSelector_1 = require("../../../utils/focusableSelector");
// eslint-disable-next-line complexity
const FiltersBarDropdown = ({ sidePanelTitle, className, props, state, useSidePanelView, sidePanelMaxGroupedItemsLength = 5, onChange }) => {
    const { translate } = (0, useLanguage_1.useLanguage)();
    const isFullSelectionMode = (0, react_1.useMemo)(() => "isAllSelected" in state && typeof (state).isAllSelected === "boolean", [state]);
    const selection = (0, react_1.useMemo)(() => new Set(isFullSelectionMode ? state.selected
        : state.selectedOption), [isFullSelectionMode, state]);
    const isCurrentAllSelected = (0, react_1.useMemo)(() => isFullSelectionMode ? state.isAllSelected : undefined, [isFullSelectionMode, state]);
    const [_, setNamedFnReady] = (0, react_1.useState)(false);
    const namedItemsFnRef = (0, react_1.useRef)(items => items.map(el => ({ id: el, name: "..." })));
    const dropdownId = (0, useUniqueId_1.useUniqueId)();
    const checkBoxLabelledId = (0, useUniqueId_1.useUniqueId)();
    const radioGroupLabelledId = (0, useUniqueId_1.useUniqueId)();
    const dropdownLabelledId = (0, useUniqueId_1.useUniqueId)();
    const sidePanelCellRef = (0, react_1.useRef)(null);
    const sortedItems = (0, react_1.useMemo)(() => (0, dropdownHelper_1.sortDropdownItemArray)(props.dataItems || [], props.sortFn), [props.sortFn, props.dataItems]);
    const handleFocusOnRemove = (0, react_1.useCallback)((newSelectedFirstItem) => {
        var _a, _b, _c;
        if (newSelectedFirstItem) {
            const pillBoxElement = (_a = sidePanelCellRef.current) === null || _a === void 0 ? void 0 : _a.querySelector(`.zen-filters-bar-dropdown__pill-box .zen-pill-box__pill[data-id="${newSelectedFirstItem}"]`);
            const focusable = pillBoxElement ?
                [...Array.from(pillBoxElement.querySelectorAll(focusableSelector_1.FOCUSABLE_SELECTOR))] : undefined;
            (_b = focusable === null || focusable === void 0 ? void 0 : focusable[0]) === null || _b === void 0 ? void 0 : _b.focus();
        }
        else {
            const focusable = sidePanelCellRef.current ? [...Array.from(sidePanelCellRef.current.querySelectorAll(focusableSelector_1.FOCUSABLE_SELECTOR))] : undefined;
            (_c = focusable === null || focusable === void 0 ? void 0 : focusable[0]) === null || _c === void 0 ? void 0 : _c.focus();
        }
    }, []);
    const handleRemove = (0, react_1.useCallback)((removedId) => {
        if (isFullSelectionMode) {
            const isAllSelected = state.isAllSelected;
            if (isAllSelected) {
                const newSelected = sortedItems.map(el => el.id).filter(el => el !== removedId);
                onChange({ selected: newSelected, isAllSelected: false });
                handleFocusOnRemove(newSelected[0]);
                return;
            }
            const newSelected = Array.from(selection).filter(el => el !== removedId);
            onChange({ selected: newSelected, isAllSelected: false });
            handleFocusOnRemove(newSelected[0]);
        }
        else {
            const newSelected = Array.from(selection).filter(el => el !== removedId);
            onChange({ selectedOption: newSelected });
            handleFocusOnRemove(newSelected[0]);
        }
    }, [handleFocusOnRemove, isFullSelectionMode, onChange, selection, sortedItems, state]);
    const componentWidth = (0, react_1.useMemo)(() => useSidePanelView ? undefined : props.width, [useSidePanelView, props.width]);
    const component = isFullSelectionMode ? (0, jsx_runtime_1.jsx)(dropdown_1.Dropdown, Object.assign({}, props, { width: componentWidth, inputId: props.inputId && useSidePanelView ? `${props.inputId}-side-panel` : props.inputId, className: (0, classNames_1.classNames)([className || "", useSidePanelView ? "zen-filters-bar-dropdown--side-panel" : "", !useSidePanelView && !props.width ? "zen-filters-bar-dropdown--toolbar" : ""]), classNamePopup: (0, classNames_1.classNames)(["zen-filters-bar-dropdown-popup", props.classNamePopup || ""]), value: { selected: Array.from(selection), isAllSelected: isCurrentAllSelected || false }, onChange: (newValue) => {
            onChange({ selected: newValue.selected.map(el => el.id), isAllSelected: newValue.isAllSelected || false });
        }, fullWidthTriggerButton: useSidePanelView ? true : props.fullWidthTriggerButton, error: undefined, hasApplyButton: useSidePanelView ? false : props.hasApplyButton, getNamedItems: useSidePanelView ? (fn) => {
            namedItemsFnRef.current = fn;
            setNamedFnReady(val => !val);
        } : undefined, defaultValue: props.defaultValue, multiselect: true, selectAllButton: true })) : (0, jsx_runtime_1.jsx)(dropdown_1.Dropdown, Object.assign({}, props, { width: componentWidth, inputId: props.inputId && useSidePanelView ? `${props.inputId}-side-panel` : props.inputId, className: (0, classNames_1.classNames)([className || "", useSidePanelView ? "zen-filters-bar-dropdown--side-panel" : "", !useSidePanelView && !props.width ? "zen-filters-bar-dropdown--toolbar" : ""]), classNamePopup: (0, classNames_1.classNames)(["zen-filters-bar-dropdown-popup", props.classNamePopup || ""]), value: Array.from(selection), fullWidthTriggerButton: useSidePanelView ? true : props.fullWidthTriggerButton, onChange: (newValue) => {
            onChange({ selectedOption: newValue.map(el => el.id) });
        }, error: undefined, hasApplyButton: useSidePanelView ? false : props.hasApplyButton, getNamedItems: useSidePanelView ? (fn) => {
            namedItemsFnRef.current = fn;
            setNamedFnReady(val => !val);
        } : undefined, defaultValue: props.defaultValue }));
    if (!useSidePanelView) {
        return component;
    }
    if (!isFullSelectionMode && props.multiselect === false && props.dataItems && props.dataItems.length < sidePanelMaxGroupedItemsLength) {
        return (0, jsx_runtime_1.jsx)(sidePanelCell_1.SidePanelCell, { title: sidePanelTitle, role: "group", labelledBy: radioGroupLabelledId, titleId: radioGroupLabelledId, children: (0, jsx_runtime_1.jsx)(filtersBarSidePanelRadioGroup_1.FiltersBarSidePanelRadioGroup, Object.assign({}, props, { direction: "vertical", items: sortedItems.map((item) => ({
                    id: `${dropdownId}_${item.id}`,
                    value: item.id,
                    children: (0, jsx_runtime_1.jsx)("span", { className: "strecthed", children: (0, groupsHelper_1.getGroupDescription)(item, translate) })
                })), onChange: (e) => {
                    onChange({ selectedOption: [e.target.value] });
                }, value: state.selectedOption[0] || "" })) });
    }
    if (props.dataItems && props.dataItems.length < sidePanelMaxGroupedItemsLength) {
        return (0, jsx_runtime_1.jsx)(sidePanelCell_1.SidePanelCell, { title: sidePanelTitle, role: "group", labelledBy: checkBoxLabelledId, titleId: checkBoxLabelledId, children: (0, jsx_runtime_1.jsx)(filtersBarSidePanelCheckboxGroup_1.FiltersBarSidePanelCheckboxGroup, Object.assign({}, props, { items: sortedItems.map((item) => ({
                    id: `${dropdownId}_${item.id}`,
                    value: item.id,
                    disabled: item.disabled,
                    children: (0, jsx_runtime_1.jsx)("span", { className: "strecthed", children: (0, groupsHelper_1.getGroupDescription)(item, translate) })
                })), onChange: selectedItems => {
                    if (isFullSelectionMode) {
                        onChange({ selected: selectedItems, isAllSelected: selectedItems.length === sortedItems.length });
                    }
                    else {
                        onChange({ selectedOption: selectedItems });
                    }
                }, selectedItems: isFullSelectionMode ? (state.isAllSelected ? sortedItems.map(el => el.id)
                    : state.selected) : state.selectedOption })) });
    }
    const namedPills = namedItemsFnRef.current(Array.from(selection)).map(el => (el.name ? el : Object.assign(Object.assign({}, el), { name: "..." })));
    return (0, jsx_runtime_1.jsx)(sidePanelCell_1.SidePanelCell, { title: sidePanelTitle, role: "group", labelledBy: dropdownLabelledId, titleId: dropdownLabelledId, children: (0, jsx_runtime_1.jsxs)("div", { ref: sidePanelCellRef, children: [component, props.multiselect || props.multiselect === undefined ? (0, jsx_runtime_1.jsx)(pillBox_1.PillBox, { className: "zen-filters-bar-dropdown__pill-box", selectedPills: namedPills, onRemove: handleRemove }) : null] }) });
};
exports.FiltersBarDropdown = FiltersBarDropdown;
exports.TRANSLATIONS = [...new Set([...dropdown_1.TRANSLATIONS])];
