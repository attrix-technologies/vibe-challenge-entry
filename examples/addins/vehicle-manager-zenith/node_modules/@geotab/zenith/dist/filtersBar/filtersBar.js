"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSLATIONS = exports.FiltersBar = exports.FiltersBarDisplayName = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const filtersContainer_1 = require("./filtersContainer/filtersContainer");
const filtersBarActions_1 = require("./filtersBarActions/filtersBarActions");
const react_1 = require("react");
const filtersBarSidePanel_1 = require("./filtersBarSidePanel/filtersBarSidePanel");
const filtersBarSearch_1 = require("./components/filtersBarSearch/filtersBarSearch");
const filtersBarGroupButton_1 = require("./components/filtersBarGroupButton/filtersBarGroupButton");
const filtersBarGroupsFilter_1 = require("./components/filtersBarGroupsFilter/filtersBarGroupsFilter");
const filtersBarPeriodPicker_1 = require("./components/filtersBarPeriodPicker/filtersBarPeriodPicker");
const filtersBarDropdown_1 = require("./components/filtersBarDropdown/filtersBarDropdown");
const filtersBarDropdownWithCheckbox_1 = require("./components/filtersBarDropdownWithCheckbox/filtersBarDropdownWithCheckbox");
const filtersBarRange_1 = require("./components/filtersBarRange/filtersBarRange");
const isCustomElementValid_1 = require("./utils/isCustomElementValid");
const sidePanelReducer_1 = require("./filtersBarSidePanel/sidePanelReducer");
const filtersBarReducer_1 = require("./filtersBarReducer");
const useMobile_1 = require("../commonHelpers/hooks/useMobile");
const getNumberOfChangedFilters_1 = require("./utils/getNumberOfChangedFilters");
const filtersBarProvider_1 = require("./filtersBarProvider");
const filtersBarProviderSearch_1 = require("./filtersBarProviderSearch");
const filtersBarProviderTrigger_1 = require("./filtersBarProviderTrigger");
const focusableSelector_1 = require("../utils/focusableSelector");
/* eslint-enable @typescript-eslint/naming-convention */
exports.FiltersBarDisplayName = "FiltersBar";
const getChildren = (children) => (!children
    ? []
    : (react_1.Children.count(children) === 1 ? [children] : children)).filter(c => !!c);
const allowedComponents = [filtersBarSearch_1.FiltersBarSearch, filtersBarDropdown_1.FiltersBarDropdown, filtersBarGroupButton_1.FiltersBarGroupButton, filtersBarGroupsFilter_1.FiltersBarGroupsFilter, filtersBarPeriodPicker_1.FiltersBarPeriodPicker, filtersBarRange_1.FiltersBarRange];
const getAllowedChildren = (items) => items.reduce((acc, item) => {
    if (!item) {
        return acc;
    }
    if (allowedComponents.includes(item.type) || (0, isCustomElementValid_1.isCustomElementValid)(item)) {
        acc.push(item);
    }
    return acc;
}, []);
const getCurrentFiltersState = (children) => {
    const state = {};
    react_1.Children.forEach(children, (child) => {
        state[child.props.id] = {};
        state[child.props.id].state = child.props.state;
    });
    return state;
};
const mergeStates = (initialState, newState) => {
    const state = Object.assign({}, initialState);
    Object.keys(newState).forEach(key => {
        if (state[key]) {
            state[key] = newState[key] ? newState[key] : undefined;
        }
    });
    return state;
};
const FiltersBar = ({ className, children, isAllFiltersVisible, hideAllFiltersButton, parentElement, selectedQuantity, 
// eslint-disable-next-line @typescript-eslint/no-unused-vars
ignoreNewFunctionality, pillName, pillIcon, pillType, toggleAllFilters, getDefaultFiltersState, onClearAllFilters, onApplyAllFilters }) => {
    // eslint-disable-next-line @typescript-eslint/no-unused-expressions
    ignoreNewFunctionality; // TODO: remove after deprecated ignoreNewFunctionality removed
    const allFiltersRef = (0, react_1.useRef)(null);
    const emptyFiltersRef = (0, react_1.useRef)(null);
    const isMobile = (0, useMobile_1.useMobile)();
    const { setSearchComponent } = (0, filtersBarProviderSearch_1.useSearchComponent)();
    const { mobileTriggerRef } = (0, filtersBarProviderTrigger_1.useMobileTrigger)();
    const { setFiltersBarToggleAllFiltersFn, onUpdateNumberOfChangedFiltersFn } = (0, filtersBarProvider_1.useFiltersBarComponent)();
    const isAllFiltersButtonHidden = !isMobile && hideAllFiltersButton;
    const prevIsShouldSync = (0, react_1.useRef)(isMobile && isAllFiltersVisible);
    const prevIsOpen = (0, react_1.useRef)(isAllFiltersVisible);
    const toolbarRef = (0, react_1.useRef)(null);
    (0, react_1.useEffect)(() => {
        var _a, _b;
        if (!isAllFiltersVisible) {
            if (!isMobile && ((_a = allFiltersRef.current) === null || _a === void 0 ? void 0 : _a.getAttribute("aria-expanded")) === "true") {
                allFiltersRef.current.setAttribute("aria-expanded", "false");
            }
            if (isMobile && ((_b = mobileTriggerRef === null || mobileTriggerRef === void 0 ? void 0 : mobileTriggerRef.current) === null || _b === void 0 ? void 0 : _b.getAttribute("aria-expanded")) === "true") {
                mobileTriggerRef.current.setAttribute("aria-expanded", "false");
            }
        }
    }, [isAllFiltersVisible, isMobile, mobileTriggerRef]);
    const childrenArray = (0, react_1.useMemo)(() => getChildren(children), [children]);
    const filterBarChildren = (0, react_1.useMemo)(() => getAllowedChildren(childrenArray), [childrenArray]);
    const stateFromChildren = (0, react_1.useMemo)(() => getCurrentFiltersState(filterBarChildren), [filterBarChildren]);
    const [filtersBarState, dispatchFiltersBarState] = (0, react_1.useReducer)(filtersBarReducer_1.filtersBarReducer, (0, filtersBarReducer_1.getInitialFiltersBarState)(stateFromChildren, getDefaultFiltersState, onApplyAllFilters === undefined));
    const [sidePanelState, dispatchSidePanelState] = (0, react_1.useReducer)(sidePanelReducer_1.sidePanelReducer, stateFromChildren);
    (0, react_1.useEffect)(() => {
        // need for dynamic items loading
        if (Object.keys(stateFromChildren).length > Object.keys(sidePanelState).length) {
            dispatchSidePanelState({ type: sidePanelReducer_1.StateActionType.Reinitialize, payload: stateFromChildren });
        }
    }, [stateFromChildren, sidePanelState]);
    (0, react_1.useEffect)(() => {
        dispatchFiltersBarState({ type: filtersBarReducer_1.FiltersBarStateActionType.ChangeChildrenState, payload: { state: stateFromChildren, defaultStateFn: getDefaultFiltersState } });
    }, [stateFromChildren, getDefaultFiltersState]);
    (0, react_1.useEffect)(() => {
        if (onUpdateNumberOfChangedFiltersFn) {
            onUpdateNumberOfChangedFiltersFn(filtersBarState.numberOfChangedFilters);
        }
    }, [filtersBarState.numberOfChangedFilters, onUpdateNumberOfChangedFiltersFn]);
    const memoizedShouldUpdate = (0, react_1.useMemo)(() => {
        if (isMobile && isAllFiltersVisible) {
            prevIsShouldSync.current = true;
            return true;
        }
        prevIsShouldSync.current = false;
        return false;
    }, [isMobile, isAllFiltersVisible]);
    (0, react_1.useEffect)(() => {
        if (prevIsShouldSync.current && memoizedShouldUpdate) {
            prevIsShouldSync.current = false;
            if (prevIsOpen.current) {
                prevIsOpen.current = false;
                dispatchSidePanelState({ type: sidePanelReducer_1.StateActionType.Reinitialize, payload: mergeStates(stateFromChildren, sidePanelState) });
                return;
            }
            react_1.Children.forEach(filterBarChildren, (child) => {
                dispatchSidePanelState({ type: sidePanelReducer_1.StateActionType.Change, payload: { id: child.props.id, value: { state: child.props.state } } });
            });
        }
    }, [filterBarChildren, memoizedShouldUpdate, sidePanelState, stateFromChildren]);
    const searchChild = childrenArray.find(child => child && child.type === filtersBarSearch_1.FiltersBarSearch);
    setSearchComponent(searchChild);
    (0, react_1.useEffect)(() => {
        setFiltersBarToggleAllFiltersFn(toggleAllFilters);
    }, [toggleAllFilters, setFiltersBarToggleAllFiltersFn]);
    const toggleAllFiltersCallback = (0, react_1.useCallback)((value) => {
        if (!isAllFiltersVisible && value) {
            react_1.Children.forEach(filterBarChildren, (child) => {
                dispatchSidePanelState({ type: sidePanelReducer_1.StateActionType.Change, payload: { id: child.props.id, value: { state: child.props.state } } });
            });
        }
        toggleAllFilters(value);
        prevIsOpen.current = value;
    }, [isAllFiltersVisible, toggleAllFilters, filterBarChildren]);
    const onClosePanel = (0, react_1.useCallback)(() => toggleAllFiltersCallback(false), [toggleAllFiltersCallback]);
    const handleApplyAllFilters = (0, react_1.useCallback)((isSidePanel) => (value) => {
        var _a;
        if (onApplyAllFilters) {
            const newValue = value ? value : sidePanelState;
            const newState = isSidePanel ? Object.keys(newValue).reduce((res, key) => {
                var _a;
                res[key] = { state: (_a = newValue[key]) === null || _a === void 0 ? void 0 : _a.state };
                return res;
            }, {}) : filtersBarState.childrenState;
            isSidePanel && dispatchFiltersBarState({ type: filtersBarReducer_1.FiltersBarStateActionType.ChangeChildrenState, payload: { state: newState, defaultStateFn: getDefaultFiltersState } });
            dispatchFiltersBarState({ type: filtersBarReducer_1.FiltersBarStateActionType.UpdateNumber, payload: newState });
            onApplyAllFilters(newState);
            (_a = allFiltersRef.current) === null || _a === void 0 ? void 0 : _a.focus();
        }
    }, [onApplyAllFilters, sidePanelState, filtersBarState.childrenState, getDefaultFiltersState]);
    const handleClearClick = (0, react_1.useCallback)(() => {
        const defaultState = getDefaultFiltersState();
        dispatchFiltersBarState({ type: filtersBarReducer_1.FiltersBarStateActionType.ChangeChildrenState, payload: { state: defaultState, defaultStateFn: getDefaultFiltersState } });
        dispatchFiltersBarState({ type: filtersBarReducer_1.FiltersBarStateActionType.UpdateNumber, payload: defaultState });
        filterBarChildren.forEach(child => {
            const changeHandler = child.props.onChange;
            const newState = defaultState[child.props.id];
            const isAllowUnsetValue = child.type === filtersBarPeriodPicker_1.FiltersBarPeriodPicker;
            // @ts-expect-error: Let's ignore a compile error. if value undefined, and a value is passed to the function undefined, it can be passed because the interface is IDateRangeUnsetValue
            ((newState === null || newState === void 0 ? void 0 : newState.state) || isAllowUnsetValue) && changeHandler(newState.state);
        });
        onClearAllFilters && onClearAllFilters();
        onApplyAllFilters && onApplyAllFilters(defaultState);
        if (allFiltersRef.current) {
            allFiltersRef.current.focus();
        }
        else if (toolbarRef.current) {
            const focusable = toolbarRef.current.querySelector(focusableSelector_1.FOCUSABLE_SELECTOR);
            focusable === null || focusable === void 0 ? void 0 : focusable.focus();
        }
    }, [filterBarChildren, getDefaultFiltersState, onApplyAllFilters, onClearAllFilters]);
    const isApplyButtonShown = (0, react_1.useMemo)(() => {
        if (!onApplyAllFilters) {
            return false;
        }
        const defaultState = getDefaultFiltersState();
        if (Object.keys(defaultState).length === Object.keys(filtersBarState.prevChildrenState).length) {
            return (0, getNumberOfChangedFilters_1.getNumberOfChangedFilters)(filtersBarState.prevChildrenState, filtersBarState.childrenState) > 0;
        }
        return (0, getNumberOfChangedFilters_1.getNumberOfChangedFilters)(filtersBarState.childrenState, filtersBarState.prevChildrenState) > 0;
    }, [filtersBarState.childrenState, filtersBarState.prevChildrenState, getDefaultFiltersState, onApplyAllFilters]);
    const sidePanel = (0, react_1.useMemo)(() => {
        const sidePanelChild = childrenArray.find(child => child && child.type === filtersBarSidePanel_1.FiltersBarSidePanelContainer);
        if (!sidePanelChild) {
            return (0, jsx_runtime_1.jsx)(filtersBarSidePanel_1.FiltersBarSidePanel, { parentElement: parentElement, isOpen: isAllFiltersVisible, triggerRef: isMobile ? mobileTriggerRef || emptyFiltersRef : allFiltersRef, getDefaultFiltersState: getDefaultFiltersState, onClosePanel: onClosePanel, state: sidePanelState, onApplyAllFilters: handleApplyAllFilters(true), dispatch: dispatchSidePanelState, pillName: pillName, pillIcon: pillIcon, pillType: pillType, children: filterBarChildren });
        }
        const sidePanelChildren = getAllowedChildren(getChildren(sidePanelChild.props.children));
        return (0, jsx_runtime_1.jsx)(filtersBarSidePanel_1.FiltersBarSidePanel, { parentElement: parentElement, isOpen: isAllFiltersVisible, triggerRef: isMobile ? mobileTriggerRef || emptyFiltersRef : allFiltersRef, getDefaultFiltersState: getDefaultFiltersState, onClosePanel: onClosePanel, className: sidePanelChild.props.className, state: sidePanelChild.props.state, onApplyAllFilters: handleApplyAllFilters(true), dispatch: sidePanelChild.props.dispatch, pillName: pillName, pillIcon: pillIcon, pillType: pillType, children: sidePanelChildren });
    }, [childrenArray, parentElement, isAllFiltersVisible, isMobile, mobileTriggerRef, getDefaultFiltersState, onClosePanel, handleApplyAllFilters,
        pillName, pillIcon, pillType, sidePanelState, filterBarChildren]);
    const noActions = (0, react_1.useMemo)(() => isAllFiltersButtonHidden && (selectedQuantity === undefined && filtersBarState.currentNumberOfChangedFilters === 0 || selectedQuantity === 0)
        && (!isApplyButtonShown || onApplyAllFilters === undefined), [isAllFiltersButtonHidden, selectedQuantity, filtersBarState.currentNumberOfChangedFilters, isApplyButtonShown, onApplyAllFilters]);
    return (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [!isMobile && (0, jsx_runtime_1.jsxs)("div", { ref: toolbarRef, className: (0, classNames_1.classNames)(["zen-filters-toolbar", noActions ? "zen-filters-toolbar--no-actions" : "", className !== null && className !== void 0 ? className : ""]), children: [(0, jsx_runtime_1.jsx)(filtersContainer_1.FiltersContainer, { children: filterBarChildren }), (0, jsx_runtime_1.jsx)(filtersBarActions_1.FiltersBarActions, { allFiltersRef: allFiltersRef, onShowAllFilters: () => toggleAllFiltersCallback(true), onClearFilters: handleClearClick, selectedQuantity: selectedQuantity !== undefined ? selectedQuantity : filtersBarState.currentNumberOfChangedFilters, selectedQuantityToDisplay: selectedQuantity !== undefined ? selectedQuantity : filtersBarState.numberOfChangedFilters, hideAllFiltersButton: isAllFiltersButtonHidden, onApplyButtonClick: onApplyAllFilters ? handleApplyAllFilters(false) : undefined, isApplyButtonShown: isApplyButtonShown })] }), !isAllFiltersButtonHidden ? sidePanel : null] });
};
exports.FiltersBar = FiltersBar;
exports.FiltersBar.Search = filtersBarSearch_1.FiltersBarSearch;
exports.FiltersBar.Dropdown = filtersBarDropdown_1.FiltersBarDropdown;
exports.FiltersBar.DropdownWithCheckbox = filtersBarDropdownWithCheckbox_1.FiltersBarDropdownWithCheckbox;
exports.FiltersBar.GroupButton = filtersBarGroupButton_1.FiltersBarGroupButton;
exports.FiltersBar.GroupsFilter = filtersBarGroupsFilter_1.FiltersBarGroupsFilter;
exports.FiltersBar.PeriodPicker = filtersBarPeriodPicker_1.FiltersBarPeriodPicker;
exports.FiltersBar.Range = filtersBarRange_1.FiltersBarRange;
exports.FiltersBar.SidePanel = filtersBarSidePanel_1.FiltersBarSidePanelContainer;
exports.FiltersBar.displayName = exports.FiltersBarDisplayName;
exports.TRANSLATIONS = [...new Set([
        ...filtersBarSidePanel_1.TRANSLATIONS,
        ...filtersBarDropdown_1.TRANSLATIONS,
        ...filtersBarPeriodPicker_1.TRANSLATIONS,
        ...filtersBarRange_1.TRANSLATIONS
    ]).values()];
