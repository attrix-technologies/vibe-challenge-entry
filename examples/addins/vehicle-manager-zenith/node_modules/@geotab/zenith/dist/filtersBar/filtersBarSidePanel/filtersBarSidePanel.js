"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSLATIONS = exports.FiltersBarSidePanelContainer = exports.FiltersBarSidePanel = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const useLanguage_1 = require("../../utils/localization/useLanguage");
const themeContext_1 = require("../../utils/theme/themeContext");
const filtersBarRange_1 = require("../components/filtersBarRange/filtersBarRange");
const filtersBarPeriodPicker_1 = require("../components/filtersBarPeriodPicker/filtersBarPeriodPicker");
const utils_1 = require("../../commonHelpers/utils");
const react_dom_1 = require("react-dom");
const shield_1 = require("../../shield/shield");
const sidePanel_1 = require("../../sidePanel/sidePanel");
const classNames_1 = require("../../commonHelpers/classNames/classNames");
const textIconButton_1 = require("../../textIconButton/textIconButton");
const iconClose_1 = require("../../icons/iconClose");
const textIconButton_2 = require("../../textIconButton/textIconButton");
const button_1 = require("../../button/button");
const useMobile_1 = require("../../commonHelpers/hooks/useMobile");
const sidePanelReducer_1 = require("./sidePanelReducer");
const useUniqueId_1 = require("../../commonHelpers/useUniqueId");
const useBodyScroll_1 = require("../../utils/useBodyScroll");
const footerButtons_1 = require("../../footerButtons/footerButtons");
const pill_1 = require("../../pill/pill");
const getChangeHandlers = (children) => {
    const handlers = {};
    react_1.Children.map(children, (child) => {
        handlers[child.props.id] = child.props.onChange;
    });
    return handlers;
};
const FiltersBarSidePanel = ({ isOpen, className, children, triggerRef, parentElement, pillName, pillIcon, pillType = "info", onClosePanel, getDefaultFiltersState, state, dispatch, onApplyAllFilters }) => {
    var _a;
    const { translate } = (0, useLanguage_1.useLanguage)();
    const isLongTextLanguages = (0, react_1.useMemo)(() => `${translate("Reset All")}${translate("Cancel")}${translate("Apply")}`.length > 31, [translate]);
    const dataShieldId = (0, useUniqueId_1.useUniqueId)();
    const isMobile = (0, useMobile_1.useMobile)();
    const { dark } = (0, react_1.useContext)(themeContext_1.themeContext);
    const onChangeHandlers = (0, react_1.useMemo)(() => getChangeHandlers(children), [children]);
    const { setScrollHidden, resetScroll } = (0, useBodyScroll_1.useBodyScroll)();
    const onChangeState = (0, react_1.useCallback)((id, inputState) => {
        const componentState = state[id];
        if (componentState) {
            const action = { type: sidePanelReducer_1.StateActionType.Change, payload: { id: id, value: { state: (0, utils_1.deepClone)(inputState) } } };
            dispatch(action);
        }
    }, [state, dispatch]);
    const onHasErrorState = (0, react_1.useCallback)((id, isError) => {
        const componentState = state[id];
        if (componentState) {
            dispatch({ type: sidePanelReducer_1.StateActionType.SetError, payload: { id: id, value: isError } });
        }
    }, [state, dispatch]);
    const onCloseAction = (0, react_1.useCallback)((reason, shieldId) => {
        if (reason === sidePanel_1.SidePanelCloseReason.ClickOutside && shieldId === dataShieldId || reason === sidePanel_1.SidePanelCloseReason.Escape) {
            onClosePanel();
            return;
        }
    }, [onClosePanel, dataShieldId]);
    const newChildren = (0, react_1.useMemo)(() => react_1.Children.map(children, (child) => {
        if (!child) {
            return null;
        }
        const element = child;
        let hasCheckError = false;
        const childState = state[element.props.id];
        if (!element.props.showInSidePanel && !isMobile || !childState) {
            return null;
        }
        if (element.type === filtersBarRange_1.FiltersBarRange || element.type === filtersBarPeriodPicker_1.FiltersBarPeriodPicker) {
            hasCheckError = true;
        }
        return (0, react_1.cloneElement)(child, Object.assign(Object.assign(Object.assign({}, element.props), { useSidePanelView: true, id: element.props.id + "-side-panel", state: (0, utils_1.deepClone)(childState.state), key: element.props.id + "-side-panelKey", onChange: (newState) => onChangeState(element.props.id, newState) }), (hasCheckError ? { checkError: (hasError) => onHasErrorState(element.props.id, hasError) } : {})));
    }), [children, state, isMobile, onChangeState, onHasErrorState]);
    const onApplyFilters = (0, react_1.useCallback)(() => {
        let isHasError = false;
        Object.keys(state).forEach((key) => {
            const resultState = state[key];
            if (resultState === null || resultState === void 0 ? void 0 : resultState.hasError) {
                isHasError = true;
            }
        });
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        if (isHasError) {
            return;
        }
        onApplyAllFilters && onApplyAllFilters(Object.assign({}, state));
        Object.keys(state).forEach((key) => {
            const resultState = state[key];
            const changeHandler = onChangeHandlers[key];
            changeHandler === null || changeHandler === void 0 ? void 0 : changeHandler(resultState === null || resultState === void 0 ? void 0 : resultState.state);
        });
        onClosePanel();
    }, [state, onApplyAllFilters, onClosePanel, onChangeHandlers]);
    const onResetFilters = (0, react_1.useCallback)(() => {
        const defaultState = getDefaultFiltersState();
        dispatch({ type: sidePanelReducer_1.StateActionType.Reset, payload: defaultState });
    }, [getDefaultFiltersState, dispatch]);
    const applyDisabled = (0, react_1.useMemo)(() => Object.values(state).map(el => el === null || el === void 0 ? void 0 : el.hasError).filter(el => el).length > 0, [state]);
    const handleReadyForFocus = (0, react_1.useCallback)((isCurrentOpen) => {
        var _a;
        if (!isCurrentOpen) {
            (_a = triggerRef.current) === null || _a === void 0 ? void 0 : _a.focus();
            return;
        }
    }, [triggerRef]);
    (0, react_1.useEffect)(() => {
        const handleOpen = () => {
            setScrollHidden();
        };
        const handleClose = () => {
            resetScroll();
        };
        if (isOpen) {
            handleOpen();
        }
        else {
            handleClose();
        }
        return () => { handleClose(); };
    }, [isOpen, setScrollHidden, resetScroll]);
    return (0, jsx_runtime_1.jsxs)(react_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(shield_1.Shield, { className: "zen-high-level-shield", dataShieldId: dataShieldId, isVisible: isOpen }), (0, react_dom_1.createPortal)((0, jsx_runtime_1.jsx)(sidePanel_1.SidePanel, { triggerRef: triggerRef, isOpen: isOpen, label: translate("All Filters"), onHidePanel: onCloseAction, className: (0, classNames_1.classNames)(["zen-side-panel-filters-bar", dark ? "zen-dark" : "", className !== null && className !== void 0 ? className : ""]), onTransitionEnd: handleReadyForFocus, children: (0, jsx_runtime_1.jsxs)("div", { className: "zen-side-panel-filters-bar-wrapper", children: [(0, jsx_runtime_1.jsxs)("div", { className: "zen-side-panel-filters-bar__header", children: [(0, jsx_runtime_1.jsxs)("div", { className: "zen-side-panel-filters-bar__title-wrapper", children: [(0, jsx_runtime_1.jsx)("div", { className: "zen-side-panel-filters-bar__title zen-ellipsis", children: translate("All Filters") }), pillName ? (0, jsx_runtime_1.jsx)("div", { className: "zen-side-panel-filters-bar__title-pill", children: (0, jsx_runtime_1.jsx)(pill_1.Pill, { type: pillType, icon: pillIcon, children: pillName }) }) : null] }), (0, jsx_runtime_1.jsx)(textIconButton_1.TextIconButton, { type: "tertiary-black", className: "zen-side-panel-filters-bar__close-button", icon: iconClose_1.IconClose, iconSize: "large", onClick: onClosePanel, iconPosition: textIconButton_2.ButtonIconPosition.Start, title: translate("Close") })] }), (0, jsx_runtime_1.jsx)("div", { className: "zen-side-panel-filters-bar__content", children: newChildren }), (0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)(["zen-side-panel-filters-bar__footer", isMobile ? "zen-side-panel-filters-bar__footer--mobile" : "", isLongTextLanguages && !isMobile ? "zen-side-panel-filters-bar__footer--long-text" : ""]), children: isMobile ? (0, jsx_runtime_1.jsxs)(footerButtons_1.FooterButtons, { children: [(0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-side-panel-filters-bar__apply-button", disabled: applyDisabled, onClick: onApplyFilters, type: "primary", children: translate("Apply") }), (0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-side-panel-filters-bar__cancel-button", type: "secondary", onClick: onClosePanel, children: translate("Cancel") }), (0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-side-panel-filters-bar__clear-button", onClick: onResetFilters, type: "tertiary", children: translate("Reset All") })] }) : (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)("div", { className: "zen-side-panel-filters-bar__footer-section", children: (0, jsx_runtime_1.jsx)(button_1.Button, { type: "tertiary", className: "zen-side-panel-filters-bar__clear-button", onClick: onResetFilters, children: translate("Reset All") }) }), (0, jsx_runtime_1.jsxs)("div", { className: "zen-side-panel-filters-bar__footer-section", children: [(0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-side-panel-filters-bar__cancel-button", type: "secondary", onClick: onClosePanel, children: translate("Cancel") }), (0, jsx_runtime_1.jsx)(button_1.Button, { className: "zen-side-panel-filters-bar__apply-button zen-side-panel-filters-bar__apply-button--desktop", disabled: applyDisabled, onClick: onApplyFilters, type: "primary", children: translate("Apply") })] })] }) })] }) }), (_a = parentElement !== null && parentElement !== void 0 ? parentElement : document.fullscreenElement) !== null && _a !== void 0 ? _a : document.body)] });
};
exports.FiltersBarSidePanel = FiltersBarSidePanel;
const FiltersBarSidePanelContainer = (_) => (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, {});
exports.FiltersBarSidePanelContainer = FiltersBarSidePanelContainer;
exports.TRANSLATIONS = [
    "Apply",
    "Clear",
    "Reset All",
    "Close",
    "Cancel"
];
