"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TRANSLATIONS = exports.FiltersBarDropdownWithCheckbox = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const sidePanelCell_1 = require("../../../sidePanel/sidePanelCell/sidePanelCell");
const dropdown_1 = require("../../../dropdown/dropdown");
const pillBox_1 = require("../../../pillBox/pillBox");
const classNames_1 = require("../../../commonHelpers/classNames/classNames");
const useMobile_1 = require("../../../commonHelpers/hooks/useMobile");
const useUniqueId_1 = require("../../../commonHelpers/useUniqueId");
const filtersBarSidePanelDropdownWithCheckbox_1 = require("../../filtersBarSidePanel/components/filtersBarSidePanelDropdownWithCheckbox/filtersBarSidePanelDropdownWithCheckbox");
const focusableSelector_1 = require("../../../utils/focusableSelector");
// eslint-disable-next-line complexity
const FiltersBarDropdownWithCheckbox = ({ sidePanelTitle, className, props, state, useSidePanelView, onChange }) => {
    const isFullSelectionMode = (0, react_1.useMemo)(() => "isAllSelected" in state && typeof (state).isAllSelected === "boolean", [state]);
    const selection = (0, react_1.useMemo)(() => new Set(state.selected), [state]);
    const isMobile = (0, useMobile_1.useMobile)();
    const isCurrentAllSelected = (0, react_1.useMemo)(() => isFullSelectionMode ? state.isAllSelected : undefined, [isFullSelectionMode, state]);
    const isCurrentChecked = (0, react_1.useMemo)(() => state.isChecked, [state.isChecked]);
    const [_, setNamedFnReady] = (0, react_1.useState)(false);
    const namedItemsFnRef = (0, react_1.useRef)(items => items.map(el => ({ id: el, name: "..." })));
    const dropdownLabelledId = (0, useUniqueId_1.useUniqueId)();
    const sidePanelCellRef = (0, react_1.useRef)(null);
    const handleFocusOnRemove = (0, react_1.useCallback)((newSelectedFirstItem) => {
        var _a, _b, _c;
        if (newSelectedFirstItem) {
            const pillBoxElement = (_a = sidePanelCellRef.current) === null || _a === void 0 ? void 0 : _a.querySelector(`.zen-filters-bar-dropdown-with-checkbox__pill-box .zen-pill-box__pill[data-id="${newSelectedFirstItem}"]`);
            const focusable = pillBoxElement ?
                [...Array.from(pillBoxElement.querySelectorAll(focusableSelector_1.FOCUSABLE_SELECTOR))] : undefined;
            (_b = focusable === null || focusable === void 0 ? void 0 : focusable[0]) === null || _b === void 0 ? void 0 : _b.focus();
        }
        else {
            const focusable = sidePanelCellRef.current ? [...Array.from(sidePanelCellRef.current.querySelectorAll(focusableSelector_1.FOCUSABLE_SELECTOR))] : undefined;
            (_c = focusable === null || focusable === void 0 ? void 0 : focusable[0]) === null || _c === void 0 ? void 0 : _c.focus();
        }
    }, []);
    const handleRemove = (0, react_1.useCallback)((removedId) => {
        const newSelection = Array.from(selection).filter(el => el !== removedId);
        if (isFullSelectionMode) {
            onChange({ selected: newSelection,
                isAllSelected: false, isChecked: state.isChecked });
        }
        else {
            onChange({ selected: newSelection,
                isChecked: state.isChecked });
        }
        handleFocusOnRemove(newSelection[0]);
    }, [handleFocusOnRemove, isFullSelectionMode, onChange, selection, state]);
    const componentWidth = (0, react_1.useMemo)(() => useSidePanelView ? undefined : props.width, [useSidePanelView, props.width]);
    const onChangeFullSelectionWithCheckbox = (0, react_1.useCallback)((newValue) => {
        onChange({ selected: newValue.selected.map(el => el.id), isAllSelected: newValue.isAllSelected || false, isChecked: newValue.isChecked });
    }, [onChange]);
    const onChangeWithCheckbox = (0, react_1.useCallback)((newValue) => {
        onChange({ selected: newValue.selected.map(el => el.id), isChecked: newValue.isChecked });
    }, [onChange]);
    const { getData } = props, restProps = __rest(props, ["getData"]);
    const memoizedGetData = (0, react_1.useMemo)(() => getData, [getData]);
    const commonProps = (0, react_1.useMemo)(() => (Object.assign(Object.assign({}, restProps), { width: componentWidth, inputId: props.inputId && useSidePanelView ? `${props.inputId}-side-panel` : props.inputId, className: (0, classNames_1.classNames)([className || "", useSidePanelView ? "zen-filters-bar-dropdown-with-checkbox--side-panel" : "",
            !useSidePanelView && !props.width ? "zen-filters-bar-dropdown-with-checkbox--toolbar" : ""]), classNamePopup: (0, classNames_1.classNames)(["zen-filters-bar-dropdown-with-checkbox-popup", props.classNamePopup || ""]), fullWidthTriggerButton: useSidePanelView ? true : props.fullWidthTriggerButton, error: undefined, hasApplyButton: useSidePanelView ? false : props.hasApplyButton, getNamedItems: useSidePanelView ? (fn) => {
            namedItemsFnRef.current = fn;
            setNamedFnReady(val => !val);
        } : undefined })), [className, componentWidth, props.classNamePopup, props.fullWidthTriggerButton, props.hasApplyButton, props.inputId, props.width, restProps, useSidePanelView]);
    const componentWithSeparateCheckbox = isFullSelectionMode ? ((0, jsx_runtime_1.jsx)(filtersBarSidePanelDropdownWithCheckbox_1.FiltersBarSidePanelDropdownWithCheckbox, { props: Object.assign({}, commonProps), state: state, onChange: onChange, getData: memoizedGetData })) : (0, jsx_runtime_1.jsx)(filtersBarSidePanelDropdownWithCheckbox_1.FiltersBarSidePanelDropdownWithCheckbox, { props: Object.assign({}, commonProps), state: state, onChange: onChange, getData: memoizedGetData });
    const component = isFullSelectionMode ? ((0, jsx_runtime_1.jsx)(dropdown_1.Dropdown, Object.assign({}, commonProps, { checkboxLabel: props.checkboxLabel, getData: props.getData, value: { selected: Array.from(selection), isAllSelected: isCurrentAllSelected || false, isChecked: isCurrentChecked }, onChange: onChangeFullSelectionWithCheckbox, defaultValue: props.defaultValue, multiselect: true, selectAllButton: true }))) : ((0, jsx_runtime_1.jsx)(dropdown_1.Dropdown, Object.assign({}, commonProps, { checkboxLabel: props.checkboxLabel, getData: props.getData, value: { selected: Array.from(selection), isChecked: isCurrentChecked }, onChange: onChangeWithCheckbox, defaultValue: props.defaultValue })));
    if (!useSidePanelView) {
        return component;
    }
    const namedPills = namedItemsFnRef.current(Array.from(selection)).map(el => (el.name ? el : Object.assign(Object.assign({}, el), { name: "..." })));
    return (0, jsx_runtime_1.jsx)(sidePanelCell_1.SidePanelCell, { title: sidePanelTitle, role: "group", labelledBy: dropdownLabelledId, titleId: dropdownLabelledId, children: (0, jsx_runtime_1.jsxs)("div", { ref: sidePanelCellRef, children: [isMobile ? component : componentWithSeparateCheckbox, props.multiselect || props.multiselect === undefined ? (0, jsx_runtime_1.jsx)(pillBox_1.PillBox, { className: "zen-filters-bar-dropdown-with-checkbox__pill-box", selectedPills: namedPills, onRemove: handleRemove }) : null] }) });
};
exports.FiltersBarDropdownWithCheckbox = FiltersBarDropdownWithCheckbox;
exports.TRANSLATIONS = [...new Set([...dropdown_1.TRANSLATIONS])];
