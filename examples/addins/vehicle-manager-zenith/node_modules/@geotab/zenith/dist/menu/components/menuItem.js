"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.MenuItem = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const menuButton_1 = require("./menuButton");
const controlledMenu_1 = require("../controlledMenu");
const controlledPopup_1 = require("../../controlledPopup/controlledPopup");
const pathContext_1 = require("../contexts/pathContext");
const classNames_1 = require("../../commonHelpers/classNames/classNames");
const utils_1 = require("../../commonHelpers/utils");
const headerContext_1 = require("../../header/headerContext");
const MenuItem = ({ id, children, name, icon, disabled, onClick, link, target, rel, isMobile = false, setIsOpen, trigger, className, active, alignment }) => {
    const aligmentContext = (0, react_1.useContext)(headerContext_1.MenuAlignmentContext);
    const contentAlignment = alignment || aligmentContext.alignment || "right-top";
    const { path, onOpenBranch, closeBranch } = (0, react_1.useContext)(pathContext_1.PathContext);
    const memoizedDesktopActionOnClick = (0, react_1.useCallback)((itemId, e) => {
        setIsOpen === null || setIsOpen === void 0 ? void 0 : setIsOpen(false);
        onClick === null || onClick === void 0 ? void 0 : onClick(itemId, e);
    }, [setIsOpen, onClick]);
    const memoizedMobileActionOnClick = (0, react_1.useCallback)((itemId, e) => {
        onOpenBranch(id);
        !link && (onClick === null || onClick === void 0 ? void 0 : onClick(itemId, e));
    }, [id, onClick, link, onOpenBranch]);
    const memoizedTriggerOnClick = (0, react_1.useCallback)((itemId, e) => {
        onOpenBranch(id);
        !link && (onClick === null || onClick === void 0 ? void 0 : onClick(itemId, e));
    }, [onClick, onOpenBranch, id, link]);
    const memoizedCustomTriggerOnClick = (0, react_1.useCallback)((e, ...rest) => {
        var _a, _b;
        onOpenBranch(id);
        if ((_a = trigger === null || trigger === void 0 ? void 0 : trigger.props) === null || _a === void 0 ? void 0 : _a.onClick) {
            (_b = trigger.props) === null || _b === void 0 ? void 0 : _b.onClick(...[e, ...rest]);
            return;
        }
        onClick === null || onClick === void 0 ? void 0 : onClick(id, e);
    }, [onClick, onOpenBranch, id, trigger]);
    const memoizedOnOpenChange = (0, react_1.useCallback)(() => {
        closeBranch();
    }, [closeBranch]);
    const ref = (0, react_1.useRef)(null);
    const content = (0, react_1.useMemo)(() => {
        const cont = [];
        react_1.Children.map(children, (child) => {
            if (!child) {
                return;
            }
            if (typeof child === "string") {
                cont.push((0, jsx_runtime_1.jsx)("li", { className: (0, classNames_1.classNames)(["zen-menu-item__content", className !== null && className !== void 0 ? className : ""]), role: "presentation", children: child }, (0, utils_1.generateId)()));
                return;
            }
            if (child.type === controlledMenu_1.ControlledMenu.Item) {
                const clone = (0, react_1.cloneElement)(child, {
                    isMobile,
                    key: child.props.id,
                    setIsOpen
                });
                cont.push(clone);
                return;
            }
            cont.push((0, jsx_runtime_1.jsx)("li", { className: (0, classNames_1.classNames)(["zen-menu-item__content", className !== null && className !== void 0 ? className : ""]), role: "presentation", children: child }, child.props.id || child.props["data-id"] || (0, utils_1.generateId)()));
        });
        return cont;
    }, [children, isMobile, setIsOpen, className]);
    const isOpen = (0, react_1.useMemo)(() => path.includes(id), [path, id]);
    if (content.length === 0) {
        return (0, jsx_runtime_1.jsx)(menuButton_1.MenuButton, { id: id, name: name, icon: icon, disabled: disabled, link: link, target: target, rel: rel, onClick: memoizedDesktopActionOnClick, className: className, active: active, hasChildren: false }, id);
    }
    if (isMobile) {
        return (0, jsx_runtime_1.jsx)(menuButton_1.MenuButton, { id: id, name: name, icon: icon, disabled: disabled, link: link, target: target, rel: rel, onClick: memoizedMobileActionOnClick, active: active, hasChildren: true }, id);
    }
    let popupTrigger;
    if (trigger) {
        popupTrigger = (0, react_1.cloneElement)(trigger, {
            ref: ref,
            onClick: memoizedCustomTriggerOnClick
        });
    }
    else {
        popupTrigger = (0, jsx_runtime_1.jsx)(menuButton_1.MenuButton, { id: id, ref: ref, name: name, icon: icon, disabled: disabled, hasChildren: true, onClick: memoizedTriggerOnClick, active: active }, id);
    }
    return (0, jsx_runtime_1.jsxs)(react_1.Fragment, { children: [popupTrigger, (0, jsx_runtime_1.jsx)(controlledPopup_1.ControlledPopup, { className: (0, classNames_1.classNames)([`zen-controlled-menu-submenu--${path.length}`]), useTrapFocusWithTrigger: "on", alignment: contentAlignment, triggerRef: ref, isOpen: isOpen, onOpenChange: memoizedOnOpenChange, ariaLabel: popupTrigger.props.name, recalculateOnScroll: true, children: (0, jsx_runtime_1.jsx)("ul", { role: "menu", className: "zen-menu-item", children: content }) })] }, id);
};
exports.MenuItem = MenuItem;
