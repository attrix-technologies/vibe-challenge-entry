"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createCurrentlySelectedOptions = exports.createAdjustmentOptions = exports.createInitialOptions = exports.isAllChildrenSelected = exports.getBackButtonName = void 0;
const groupsFilterHelper_1 = require("./groupsFilterHelper");
const groupsHelper_1 = require("./groupsHelper");
const stateReducerHelper_1 = require("./stateReducer/stateReducerHelper");
const getBackButtonName = (stateObj, currentId) => {
    if (!currentId) {
        return undefined;
    }
    const currentEl = (0, stateReducerHelper_1.getGroupsTreeItem)(stateObj, currentId);
    return currentEl ? (0, groupsHelper_1.getGroupDescription)(currentEl, stateObj.translate) : undefined;
};
exports.getBackButtonName = getBackButtonName;
const isAllChildrenSelected = (stateObj, currentId) => {
    if (!currentId) {
        return false;
    }
    const selectedIds = new Set(stateObj.selectedIds);
    const currentEl = (0, stateReducerHelper_1.getGroupsTreeItem)(stateObj, currentId);
    return currentEl && currentEl.children && currentEl.children.length ? currentEl.children.every(el => selectedIds.has(el.id)) : false;
};
exports.isAllChildrenSelected = isAllChildrenSelected;
const defaultGroupsMenu = { builtInGroups: [], userGroups: [], currentId: undefined };
const createInitialOptions = (stateObj, limit, searchStr, value) => {
    let options;
    if (!searchStr) {
        options = (0, stateReducerHelper_1.getMenu)(stateObj);
    }
    else {
        options = (0, stateReducerHelper_1.getSearchResultFromObject)(stateObj, searchStr) || defaultGroupsMenu;
    }
    const preparedOptions = (0, groupsFilterHelper_1.prepareOptions)(stateObj.translate, value ? options[value].slice(0, limit) : [...options.builtInGroups.slice(0, limit / 2), ...options.userGroups.slice(0, limit / 2)], () => stateObj.selectedIds, (id) => (0, stateReducerHelper_1.getSelectedChildren)(stateObj, id), false, (id) => (0, stateReducerHelper_1.getPathToRoot)(stateObj, id));
    return preparedOptions;
};
exports.createInitialOptions = createInitialOptions;
const createAdjustmentOptions = (stateObj, isWithColor, limit, currentId, value) => {
    let options;
    if (!currentId) {
        options = defaultGroupsMenu;
    }
    else {
        options = (0, stateReducerHelper_1.getMenu)(stateObj, currentId);
    }
    const preparedOptions = (0, groupsFilterHelper_1.prepareOptions)(stateObj.translate, value ? options[value].slice(0, limit) : [...options.builtInGroups.slice(0, limit / 2), ...options.userGroups.slice(0, limit / 2)], () => stateObj.selectedIds, (id) => (0, stateReducerHelper_1.getSelectedChildren)(stateObj, id), isWithColor, (id) => (0, stateReducerHelper_1.getPathToRoot)(stateObj, id));
    return preparedOptions;
};
exports.createAdjustmentOptions = createAdjustmentOptions;
const getAdvancedFilterOptions = (state, newAdvancedOptions, additionalState) => {
    let advancedFilter;
    if (additionalState && !(0, groupsHelper_1.compareFilters)(additionalState, (0, groupsHelper_1.getDefaultFilterState)())) {
        advancedFilter = (0, stateReducerHelper_1.getAdvancedFilterNamedState)(state, additionalState);
    }
    else {
        advancedFilter = newAdvancedOptions && !(0, groupsHelper_1.compareFilters)(newAdvancedOptions, (0, groupsHelper_1.getDefaultFilterState)()) ? (0, stateReducerHelper_1.getAdvancedFilterNamedState)(state, newAdvancedOptions) : undefined;
    }
    const advancedOptionsStrings = newAdvancedOptions ? (0, groupsFilterHelper_1.getAdvancedFilterString)(state.translate, (0, stateReducerHelper_1.getAdvancedFilterNamedState)(state, state.advancedFilterState)) : "";
    const currentOptionsString = advancedFilter ? (0, groupsFilterHelper_1.getAdvancedFilterString)(state.translate, advancedFilter) : "";
    return advancedFilter ? (0, groupsFilterHelper_1.prepareAdvancedOptions)([currentOptionsString], advancedOptionsStrings) : [];
};
const createCurrentlySelectedOptions = (stateObj, value, isWithColor, additionalItems, limit, additionalState) => {
    const selectedItems = (0, stateReducerHelper_1.getCurrentlySelectedMenu)(stateObj);
    const deselectedItems = additionalItems.length ? (0, stateReducerHelper_1.getCurrentlyDeselectedMenu)(stateObj, additionalItems) : undefined;
    let preparedOptions;
    if (value === "advancedGroups") {
        preparedOptions = getAdvancedFilterOptions(stateObj, selectedItems.advancedGroups, additionalState);
    }
    else {
        const sortedItems = deselectedItems ? [...selectedItems[value], ...deselectedItems[value]].sort((val1, val2) => val1.id > val2.id ? 1 : -1)
            : [...selectedItems[value]].sort((val1, val2) => val1.id > val2.id ? 1 : -1);
        preparedOptions = (0, groupsFilterHelper_1.prepareSelectedOptions)(stateObj.translate, sortedItems.slice(0, limit), () => stateObj.selectedIds, isWithColor, (id) => (0, stateReducerHelper_1.getPathToRoot)(stateObj, id));
    }
    return preparedOptions;
};
exports.createCurrentlySelectedOptions = createCurrentlySelectedOptions;
