"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataFeedCell = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const classNames_1 = require("../../commonHelpers/classNames/classNames");
const basicColumn_1 = require("../../dataGrid/columns/basicColumn");
const FeedCell = ({ limited = false, visibleOnHover = false, isVisible, title, render, renderWrappers, renderPlaceholder, defaultValue, entity, isNested }) => {
    const [labelContent, setLabelContent] = (0, react_1.useState)("");
    const [content, setContent] = (0, react_1.useState)("");
    const placeholderRenderer = (0, react_1.useCallback)(() => {
        const [feedTitle, value] = renderPlaceholder ? renderPlaceholder(title, entity) : [title, "..."];
        return [feedTitle, renderWrappers(value, entity)];
    }, [entity, renderPlaceholder, renderWrappers, title]);
    const renderer = (0, react_1.useCallback)(async () => {
        let fieldValue = null;
        const [label, value] = render(title, entity, isNested);
        fieldValue = value;
        if (value === undefined || value === null) {
            fieldValue = defaultValue;
        }
        if (!(0, basicColumn_1.isPromiseLike)(fieldValue)) {
            return [label, renderWrappers(fieldValue, entity)];
        }
        let postponedResult = await fieldValue;
        if (postponedResult === undefined) {
            postponedResult = defaultValue;
        }
        return [label, renderWrappers(postponedResult, entity)];
    }, [defaultValue, entity, render, renderWrappers, title, isNested]);
    (0, react_1.useEffect)(() => {
        if (!isVisible) {
            setContent("");
            return () => { };
        }
        const placeholderTimeout = requestAnimationFrame(() => {
            const [label, value] = placeholderRenderer();
            setLabelContent(label);
            setContent(value);
        });
        renderer().then(([label, value]) => {
            cancelAnimationFrame(placeholderTimeout);
            setLabelContent(label);
            setContent(value);
        }).catch((e) => {
            console.error(e);
            cancelAnimationFrame(placeholderTimeout);
            setLabelContent("");
            setContent("");
        });
        return () => cancelAnimationFrame(placeholderTimeout);
    }, [isVisible, renderer, placeholderRenderer]);
    return (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [labelContent ? (0, jsx_runtime_1.jsx)("div", { className: "zen-feed-item__label", children: labelContent }) : null, content
                ? (0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)([
                        "zen-feed-item__value",
                        limited ? "zen-feed-item__value--limited" : "",
                        visibleOnHover ? "zen-feed-item__value--visible-on-hover" : ""
                    ]), style: { gridColumn: labelContent ? "2/2" : "1/span 2", width: labelContent ? undefined : "100%" }, children: content })
                : null] });
};
exports.DataFeedCell = (0, react_1.memo)(FeedCell);
