"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataFeed = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const findVisible_1 = require("../dataGrid/extensions/findVisible");
const toBasicColumn_1 = require("../dataGrid/extensions/toBasicColumn");
const useResize_1 = require("../commonHelpers/hooks/useResize");
const dataFeedColumnsItems_1 = require("./dataFeedColumnsItems");
const getRowClassName_1 = require("../dataGrid/getRowClassName");
const EmptyList = ({ children }) => (0, jsx_runtime_1.jsx)("div", { className: "zen-data-feed__empty", children: children });
const Footer = ({ children }) => (0, jsx_runtime_1.jsx)("div", { className: "zen-data-feed__footer", children: children });
const endOfFeedThreshold = 100;
const checkCloseToTheEnd = (feedContainerElt) => {
    const feedElt = feedContainerElt === null || feedContainerElt === void 0 ? void 0 : feedContainerElt.querySelector(".zen-data-feed");
    if (!feedContainerElt || !feedElt) {
        return false;
    }
    const scrollTop = feedContainerElt.scrollTop;
    const distanceToTheBottom = feedElt.offsetHeight - scrollTop - feedContainerElt.offsetHeight;
    return distanceToTheBottom < endOfFeedThreshold;
};
const FIRST_RENDERED_ROWS = 50;
const DataFeedInner = ({ entities, columns, feedWrappers, className, expanded, options, description, children, actions, actionsAsync, primaryActions, itemsPerPage = 1000, rowClassName, expandedRows, onExpandedChange, activePage }, ref) => {
    const [pages, setPages] = (0, react_1.useState)(1);
    const data = (0, react_1.useMemo)(() => entities.slice(0, itemsPerPage * pages), [entities, itemsPerPage, pages]);
    const initialVisibleRows = (0, react_1.useMemo)(() => data.slice(0, FIRST_RENDERED_ROWS).map(r => r.id), [data]);
    const [visibleRows, setVisibleRows] = (0, react_1.useState)(new Set(initialVisibleRows));
    const { collapsedColumnsQty = 0, onFeedEnd, visibleColumns } = options;
    const feedRef = (0, react_1.useRef)(null);
    const lazyRenderTimerRef = (0, react_1.useRef)(0);
    (0, react_1.useEffect)(() => {
        setPages(1);
        if (feedRef.current) {
            feedRef.current.scrollTop = 0;
        }
    }, [activePage, setPages]);
    (0, react_1.useEffect)(() => {
        const initialRows = data.slice(0, FIRST_RENDERED_ROWS).map(r => r.id);
        setVisibleRows(new Set(initialRows));
    }, [data]);
    (0, react_1.useImperativeHandle)(ref, () => feedRef.current, []);
    const columnsList = (0, react_1.useMemo)(() => columns.map(toBasicColumn_1.toBasicColumn), [columns]);
    const itemsMap = (0, react_1.useMemo)(() => new Map(data.map(entity => [entity.id, entity])), [data]);
    const emptyList = (0, react_1.useMemo)(() => react_1.Children.toArray(children).find(child => child.type === EmptyList), [children]);
    const footer = (0, react_1.useMemo)(() => react_1.Children.toArray(children).find(child => child.type === Footer), [children]);
    const getVisibleItems = () => {
        if (!feedRef.current) {
            return [];
        }
        const { top, bottom } = feedRef.current.getBoundingClientRect();
        const itemsEls = feedRef.current.querySelectorAll(".zen-data-feed__item");
        if (!itemsEls.length) {
            return [];
        }
        return (0, findVisible_1.findVisibleRows)([...itemsEls], top, bottom);
    };
    const scheduleVisibleChanges = (0, react_1.useCallback)(() => requestAnimationFrame(() => {
        const visible = getVisibleItems();
        const newVisibleRows = visible.filter(row => {
            const id = row.dataset.rowId;
            if (id === undefined) {
                return false;
            }
            const entity = itemsMap.get(id);
            if (entity === undefined) {
                return false;
            }
            return row;
        }).map(row => row.dataset.rowId);
        const hasNewRows = newVisibleRows.some(id => !visibleRows.has(id));
        if (hasNewRows) {
            const newRowsSet = new Set(visibleRows);
            newVisibleRows.forEach(row => newRowsSet.add(row));
            setVisibleRows(newRowsSet);
        }
        if (visibleRows.size && checkCloseToTheEnd(feedRef.current)) {
            if (entities.length > data.length) {
                setPages(pages + 1);
            }
            onFeedEnd && onFeedEnd();
        }
    }), [itemsMap, visibleRows, setVisibleRows, onFeedEnd, pages, setPages, entities, data.length]);
    const scheduleLazyRender = (0, react_1.useCallback)(() => {
        cancelAnimationFrame(lazyRenderTimerRef.current);
        lazyRenderTimerRef.current = scheduleVisibleChanges();
    }, [scheduleVisibleChanges]);
    const handleScroll = (0, react_1.useCallback)(() => {
        scheduleLazyRender();
    }, [scheduleLazyRender]);
    (0, useResize_1.useResize)(() => {
        handleScroll();
    }, true);
    const feedItems = (0, react_1.useMemo)(() => data.map((entity, index) => {
        const entityClassName = (0, getRowClassName_1.getRowClassName)(rowClassName, entity);
        return (0, jsx_runtime_1.jsx)(dataFeedColumnsItems_1.FeedItem, { collapsedColumnsQty: collapsedColumnsQty, columnsList: columnsList, feedWrappers: feedWrappers || [], visibleColumns: visibleColumns, entity: entity, visibleRows: visibleRows, index: index, expanded: expanded, className: entityClassName, actions: actions, actionsAsync: actionsAsync, primaryActions: primaryActions, isRowExpanded: expandedRows && expandedRows.indexOf(entity.id) > -1, onExpandedChange: (isExpanded) => onExpandedChange && onExpandedChange(entity.id, isExpanded) }, entity.id);
    }), [data, rowClassName, collapsedColumnsQty, columnsList, feedWrappers, visibleColumns, visibleRows, expanded, actions, actionsAsync, primaryActions, expandedRows, onExpandedChange]);
    return (0, jsx_runtime_1.jsx)("div", { className: "zen-data-grid-wrapper", children: (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)([
                "zen-data-grid",
                className || ""
            ]), ref: feedRef, onScroll: handleScroll, children: [(0, jsx_runtime_1.jsx)("div", { role: "feed", className: "zen-data-grid__feed zen-data-feed", "aria-label": description, "aria-busy": "false", children: feedItems }), emptyList && data.length === 0 ? emptyList : null, footer] }) });
};
const DataFeed = (0, react_1.forwardRef)(DataFeedInner);
exports.DataFeed = DataFeed;
DataFeed.EmptyList = EmptyList;
DataFeed.Footer = Footer;
