"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ActionLinkColumn = exports.CheckboxColumn = exports.MainColumn = exports.ActionsColumn = exports.getSortableValue = exports.ColumnSortDirection = exports.getEmptySelection = exports.Table = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const dataFeed_1 = require("../dataFeed/dataFeed");
const dataGrid_1 = require("../dataGrid/dataGrid");
const useSelectableRows_1 = require("./selectable/useSelectableRows");
const useSortableColumns_1 = require("./sortable/useSortableColumns");
const useFlexibleColumns_1 = require("./flexible/useFlexibleColumns");
const useActions_1 = require("./actions/useActions");
const useLoading_1 = require("./loading/useLoading");
const entitiesListActions_1 = require("../dataGrid/entitiesListActions/entitiesListActions");
const dataFeedSelectPanel_1 = require("../dataFeed/dataFeedSelectPanel/dataFeedSelectPanel");
const columnsListButton_1 = require("../dataGrid/entitiesListActions/actions/columnsListButton");
const useTableChildren_1 = require("./children/useTableChildren");
const deviceType_1 = require("../commonHelpers/hooks/deviceType");
const useMobile_1 = require("../commonHelpers/hooks/useMobile");
const tableFullscreen_1 = require("./children/tableFullscreen");
const tableBulkActions_1 = require("./children/tableBulkActions");
const tablePagination_1 = require("./children/tablePagination");
const tableEmpty_1 = require("./children/tableEmpty");
const tableFooter_1 = require("./children/tableFooter");
const useSelectableRows_2 = require("./selectable/useSelectableRows");
Object.defineProperty(exports, "getEmptySelection", { enumerable: true, get: function () { return useSelectableRows_2.getEmptySelection; } });
const interfaces_1 = require("./sortable/interfaces");
Object.defineProperty(exports, "ColumnSortDirection", { enumerable: true, get: function () { return interfaces_1.ColumnSortDirection; } });
const useSortableColumns_2 = require("./sortable/useSortableColumns");
Object.defineProperty(exports, "getSortableValue", { enumerable: true, get: function () { return useSortableColumns_2.getSortableValue; } });
const actionsColumn_1 = require("../dataGrid/columns/actionsColumn/actionsColumn");
Object.defineProperty(exports, "ActionsColumn", { enumerable: true, get: function () { return actionsColumn_1.ActionsColumn; } });
const mainColumn_1 = require("../dataGrid/columns/mainColumn/mainColumn");
Object.defineProperty(exports, "MainColumn", { enumerable: true, get: function () { return mainColumn_1.MainColumn; } });
const checkboxColumn_1 = require("../dataGrid/columns/checkboxColumn/checkboxColumn");
Object.defineProperty(exports, "CheckboxColumn", { enumerable: true, get: function () { return checkboxColumn_1.CheckboxColumn; } });
const actionLinkColumn_1 = require("../dataGrid/columns/actionLinkColumn/actionLinkColumn");
Object.defineProperty(exports, "ActionLinkColumn", { enumerable: true, get: function () { return actionLinkColumn_1.ActionLinkColumn; } });
const bulkActionButton_1 = require("../dataGrid/withSelectableRows/components/bulkActions/bulkActionButton/bulkActionButton");
const bulkActionLink_1 = require("../dataGrid/withSelectableRows/components/bulkActions/bulkActionLink/bulkActionLink");
const layoutSizeProvider_1 = require("../layout/layoutSizeProvider");
const layoutFullScreen_1 = require("../layout/layoutFullScreen");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const useFeedExpandable_1 = require("./expandable/useFeedExpandable");
const feedExpandControl_1 = require("../dataFeed/feedExpandControl/feedExpandControl");
const getGridClasses_1 = require("../gridLayout/utils/getGridClasses");
const useNestedRows_1 = require("./nested/useNestedRows");
const TableInner = ({ entities, columns, selectable, sortable, flexible, isLoading, loading, children, className, height, onFeedEnd, rowClassName, feedExpandable, expandedRows, onExpand }) => {
    var _a, _b, _c;
    const isMobile = (0, useMobile_1.useMobile)();
    const gridRef = (0, react_1.useRef)(null);
    const columnsPopupRef = (0, react_1.useRef)(null);
    const [selectMode, setSelectMode] = (0, react_1.useState)((((_a = selectable === null || selectable === void 0 ? void 0 : selectable.selection) === null || _a === void 0 ? void 0 : _a.selected) || []).length > 0 || ((_b = selectable === null || selectable === void 0 ? void 0 : selectable.selection) === null || _b === void 0 ? void 0 : _b.all) || false);
    const { contentHeight } = (0, layoutSizeProvider_1.useLayoutSize)();
    const setMobileSelectMode = (0, react_1.useCallback)((value) => {
        if (isMobile) {
            return;
        }
        setSelectMode(value);
    }, [isMobile, setSelectMode]);
    const { expanded, onExpandedChange, nestedColumns, nestedFeedWrapper } = (0, useNestedRows_1.useNestedRows)(expandedRows, onExpand, columns, isMobile);
    const { selectableColumns, selectableFeedWrapper } = (0, useSelectableRows_1.useSelectableRows)(nestedColumns, entities, isMobile, selectMode, setMobileSelectMode, isLoading ? undefined : selectable);
    const { sortableColumns, feedSortControl } = (0, useSortableColumns_1.useSortableColumns)(selectableColumns, sortable, isMobile);
    const { flexibleColumns, columnsPopup } = (0, useFlexibleColumns_1.useFlexibleColumns)(sortableColumns, flexible, gridRef, columnsPopupRef, isMobile);
    const { columnsWithActions, actions, actionsAsync, primaryActions } = (0, useActions_1.useActions)(flexibleColumns, isMobile);
    const { loadingColumns, loadingEntities } = (0, useLoading_1.useLoading)(columnsWithActions, entities, isLoading, loading);
    const { isFeedExpanded, handleExpanded, isFeedVisible, visibleColumns } = (0, useFeedExpandable_1.useFeedExpandable)(isMobile, feedExpandable);
    const selectionQty = (0, react_1.useMemo)(() => {
        var _a, _b;
        if (!selectable) {
            return 0;
        }
        return ((_a = selectable.selection) === null || _a === void 0 ? void 0 : _a.all) ? loadingEntities.length : ((_b = selectable.selection) === null || _b === void 0 ? void 0 : _b.selected.length) || 0;
    }, [selectable, loadingEntities.length]);
    const clearSelection = (0, react_1.useCallback)(() => {
        setSelectMode(false);
        selectable === null || selectable === void 0 ? void 0 : selectable.onSelect({ all: false, selected: [] });
    }, [selectable]);
    const selectAll = (0, react_1.useCallback)(() => {
        selectable === null || selectable === void 0 ? void 0 : selectable.onSelect({ all: true, selected: [] });
    }, [selectable]);
    const { bulkActions, pagination, activePage, fullscreenButton, emptyList, footer, other } = (0, useTableChildren_1.useTableChildren)(children, isMobile, selectionQty, ((_c = selectable === null || selectable === void 0 ? void 0 : selectable.selection) === null || _c === void 0 ? void 0 : _c.all) || false, clearSelection, selectAll, selectable === null || selectable === void 0 ? void 0 : selectable.turnOffSelectAll, gridRef);
    const handleOnHidePanel = (0, react_1.useCallback)(() => setSelectMode(false), []);
    const handleOnTriggerClick = (0, react_1.useCallback)(() => setSelectMode(prev => !prev), []);
    const hasPostActions = (0, react_1.useMemo)(() => columnsPopup || (isMobile && selectable) || (!isMobile && fullscreenButton) || isFeedVisible, [columnsPopup, fullscreenButton, isFeedVisible, isMobile, selectable]);
    const hasToolbar = (0, react_1.useMemo)(() => bulkActions || feedSortControl || (pagination && !isMobile) || other.length || columnsPopup || (!isMobile && fullscreenButton) || isFeedVisible, [bulkActions, columnsPopup, feedSortControl, fullscreenButton, isFeedVisible, isMobile, other.length, pagination]);
    const gridAutoHeight = (0, react_1.useMemo)(() => contentHeight ? `${contentHeight}px` : undefined, [contentHeight]);
    const minHeight = "400px";
    const gridHeight = (0, react_1.useMemo)(() => height || gridAutoHeight || minHeight, [gridAutoHeight, height]);
    // TODO: disadvantages?
    const { gridClasses, restClasses } = (0, getGridClasses_1.getGridClasses)(className || "");
    return (0, jsx_runtime_1.jsx)(layoutFullScreen_1.LayoutFullScreen, { className: (0, classNames_1.classNames)([...gridClasses]), children: (0, jsx_runtime_1.jsxs)("div", { style: { height: gridHeight }, className: (0, classNames_1.classNames)(["zen-table-wrapper", hasToolbar ? "zen-table-wrapper--with-toolbar" : "", ...restClasses]), children: [hasToolbar
                    ? (0, jsx_runtime_1.jsxs)(entitiesListActions_1.EntitiesListActions, { gridType: isMobile ? deviceType_1.DeviceType.Mobile : deviceType_1.DeviceType.Desktop, children: [(0, jsx_runtime_1.jsxs)(entitiesListActions_1.EntitiesListActions.Actions, { children: [!isMobile && bulkActions && selectionQty > 0
                                        ? bulkActions
                                        : null, feedSortControl] }), pagination || other.length > 0
                                ? (0, jsx_runtime_1.jsxs)(entitiesListActions_1.EntitiesListActions.Pagination, { children: [(0, jsx_runtime_1.jsx)(entitiesListActions_1.EntitiesListActions.CustomElements, { children: other }), !isMobile ? pagination : null] })
                                : null, hasPostActions
                                ? (0, jsx_runtime_1.jsxs)(entitiesListActions_1.EntitiesListActions.PostActions, { children: [columnsPopup
                                            ? (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)(columnsListButton_1.ColumnsListButton, { ref: columnsPopupRef }), columnsPopup] })
                                            : null, isFeedVisible ? (0, jsx_runtime_1.jsx)(feedExpandControl_1.FeedExpandControl, { isExpanded: isFeedExpanded, onClick: handleExpanded }) : null, isMobile && selectable
                                            ? (0, jsx_runtime_1.jsx)(dataFeedSelectPanel_1.DataFeedSelectPanel, { panelTitle: "Selection panel", buttonTitle: "Bulk select", onTriggerClick: handleOnTriggerClick, isOpen: selectMode, onHidePanel: handleOnHidePanel, children: bulkActions })
                                            : null, !isMobile ? fullscreenButton : null] })
                                : null] })
                    : null, isMobile ? (0, jsx_runtime_1.jsxs)(dataFeed_1.DataFeed, { columns: loadingColumns, feedWrappers: [nestedFeedWrapper, selectableFeedWrapper], entities: loadingEntities, expanded: isFeedExpanded, options: {
                        onFeedEnd: onFeedEnd,
                        visibleColumns
                    }, actions: actions, actionsAsync: actionsAsync, primaryActions: primaryActions, ref: gridRef, rowClassName: rowClassName, expandedRows: expanded, onExpandedChange: onExpandedChange, activePage: activePage, children: [emptyList || (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, {}), footer || (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, {})] }) : (0, jsx_runtime_1.jsxs)(dataGrid_1.DataGrid, { columns: loadingColumns, entities: loadingEntities, ref: gridRef, rowClassName: rowClassName, expandedRows: expanded, onExpandedChange: onExpandedChange, children: [emptyList || (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, {}), footer || (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, {})] })] }) });
};
const Table = (0, react_1.memo)(TableInner);
exports.Table = Table;
Table.Empty = tableEmpty_1.TableEmpty;
Table.Footer = tableFooter_1.TableFooter;
Table.BulkActions = tableBulkActions_1.TableBulkActions;
Table.Pagination = tablePagination_1.TablePagination;
Table.Fullscreen = tableFullscreen_1.TableFullscreen;
Table.BulkButton = bulkActionButton_1.BulkActionButton;
Table.BulkLink = bulkActionLink_1.BulkActionLink;
