"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ActionsMenu = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const button_1 = require("../../button/button");
const iconDotVertical_1 = require("../../icons/iconDotVertical");
const useLanguage_1 = require("../../utils/localization/useLanguage");
const menu_1 = require("../../menu/menu");
const classNames_1 = require("../../commonHelpers/classNames/classNames");
const skeletonList_1 = require("../../skeletonList/skeletonList");
const menuErrorItem_1 = require("../../menu/components/menuErrorItem");
const getMenuItems = (entity, isNested, render, primaryActions) => {
    if (!render && !primaryActions) {
        return null;
    }
    const result = render === null || render === void 0 ? void 0 : render(entity, isNested);
    if (!result) {
        return null;
    }
    if (result.type === menu_1.Menu.Item) {
        return primaryActions ? [...primaryActions.props.children, result] : [result];
    }
    if (!result.props.children) {
        return null;
    }
    const menuItems = ((Array.isArray(result.props.children)
        ? result.props.children
        : [result.props.children]) || []);
    return primaryActions ? [...primaryActions.props.children, ...menuItems] : menuItems;
};
const getErrorItem = (id, onClick) => ((0, jsx_runtime_1.jsx)(menuErrorItem_1.MenuErrorItem, { id: id, onClick: onClick }));
const ActionsMenu = ({ entity, isNested, render, renderAsync, primaryActions }) => {
    var _a;
    const { translate } = (0, useLanguage_1.useLanguage)();
    const generatedId = (0, react_1.useId)();
    const buttonId = `ariaLabelBy-${entity.id || generatedId}`;
    const errorId = `errorItem-${(0, react_1.useId)()}`;
    const ref = (0, react_1.useRef)(null);
    const menuItems = (0, react_1.useMemo)(() => getMenuItems(entity, isNested, render, primaryActions), [entity, isNested, render, primaryActions]);
    const [menuItemsAsync, setMenuItemsAsync] = (0, react_1.useState)(null);
    const [isLoading, setIsLoading] = (0, react_1.useState)(false);
    const [isError, setIsError] = (0, react_1.useState)(false);
    const handleClickTrigger = (0, react_1.useCallback)(async () => {
        var _a;
        if (!renderAsync || isLoading) {
            return;
        }
        const errorItem = getErrorItem(errorId, handleClickTrigger);
        setIsLoading(true);
        setIsError(false);
        setMenuItemsAsync(null);
        try {
            let resolvedMenuItems = await renderAsync(entity, isNested);
            if (primaryActions) {
                resolvedMenuItems = (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, { children: [...primaryActions.props.children, ...resolvedMenuItems.props.children] });
            }
            if (resolvedMenuItems.props.children) {
                setMenuItemsAsync(resolvedMenuItems);
            }
            else {
                setMenuItemsAsync((0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, { children: errorItem }));
                setIsError(true);
            }
        }
        catch (err) {
            setMenuItemsAsync((0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, { children: [((_a = primaryActions === null || primaryActions === void 0 ? void 0 : primaryActions.props) === null || _a === void 0 ? void 0 : _a.children) || null, errorItem] }));
            setIsError(true);
        }
        finally {
            setIsLoading(false);
        }
    }, [entity, isNested, isLoading, primaryActions, errorId, renderAsync]);
    const trigger = (0, react_1.useMemo)(() => {
        if (renderAsync) {
            return (0, jsx_runtime_1.jsx)(button_1.Button, { title: translate("More"), disabled: isLoading, id: buttonId, ref: ref, onClick: handleClickTrigger, type: "tertiary-black", className: (0, classNames_1.classNames)([
                    "zen-caption",
                    "zen-actions-column__action",
                    isError ? "zen-actions-column__action_error" : ""
                ]), children: (0, jsx_runtime_1.jsx)(iconDotVertical_1.IconDotVertical, { size: "bigger" }) });
        }
        return (0, jsx_runtime_1.jsx)(button_1.Button, { type: "tertiary-black", title: translate("More"), className: "zen-caption zen-actions-column__action", children: (0, jsx_runtime_1.jsx)(iconDotVertical_1.IconDotVertical, { size: "bigger" }) });
    }, [buttonId, isLoading, isError, renderAsync, handleClickTrigger, translate]);
    if (renderAsync) {
        const menuItemsToRender = isLoading ?
            (0, jsx_runtime_1.jsx)(skeletonList_1.SkeletonList, { className: "zen-actions-column__waiting" }) :
            ((_a = menuItemsAsync === null || menuItemsAsync === void 0 ? void 0 : menuItemsAsync.props) === null || _a === void 0 ? void 0 : _a.children) || null;
        return (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [trigger, (0, jsx_runtime_1.jsx)(menu_1.Menu, { ariaLabelledBy: buttonId, title: translate("Actions"), triggerRef: ref, alignment: "bottom-right", children: menuItemsToRender })] });
    }
    if (!menuItems || menuItems.length === 0) {
        return null;
    }
    return (0, jsx_runtime_1.jsx)(menu_1.Menu, { title: translate("Actions"), trigger: trigger, alignment: "bottom-right", children: menuItems });
};
exports.ActionsMenu = ActionsMenu;
