"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.NestedData = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const NestedDataInt = ({ entities, children, expandedRows, useChildrenDataHook, maxHooks = 100 }) => {
    // Call hooks in a consistent order - this MUST be at the top level and cannot be wrapped in useEffect
    // eslint-disable-next-line react-hooks/exhaustive-deps
    const hookResults = [];
    for (let i = 0; i < maxHooks; i++) {
        const entity = entities[i];
        // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
        const parentId = entity ? entity.id : `placeholder-${i}`;
        const enabled = expandedRows.includes(parentId);
        // eslint-disable-next-line react-hooks/rules-of-hooks
        const queryResult = useChildrenDataHook(parentId, enabled);
        hookResults[i] = queryResult;
    }
    // Memoize the entities with children calculation to avoid unnecessary re-renders
    const entitiesWithChildren = (0, react_1.useMemo)(() => entities.map((entity, index) => {
        const isExpanded = expandedRows.includes(entity.id);
        if (index < maxHooks) {
            const { data: childrenData, isLoading, error, isError } = hookResults[index];
            if (isLoading || !isExpanded) {
                return Object.assign(Object.assign({}, entity), { children: new Array(3)
                        .fill("")
                        .map((_1, j) => ({ id: `loading-${entity.id}-${j}`, isLoading: true })) });
            }
            if (isError && error) {
                return Object.assign(Object.assign({}, entity), { children: [] });
            }
            if (childrenData) {
                return Object.assign(Object.assign({}, entity), { children: childrenData });
            }
        }
        return entity;
    }), [entities, expandedRows, maxHooks, hookResults]);
    const table = (0, react_1.useMemo)(() => (0, react_1.cloneElement)(children, {
        entities: entitiesWithChildren
    }), [children, entitiesWithChildren]);
    return (0, jsx_runtime_1.jsx)(jsx_runtime_1.Fragment, { children: table });
};
exports.NestedData = (0, react_1.memo)(NestedDataInt);
