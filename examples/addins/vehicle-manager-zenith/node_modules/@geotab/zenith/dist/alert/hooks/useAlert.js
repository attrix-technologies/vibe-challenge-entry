"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useAlert = void 0;
const react_1 = require("react");
const react_2 = require("react");
const feedbackContext_1 = require("../../feedbackContainer/feedbackContext");
const alert_1 = require("../alert");
const useAlertState_1 = require("./useAlertState");
const generateId_1 = require("../../commonHelpers/generateId");
const hideAlertCallback_1 = require("../utils/hideAlertCallback");
const useWarning_1 = require("../../feedbackProvider/hooks/useWarning");
const useAlert = () => {
    const { mode, removeAlert, setApiAlertActions } = (0, react_2.useContext)(feedbackContext_1.FeedbackContext);
    const { alerts, setAlerts, targetEvent } = (0, useAlertState_1.useAlertState)();
    const isAPIMode = mode === "api";
    const hideAlert = (0, react_2.useCallback)(function (id) {
        setAlerts((prevAlerts) => [...prevAlerts.filter((el) => el.id !== id)]);
        removeAlert(id);
        if (isAPIMode) {
            setApiAlertActions((prev) => [...prev.filter((el) => el.id !== id)]);
        }
    }, [isAPIMode, removeAlert, setAlerts, setApiAlertActions]);
    const showAlert = (0, react_2.useCallback)((newItem) => {
        const generatedId = (0, generateId_1.generateId)();
        const alertItem = Object.assign(Object.assign({}, newItem), { id: generatedId });
        setAlerts((prev) => [...prev, alertItem]);
        return {
            id: generatedId,
            hideAlert: () => {
                targetEvent.current.dispatchEvent(new CustomEvent("hideAlert", { detail: { id: generatedId } }));
            }
        };
    }, [setAlerts, targetEvent]);
    (0, react_2.useEffect)(() => {
        const callback = (event) => (0, hideAlertCallback_1.hideAlertCallback)(event, hideAlert);
        targetEvent.current.addEventListener("hideAlert", callback);
        // eslint-disable-next-line react-hooks/exhaustive-deps
        return () => targetEvent.current.removeEventListener("hideAlert", callback);
    }, [hideAlert, isAPIMode, targetEvent]);
    const shownAlerts = (0, react_2.useMemo)(() => alerts.map((item) => (0, react_1.createElement)(alert_1.Alert, Object.assign({}, item, { onClose: () => hideAlert(item.id), key: item.id, isOpen: true }))), [alerts, hideAlert]);
    (0, useWarning_1.useWarning)({ mode, name: "alerts" });
    return {
        showAlert,
        alerts: shownAlerts
    };
};
exports.useAlert = useAlert;
