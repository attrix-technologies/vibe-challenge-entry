"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Tabs = exports.TabsDisplayName = void 0;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
const classNames_1 = require("../commonHelpers/classNames/classNames");
const useDriveClassName_1 = require("../utils/theme/useDriveClassName");
const useLanguage_1 = require("../utils/localization/useLanguage");
const tabItem_1 = require("./tabItem/tabItem");
const iconChevronRight_1 = require("../icons/iconChevronRight");
const textIconButton_1 = require("../textIconButton/textIconButton");
const tabsKeyboard_1 = require("../commonHelpers/tabsKeyboard");
exports.TabsDisplayName = "Tabs";
const getScrollButtonType = (element) => {
    const scrollLeft = element.scrollLeft;
    const scrollWidth = element.scrollWidth;
    const clientWidth = element.clientWidth;
    if (scrollLeft === 0 && scrollWidth === clientWidth) {
        return "";
    }
    if (scrollLeft > 0 && (scrollWidth > clientWidth + scrollLeft + 1)) {
        return "both";
    }
    if (scrollLeft === 0) {
        return "end";
    }
    return "start";
};
const Tabs = ({ className, tabs = [], activeTabId, onTabChange }) => {
    const driveClassname = (0, useDriveClassName_1.useDriveClassName)("zen-tabs");
    const scrollableStep = 200;
    const { translate } = (0, useLanguage_1.useLanguage)();
    const driveClassNameScroller = (0, useDriveClassName_1.useDriveClassName)("zen-tabs__scroller");
    const driveClassNameGradient = (0, useDriveClassName_1.useDriveClassName)("zen-tabs__gradient");
    const [scrollButtonType, setScrollButtonType] = (0, react_1.useState)("");
    const scrollableRef = (0, react_1.useRef)(null);
    const scrollRef = (0, react_1.useRef)(0);
    const focusableTabIdRef = (0, react_1.useRef)("");
    const handleButtonClick = (e) => {
        const newState = e.currentTarget.id;
        focusableTabIdRef.current = newState;
        if (newState !== activeTabId) {
            onTabChange(newState);
        }
    };
    const keyDownHandler = (0, react_1.useCallback)((e) => {
        var _a;
        if (e.key === "Shift") {
            return;
        }
        if (e.key === "Enter" || e.key === " ") {
            const target = e.target;
            // eslint-disable-next-line @typescript-eslint/no-unnecessary-condition
            if (target && target.id && tabs.some(tab => tab.id === target.id)) {
                focusableTabIdRef.current = target.id;
                onTabChange(target.id);
            }
            return;
        }
        if (e.key === "Tab") {
            const nextTabId = (0, tabsKeyboard_1.tabsKeyboardTabHandler)(e, tabs, document.activeElement);
            if (nextTabId) {
                focusableTabIdRef.current = nextTabId;
            }
            return;
        }
        const newActiveTabId = (0, tabsKeyboard_1.tabsKeyboardHandler)(e, tabs, focusableTabIdRef.current) || activeTabId;
        focusableTabIdRef.current = newActiveTabId;
        const focusableTab = (_a = scrollableRef.current) === null || _a === void 0 ? void 0 : _a.querySelector(`.zen-tab-item[id='${newActiveTabId}']`);
        focusableTab === null || focusableTab === void 0 ? void 0 : focusableTab.focus();
    }, [tabs, activeTabId, onTabChange]);
    (0, react_1.useEffect)(() => {
        if (!scrollableRef.current) {
            return () => { };
        }
        let timer = undefined;
        const resizeHandler = () => {
            const scrollableElt = scrollableRef.current;
            if (scrollableElt) {
                timer && window.clearTimeout(timer);
                timer = window.setTimeout(() => {
                    setScrollButtonType(getScrollButtonType(scrollableElt));
                }, 200);
            }
        };
        const scrollableElement = scrollableRef.current;
        scrollableElement.addEventListener("scroll", resizeHandler);
        window.addEventListener("resize", resizeHandler);
        resizeHandler();
        return () => {
            timer && window.clearTimeout(timer);
            scrollableElement.removeEventListener("scroll", resizeHandler);
            window.removeEventListener("resize", resizeHandler);
        };
    }, [scrollableRef]);
    (0, react_1.useEffect)(() => {
        if (scrollableRef.current) {
            setScrollButtonType(getScrollButtonType(scrollableRef.current));
        }
    }, [scrollableRef, tabs, activeTabId]);
    const handleScrollButtonClick = (0, react_1.useCallback)((scrollableElt, delta) => () => {
        if (scrollableElt) {
            let iterations = 0;
            const maxIterations = 100;
            const start = scrollableElt.scrollLeft;
            const end = start + delta;
            const duration = 300;
            const animateScroll = (timestamp) => {
                if (!scrollRef.current) {
                    scrollRef.current = timestamp;
                }
                const progress = Math.min((timestamp - scrollRef.current) / duration, 1);
                scrollableElt.scrollLeft = start + (end - start) * progress;
                if (progress < 1 && iterations < maxIterations) {
                    iterations++;
                    window.requestAnimationFrame(animateScroll);
                }
                else {
                    scrollRef.current = 0;
                }
            };
            window.requestAnimationFrame(animateScroll);
        }
    }, []);
    (0, react_1.useEffect)(() => {
        if (!scrollableRef.current || !activeTabId) {
            return;
        }
        const activeTab = scrollableRef.current.querySelector(`.zen-tab-item[id='${activeTabId}']`);
        if (activeTab instanceof HTMLElement) {
            focusableTabIdRef.current = activeTab.getAttribute("id") || "";
            // activeTab.focus();
        }
    }, [activeTabId]);
    return (0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)(["zen-tabs", driveClassname || "", className !== null && className !== void 0 ? className : ""]), children: (0, jsx_runtime_1.jsxs)("div", { className: (0, classNames_1.classNames)(["zen-tabs__tabs-container", className !== null && className !== void 0 ? className : "", scrollButtonType]), children: [scrollButtonType === "start" || scrollButtonType === "both" ? (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)(["zen-tabs__gradient", driveClassNameGradient || "", "zen-tabs__gradient--left"]) }), (0, jsx_runtime_1.jsx)(textIconButton_1.TextIconButton, { title: translate("Scroll left"), className: (0, classNames_1.classNames)(["zen-tabs__scroller", driveClassNameScroller || "", "zen-tabs__start"]), icon: iconChevronRight_1.IconChevronRight, type: "tertiary", iconPosition: textIconButton_1.ButtonIconPosition.Start, onClick: handleScrollButtonClick(scrollableRef.current, -scrollableStep), iconClasses: "zen-tabs__start-icon" })] }) : null, (0, jsx_runtime_1.jsx)("div", { ref: scrollableRef, onKeyDown: keyDownHandler, className: "zen-tabs__scrollable", children: (0, jsx_runtime_1.jsx)("div", { className: "zen-tabs__tabs", role: "tablist", children: tabs.map(tab => ((0, jsx_runtime_1.jsx)(tabItem_1.TabItem, { className: "zen-tabs__tab-item", tabId: tab.id, tabName: tab.name, icon: typeof tab.icon === "function" ? (0, react_1.createElement)(tab.icon, { size: "large" }) : tab.icon, active: activeTabId === tab.id, ariaControl: `panel-${tab.id}`, handleButtonClick: handleButtonClick }, tab.id))) }) }), scrollButtonType === "end" || scrollButtonType === "both" ? (0, jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment, { children: [(0, jsx_runtime_1.jsx)("div", { className: (0, classNames_1.classNames)(["zen-tabs__gradient", driveClassNameGradient || "", "zen-tabs__gradient--right"]) }), (0, jsx_runtime_1.jsx)(textIconButton_1.TextIconButton, { title: translate("Scroll right"), className: (0, classNames_1.classNames)(["zen-tabs__scroller", driveClassNameScroller || "", "zen-tabs__end"]), icon: iconChevronRight_1.IconChevronRight, type: "tertiary", onClick: handleScrollButtonClick(scrollableRef.current, scrollableStep), iconPosition: textIconButton_1.ButtonIconPosition.End })] }) : null] }) });
};
exports.Tabs = Tabs;
exports.Tabs.displayName = exports.TabsDisplayName;
