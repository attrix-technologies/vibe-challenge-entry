"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.useFeedbackAlert = void 0;
const react_1 = require("react");
const useMobile_1 = require("../../commonHelpers/hooks/useMobile");
const react_2 = require("react");
const useFeedbackAlertState_1 = require("./useFeedbackAlertState");
const addZenithAlert_1 = require("../utils/addZenithAlert");
const removeZenithAlert_1 = require("../utils/removeZenithAlert");
const getParentWindow_1 = require("../../utils/getParentWindow");
const ALERTS_MAX_NUMBER_DESKTOP = 3;
const ALERTS_MAX_NUMBER_MOBILE = 4;
const useFeedbackAlert = ({ setActiveFeedback, mode }) => {
    const isMobile = (0, useMobile_1.useMobile)();
    const { alerts, setAlerts, alertsQueue, setAlertsQueue, alertsAnimation, setAlertsAnimation, removedAlertId, apiAlertActions, setApiAlertActions } = (0, useFeedbackAlertState_1.useFeedbackAlertState)();
    const isAPIMode = mode === "api";
    const topView = (0, getParentWindow_1.getParentWindow)(window) || window;
    const alertsMaxNumber = isMobile ? ALERTS_MAX_NUMBER_MOBILE : ALERTS_MAX_NUMBER_DESKTOP;
    const removeAlert = (0, react_2.useCallback)((id, important) => {
        if (isAPIMode) {
            if (!apiAlertActions.find(el => el.id === id)) {
                return;
            }
            setApiAlertActions((prevAlerts) => prevAlerts.filter((el) => el.id !== id));
            topView.dispatchEvent(new CustomEvent("removeZenithAlert", { detail: id }));
            return;
        }
        const renderedAlert = alerts.find((alert) => alert.id === id);
        if (!renderedAlert) {
            return;
        }
        // "remove" animation
        setAlerts((prevAlerts) => {
            const alertIndex = prevAlerts.findIndex((alert) => alert.id === id);
            if (alertIndex === -1) {
                return prevAlerts;
            }
            // TODO
            prevAlerts[alertIndex].animation = "left-right";
            return [...prevAlerts];
        });
        if (important) {
            setAlertsQueue((prevAlerts) => [{ value: renderedAlert, action: "remove", id }, ...prevAlerts]);
        }
        else {
            setAlertsQueue((prevAlerts) => [...prevAlerts, { value: renderedAlert, action: "remove", id }]);
        }
        // TODO: check it
        setActiveFeedback("alert");
    }, [isAPIMode, alerts, setAlerts, setAlertsQueue, setActiveFeedback, apiAlertActions, setApiAlertActions, topView]);
    const addAlert = (0, react_2.useCallback)((alert) => {
        if (isAPIMode) {
            if (apiAlertActions.find(el => el.id === alert.id)) {
                return;
            }
            setApiAlertActions((prevAlerts) => [...prevAlerts, { value: alert, action: "add", id: alert.id }]);
            topView.dispatchEvent(new CustomEvent("addZenithAlert", { detail: alert }));
            return;
        }
        setAlertsQueue((prevAlerts) => [...prevAlerts, { value: alert, action: "add", id: alert.id }]);
        setActiveFeedback("alert");
    }, [isAPIMode, setAlertsQueue, setActiveFeedback, apiAlertActions, setApiAlertActions, topView]);
    const startAlertAnimation = (0, react_2.useCallback)(alertId => {
        if (!alertId) {
            return;
        }
        setAlertsAnimation((prevAnimations) => {
            const alertAnimation = prevAnimations.find((animation) => animation.id === alertId);
            if (!alertAnimation) {
                return prevAnimations;
            }
            alertAnimation.isFinished = false;
            return [...prevAnimations];
        });
    }, [setAlertsAnimation]);
    const finishAlertAnimation = (0, react_2.useCallback)((alertId) => {
        setAlertsAnimation((prevAnimations) => {
            const alertAnimation = prevAnimations.find((animation) => animation.id === alertId);
            if (!alertAnimation) {
                return prevAnimations;
            }
            alertAnimation.isFinished = true;
            return [...prevAnimations];
        });
    }, [setAlertsAnimation]);
    (0, react_1.useEffect)(() => {
        if (mode === "default") {
            const addZenithAlertCallback = (event) => (0, addZenithAlert_1.addZenithAlert)(event, addAlert);
            // TODO: simplify it
            const removeZenithAlertCallback = (event) => {
                const id = event.detail;
                if (!id) {
                    return;
                }
                (0, removeZenithAlert_1.removeZenithAlert)(event, removeAlert);
                removedAlertId.current = alerts.findIndex((alert) => alert.id === id);
            };
            topView.addEventListener("addZenithAlert", addZenithAlertCallback);
            topView.addEventListener("removeZenithAlert", removeZenithAlertCallback);
            return () => {
                topView.removeEventListener("addZenithAlert", addZenithAlertCallback);
                topView.removeEventListener("removeZenithAlert", removeZenithAlertCallback);
            };
        }
        return () => { };
    }, [mode, addAlert, topView, removeAlert, removedAlertId, alerts.length, alerts]);
    const hasAllActionsHasAnimations = (0, react_2.useCallback)(() => alertsQueue.map(el => el.id).every(el => alertsAnimation.find(animation => animation.id === el)), [alertsQueue, alertsAnimation]);
    const findAllNotAnimatedActions = (0, react_2.useCallback)(() => alertsQueue.filter(el => !alertsAnimation.find(animation => animation.id === el.id), [alertsQueue, alertsAnimation]), [alertsAnimation, alertsQueue]);
    (0, react_1.useEffect)(() => {
        if (!hasAllActionsHasAnimations()) {
            const notAnimatedActions = findAllNotAnimatedActions();
            setAlertsAnimation((prevAnimations) => {
                const newAnimations = notAnimatedActions.map((action) => {
                    if (action.action === "add") {
                        return { id: action.id, isFinished: null };
                    }
                    return ({ id: action.id, isFinished: false });
                });
                return [...prevAnimations, ...newAnimations];
            });
            return;
        }
        const notFinishedAnimations = alertsAnimation.filter(animation => animation.isFinished === false);
        // wait until all animations are finished
        if (notFinishedAnimations.length) {
            return;
        }
        if (alerts.length > alertsMaxNumber) {
            const finishedAnimations = alertsAnimation.filter(animation => animation.isFinished === true);
            const lastAlert = alerts[alerts.length - 1];
            const lastAlertAnimation = finishedAnimations.find((animation) => animation.id === lastAlert.id);
            if (!lastAlertAnimation) {
                removedAlertId.current = alerts.length - 1;
                finishAlertAnimation(lastAlert.id);
                removeAlert(lastAlert.id, true);
                // TODO: check it
                lastAlert.onClose();
                return;
            }
        }
        if (alertsQueue.length) {
            const alertQueueItem = alertsQueue[0];
            const animation = alertsAnimation.find((alertAnimation) => alertAnimation.id === alertQueueItem.id);
            if (alertQueueItem.action === "add") {
                if (animation && alertsQueue.length > 1) {
                    setAlertsAnimation((prevAnimations) => {
                        const alertAnimation = prevAnimations.find((an) => an.id === alertQueueItem.id);
                        if (!alertAnimation) {
                            return prevAnimations;
                        }
                        alertAnimation.isFinished = false;
                        return [...prevAnimations];
                    });
                }
                setAlerts((prevAlerts) => [alertQueueItem.value, ...prevAlerts]);
                setAlertsQueue((prevAlerts) => prevAlerts.filter((alert) => alert.id !== alertQueueItem.id));
                return;
            }
            const removedAlertsQueue = alertsQueue.filter((alert) => alert.action === "remove");
            const finishedAnimations = alertsAnimation.filter(el => el.isFinished === true);
            if (removedAlertsQueue.length && finishedAnimations.length) {
                removedAlertsQueue.forEach((alert) => {
                    const alertAnimation = finishedAnimations.find((el) => el.id === alert.id);
                    if (!alertAnimation) {
                        return;
                    }
                    setAlerts((prevAlerts) => prevAlerts.filter((el) => el.id !== alert.id));
                    setAlertsQueue((prevAlerts) => prevAlerts.filter((el) => el.id !== alert.id));
                    setAlertsAnimation((prevAnimations) => prevAnimations.filter((el) => el.id !== alert.id));
                });
            }
        }
        if (alerts.length && alertsAnimation.length) {
            const finishedAnimations = alertsAnimation.filter(animation => animation.isFinished === true);
            if (!finishedAnimations.length) {
                return;
            }
            const renderedAlertsIds = alerts.filter((alert) => finishedAnimations.some((animation) => animation.id === alert.id)).map((alert) => alert.id);
            if (renderedAlertsIds.length) {
                setAlertsAnimation((prevAnimations) => prevAnimations.filter((alertAnimation) => !renderedAlertsIds.includes(alertAnimation.id)));
            }
        }
    }, [
        alertsQueue,
        alertsAnimation,
        alerts,
        removeAlert,
        alertsMaxNumber,
        removedAlertId,
        setAlerts,
        setAlertsQueue,
        setAlertsAnimation,
        finishAlertAnimation,
        hasAllActionsHasAnimations,
        findAllNotAnimatedActions
    ]);
    return { alerts, alertsAnimation, removedAlertId, alertsQueue, addAlert, removeAlert, startAlertAnimation, finishAlertAnimation, apiAlertActions, setApiAlertActions };
};
exports.useFeedbackAlert = useFeedbackAlert;
