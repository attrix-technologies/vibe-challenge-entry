{
  "name": "Ace vs API Comparison",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "2.3",
  "items": [
    {
      "url": "page.html",
      "path": "ActivityLink",
      "menuName": {
        "en": "Ace vs API Comparison"
      }
    }
  ],
  "files": {
    "page.html": "<!DOCTYPE html>\n<html>\n<head>\n    <meta charset='utf-8'>\n    <meta name='viewport' content='width=device-width, initial-scale=1'>\n    <title>Ace vs API Comparison v2.3</title>\n</head>\n<body class='bg-light p-4'>\n    <div class='container'>\n        <h1 class='mb-1'>Ace vs Direct API Comparison v2.3</h1>\n        <p class='text-muted mb-4'>Three tests demonstrating when to use each approach</p>\n        \n        <div class='alert alert-warning mb-4' role='alert' style='color:#78350f;'>\n            <strong>Note:</strong> Ace queries start 8s apart to avoid rate limits. API has a 5000 result limit per call.\n        </div>\n\n        <!-- Test 1: Speed -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>1️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Speed Test</h5>\n                    <small class='text-muted'>Same question, timing comparison</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: api.call('Get', {typeName: 'Device'}), count results</code><br>\n                    <em style='color:#92400e;'>Ace: \"How many vehicles are in my fleet? Return as JSON with key 'count'.\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>DIRECT API</small>\n                            <div class='fs-3 fw-bold text-success' id='t1-api-status'>Waiting...</div>\n                            <small class='text-muted' id='t1-api-time'>--</small>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t1-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Natural Language)</small>\n                            <div class='fs-3 fw-bold' style='color:#b45309;' id='t1-ace-status'>Queued...</div>\n                            <small class='text-muted' id='t1-ace-time'>--</small>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 small overflow-auto' style='max-height:200px;font-size:10px;' id='t1-debug'></pre>\n            </div>\n        </div>\n\n        <!-- Test 2: Freshness -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>2️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Freshness Test</h5>\n                    <small class='text-muted'>Ace data can be hours behind real-time</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: Get Trip (last 30 days), sort by stop time</code><br>\n                    <em style='color:#92400e;'>Ace: \"Most recent trip? Return JSON: device_name, end_time.\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>API (Real-time)</small>\n                            <div id='t2-api-result' class='fw-bold' style='font-size:14px;'>Waiting...</div>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t2-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Natural Language)</small>\n                            <div id='t2-ace-result' class='fw-bold' style='font-size:14px;color:#b45309;'>Queued...</div>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 small overflow-auto' style='max-height:200px;font-size:10px;' id='t2-debug'></pre>\n                <div id='t2-comparison' class='mt-2 p-2 rounded text-center d-none' style='background:#fef3c7;border:2px dashed #f59e0b;'></div>\n            </div>\n        </div>\n\n        <!-- Test 3: Complex Analysis -->\n        <div class='card mb-3'>\n            <div class='card-header d-flex align-items-center'>\n                <span class='fs-4 me-2'>3️⃣</span>\n                <div>\n                    <h5 class='mb-0'>Complex Analysis</h5>\n                    <small class='text-muted'>Per-device trip queries vs Ace aggregate</small>\n                </div>\n            </div>\n            <div class='card-body'>\n                <div class='alert alert-info py-2 mb-3'>\n                    <small class='fw-bold'>QUESTIONS ASKED</small><br>\n                    <code class='text-success'>API: For each device, Get Trip with deviceSearch:{id:xxx}, sum distances</code><br>\n                    <em style='color:#92400e;'>Ace: \"Top 3 vehicles by distance (30 days). Return JSON array: device_name, miles.\"</em>\n                </div>\n                <div class='row'>\n                    <div class='col-6'>\n                        <div class='bg-success-subtle border border-success rounded p-3'>\n                            <small class='fw-bold text-success'>API (Per-Device Queries)</small>\n                            <div class='fs-4 fw-bold text-success' id='t3-api-status'>Waiting...</div>\n                            <small class='text-muted' id='t3-api-time'>--</small>\n                        </div>\n                    </div>\n                    <div class='col-6'>\n                        <div class='bg-warning-subtle border border-warning rounded p-3' id='t3-ace-box'>\n                            <small class='fw-bold' style='color:#92400e;'>ACE (Natural Language)</small>\n                            <div class='fs-4 fw-bold' style='color:#b45309;' id='t3-ace-status'>Queued...</div>\n                            <small class='text-muted' id='t3-ace-time'>--</small>\n                        </div>\n                    </div>\n                </div>\n                <pre class='bg-success-subtle border border-success p-2 rounded mt-2 overflow-auto' style='max-height:150px;font-size:10px;' id='t3-api-result'></pre>\n                <pre class='bg-warning-subtle border border-warning p-2 rounded mt-2 overflow-auto' style='max-height:200px;font-size:10px;color:#78350f;' id='t3-ace-result'></pre>\n                <pre class='bg-secondary-subtle p-2 rounded mt-2 overflow-auto' style='max-height:150px;font-size:10px;' id='t3-debug'></pre>\n            </div>\n        </div>\n\n        <!-- Activity Log -->\n        <div class='card mb-3'>\n            <div class='card-header'><h5 class='mb-0'>Activity Log</h5></div>\n            <div class='card-body'>\n                <div class='bg-light p-2 rounded overflow-auto' style='max-height:200px;font-size:10px;font-family:monospace;' id='log'></div>\n            </div>\n        </div>\n\n        <!-- Key Takeaways -->\n        <div class='card bg-primary-subtle border-primary'>\n            <div class='card-header bg-primary text-white'><h5 class='mb-0'>Key Takeaways</h5></div>\n            <div class='card-body'>\n                <div class='row'>\n                    <div class='col-md-4'>\n                        <strong class='text-success'>Direct API</strong>\n                        <ul class='small mb-0'>\n                            <li>~300-500ms response</li>\n                            <li>Real-time data</li>\n                            <li>Raw data (you aggregate)</li>\n                            <li>5000 result limit per call</li>\n                        </ul>\n                    </div>\n                    <div class='col-md-4'>\n                        <strong style='color:#b45309;'>Ace AI</strong>\n                        <ul class='small mb-0'>\n                            <li>~30-90 sec response</li>\n                            <li>Can be hours behind</li>\n                            <li>Natural language queries</li>\n                            <li>Can aggregate across all data</li>\n                        </ul>\n                    </div>\n                    <div class='col-md-4'>\n                        <strong class='text-primary'>When to Use</strong>\n                        <ul class='small mb-0'>\n                            <li>API: live data, writes, speed</li>\n                            <li>Ace: trends, insights, NL queries</li>\n                        </ul>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // ============================================\n        // LOAD BOOTSTRAP CSS DYNAMICALLY\n        // ============================================\n        (function() {\n            var link = document.createElement('link');\n            link.rel = 'stylesheet';\n            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css';\n            document.head.appendChild(link);\n            console.log('[INIT] Bootstrap CSS loaded dynamically');\n        })();\n\n        // ============================================\n        // CONFIGURATION\n        // ============================================\n        var ACE_STAGGER_DELAY = 8000;  // 8 seconds between starting Ace queries (avoid rate limits)\n        var ACE_CREATE_CHAT_RETRIES = 3;  // Retry create-chat up to 3 times\n        var ACE_RETRY_DELAY = 3000;  // Wait 3s between retries\n        var ACE_INITIAL_POLL_DELAY = 8000; // Wait 8s before first poll\n        var ACE_POLL_INTERVAL = 5000;  // Poll every 5s\n        var ACE_MAX_POLL_ATTEMPTS = 30; // Max polling attempts\n        var deviceCache = {};\n        var test2ApiTimestamp = null;  // Store API's most recent trip time for comparison\n\n        console.log('================================================');\n        console.log('Ace vs API Comparison v2.3 initializing');\n        console.log('================================================');\n\n        // ============================================\n        // LOGGING UTILITIES\n        // ============================================\n        function log(m) {\n            var d = document.getElementById('log');\n            var t = new Date().toLocaleTimeString();\n            var entry = '[' + t + '] ' + m;\n            d.innerHTML = '<div>' + entry + '</div>' + d.innerHTML;\n            console.log('[LOG] ' + entry);\n        }\n\n        function debug(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n            console.log('[DEBUG:' + id + '] ' + m);\n        }\n\n        function result(id, m) {\n            var d = document.getElementById(id);\n            if (d) d.textContent += m + '\\n';\n            console.log('[RESULT:' + id + '] ' + m);\n        }\n\n        function getAceData(r) {\n            if (r && r.apiResult && r.apiResult.results) {\n                return r.apiResult.results[0] || {};\n            }\n            return r || {};\n        }\n\n        // ============================================\n        // GEOTAB ADD-IN REGISTRATION\n        // ============================================\n        geotab.addin['ace-api-comparison'] = function() {\n            return {\n                initialize: function(api, state, callback) {\n                    console.log('[INIT] ========== STARTING ==========');\n                    log('Add-in v2.3 initialized');\n                    log('Step 1: Loading device cache...');\n                    \n                    api.call('Get', { typeName: 'Device' }, function(devices) {\n                        console.log('[INIT] Loaded', devices.length, 'devices into cache');\n                        devices.forEach(function(d) {\n                            deviceCache[d.id] = d.name || d.id;\n                        });\n                        log('Cached ' + devices.length + ' device names' + (devices.length >= 5000 ? ' (API LIMIT)' : ''));\n                        \n                        log('Step 2: Running API tests (immediate)...');\n                        runTest1Api(api);\n                        runTest2Api(api);\n                        runTest3Api(api);\n                        \n                        log('Step 3: Starting Ace queries (8s apart)...');\n                        \n                        setTimeout(function() {\n                            log('Ace Test 1 starting');\n                            document.getElementById('t1-ace-status').textContent = 'Processing...';\n                            runTest1Ace(api);\n                        }, 100);\n                        \n                        setTimeout(function() {\n                            log('Ace Test 2 starting');\n                            document.getElementById('t2-ace-result').textContent = 'Processing...';\n                            runTest2Ace(api);\n                        }, ACE_STAGGER_DELAY);\n                        \n                        setTimeout(function() {\n                            log('Ace Test 3 starting');\n                            document.getElementById('t3-ace-status').textContent = 'Processing...';\n                            runTest3Ace(api);\n                        }, ACE_STAGGER_DELAY * 2);\n                        \n                    }, function(e) {\n                        console.error('[INIT] Failed to load devices:', e);\n                        log('ERROR: Failed to load device cache');\n                    });\n                    \n                    callback();\n                },\n                focus: function() {},\n                blur: function() {}\n            };\n        };\n\n        // ============================================\n        // TEST 1: SPEED COMPARISON\n        // ============================================\n        function runTest1Api(api) {\n            var start = Date.now();\n            document.getElementById('t1-api-status').textContent = 'Fetching...';\n\n            api.call('Get', { typeName: 'Device' }, function(devices) {\n                var elapsed = Date.now() - start;\n                var limitNote = devices.length >= 5000 ? ' (limit)' : '';\n                \n                document.getElementById('t1-api-status').textContent = devices.length + ' devices' + limitNote;\n                document.getElementById('t1-api-time').textContent = elapsed + 'ms';\n                debug('t1-debug', 'API returned ' + devices.length + ' Device objects in ' + elapsed + 'ms');\n                if (devices.length >= 5000) debug('t1-debug', 'NOTE: Hit 5000 result limit!');\n                log('Test1 API: ' + devices.length + ' devices in ' + elapsed + 'ms');\n            }, function(e) {\n                document.getElementById('t1-api-status').textContent = 'Error';\n                debug('t1-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        function runTest1Ace(api) {\n            var question = 'How many vehicles are in my fleet? Return result as JSON with key \"count\".';\n            var start = Date.now();\n            \n            aceQuery(api, question, 't1', function(res) {\n                var elapsed = Date.now() - start;\n                \n                debug('t1-debug', '---');\n                debug('t1-debug', 'Ace completed in ' + Math.round(elapsed/1000) + 's');\n                debug('t1-debug', 'RAW DATA: ' + JSON.stringify(res.data, null, 2));\n                debug('t1-debug', 'RAW MESSAGES: ' + JSON.stringify(res.rawMessages, null, 2));\n                if (res.reasoning) debug('t1-debug', 'REASONING: ' + res.reasoning);\n\n                var count = '--';\n                if (res.data && res.data[0]) {\n                    var row = res.data[0];\n                    // Try various key names\n                    count = row.count || row.Count || row.vehicle_count || row.VehicleCount ||\n                            row.NumberOfActiveVehicles || row.NumberOfVehicles || row.total ||\n                            row[Object.keys(row)[0]] || '--';\n                    debug('t1-debug', 'Extracted count: ' + count + ' from keys: ' + Object.keys(row).join(', '));\n                }\n                document.getElementById('t1-ace-status').textContent = count + ' vehicles';\n                document.getElementById('t1-ace-time').textContent = Math.round(elapsed / 1000) + 's';\n                log('Test1 Ace: ' + count + ' in ' + Math.round(elapsed/1000) + 's');\n            }, function(e) {\n                document.getElementById('t1-ace-status').textContent = 'Error';\n                debug('t1-debug', 'Ace ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // TEST 2: FRESHNESS COMPARISON\n        // ============================================\n        function formatTimestamp(date) {\n            var y = date.getFullYear();\n            var m = String(date.getMonth() + 1).padStart(2, '0');\n            var d = String(date.getDate()).padStart(2, '0');\n            var h = String(date.getHours()).padStart(2, '0');\n            var min = String(date.getMinutes()).padStart(2, '0');\n            return y + '-' + m + '-' + d + ' ' + h + ':' + min;\n        }\n\n        function runTest2Api(api) {\n            document.getElementById('t2-api-result').textContent = 'Fetching...';\n            \n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            \n            debug('t2-debug', 'API query: Trips from ' + fromDate.toISOString().split('T')[0]);\n\n            api.call('Get', {\n                typeName: 'Trip',\n                search: {\n                    fromDate: fromDate.toISOString(),\n                    toDate: now.toISOString()\n                }\n            }, function(trips) {\n                debug('t2-debug', 'API returned ' + trips.length + ' trips' + (trips.length >= 5000 ? ' (LIMIT!)' : ''));\n\n                if (trips && trips.length > 0) {\n                    trips.sort(function(a, b) {\n                        return new Date(b.stop) - new Date(a.stop);\n                    });\n                    var t = trips[0];\n                    var stopTime = new Date(t.stop);\n                    test2ApiTimestamp = stopTime;\n                    var deviceName = deviceCache[t.device.id] || t.device.id;\n                    var formattedTime = formatTimestamp(stopTime);\n\n                    debug('t2-debug', 'Most recent: ' + deviceName + ' at ' + formattedTime);\n                    \n                    document.getElementById('t2-api-result').innerHTML =\n                        '<small>' + deviceName + '</small><br>' +\n                        '<span class=\"text-success fw-bold\">' + formattedTime + '</span>';\n                } else {\n                    document.getElementById('t2-api-result').textContent = 'No trips found';\n                }\n                log('Test2 API: ' + trips.length + ' trips analyzed');\n            }, function(e) {\n                document.getElementById('t2-api-result').textContent = 'Error';\n                debug('t2-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n\n        function runTest2Ace(api) {\n            var question = 'What is the most recent trip in my fleet? Return JSON with keys: device_name, end_time.';\n            \n            aceQuery(api, question, 't2', function(res) {\n                debug('t2-debug', '---');\n                debug('t2-debug', 'RAW DATA: ' + JSON.stringify(res.data, null, 2));\n                debug('t2-debug', 'RAW MESSAGES: ' + JSON.stringify(res.rawMessages, null, 2));\n                if (res.reasoning) debug('t2-debug', 'REASONING: ' + res.reasoning);\n\n                if (res.data && res.data[0]) {\n                    var d = res.data[0];\n                    var name = d.device_name || d.DeviceName || d.vehicleName || d.name || 'Unknown';\n                    var timeStr = d.end_time || d.TripEndDateTime || d.endTime || d.stop || 'Unknown';\n                    \n                    // Parse Ace timestamp as UTC\n                    var utcTimeStr = timeStr;\n                    if (timeStr && typeof timeStr === 'string' && !timeStr.endsWith('Z') && !timeStr.includes('+')) {\n                        utcTimeStr = timeStr.replace(' ', 'T') + 'Z';\n                    }\n                    var aceTime = new Date(utcTimeStr);\n                    var formattedAceTime = isNaN(aceTime.getTime()) ? timeStr : formatTimestamp(aceTime);\n                    \n                    document.getElementById('t2-ace-result').innerHTML =\n                        '<small>' + name + '</small><br>' +\n                        '<span style=\"color:#b45309;\" class=\"fw-bold\">' + formattedAceTime + '</span>';\n                    \n                    // Show comparison\n                    if (test2ApiTimestamp && !isNaN(aceTime.getTime())) {\n                        var diffMs = test2ApiTimestamp.getTime() - aceTime.getTime();\n                        var diffMins = Math.round(diffMs / (1000 * 60));\n                        var diffHours = Math.round(diffMs / (1000 * 60 * 60));\n                        var diffStr = diffMins < 60 ? diffMins + ' minutes' : (diffHours < 24 ? diffHours + ' hours' : Math.round(diffHours / 24) + ' days');\n                        \n                        var compBox = document.getElementById('t2-comparison');\n                        compBox.classList.remove('d-none');\n                        if (diffMs > 0) {\n                            compBox.innerHTML = '<strong style=\"color:#dc2626;\">Ace data is ' + diffStr + ' behind API</strong>';\n                        } else if (diffMs < 0) {\n                            compBox.innerHTML = '<strong style=\"color:#059669;\">Ace shows newer data (' + Math.abs(diffMins) + ' min)</strong>';\n                        } else {\n                            compBox.innerHTML = '<strong style=\"color:#059669;\">Timestamps match!</strong>';\n                        }\n                        log('Test2: Ace is ' + diffStr + ' behind API');\n                    }\n                } else {\n                    // No data array - show reasoning if available\n                    if (res.reasoning) {\n                        document.getElementById('t2-ace-result').innerHTML = '<small style=\"color:#78350f;\">No table data. Reasoning:</small><br>' + res.reasoning.substring(0, 150) + '...';\n                    } else {\n                        document.getElementById('t2-ace-result').textContent = 'No data returned';\n                    }\n                }\n                log('Test2 Ace: completed');\n            }, function(e) {\n                document.getElementById('t2-ace-result').textContent = 'Error';\n                debug('t2-debug', 'Ace ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // TEST 3: COMPLEX ANALYSIS COMPARISON\n        // ============================================\n        function runTest3Api(api) {\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            \n            debug('t3-debug', 'API: Per-device trips from ' + fromDate.toISOString().split('T')[0]);\n\n            var start = Date.now();\n            document.getElementById('t3-api-status').textContent = 'Loading devices...';\n\n            api.call('Get', { typeName: 'Device' }, function(devices) {\n                debug('t3-debug', 'Found ' + devices.length + ' devices' + (devices.length >= 5000 ? ' (LIMIT)' : ''));\n                document.getElementById('t3-api-status').textContent = 'Querying ' + devices.length + ' devices...';\n                \n                var deviceDistances = {};\n                var completed = 0;\n                var totalDevices = devices.length;\n                var totalTripsProcessed = 0;\n                \n                devices.forEach(function(device) {\n                    api.call('Get', {\n                        typeName: 'Trip',\n                        search: {\n                            deviceSearch: { id: device.id },\n                            fromDate: fromDate.toISOString(),\n                            toDate: now.toISOString()\n                        }\n                    }, function(trips) {\n                        var totalMeters = 0;\n                        trips.forEach(function(trip) {\n                            totalMeters += trip.distance || 0;\n                        });\n                        \n                        var totalKm = totalMeters / 1000;\n                        var totalMiles = totalKm * 0.621371;\n                        \n                        deviceDistances[device.id] = {\n                            id: device.id,\n                            name: device.name || device.id,\n                            distanceMeters: totalMeters,\n                            distanceKm: totalKm,\n                            distanceMiles: totalMiles,\n                            trips: trips.length\n                        };\n                        \n                        totalTripsProcessed += trips.length;\n                        completed++;\n                        \n                        if (completed % 100 === 0 || completed === totalDevices) {\n                            document.getElementById('t3-api-status').textContent = 'Device ' + completed + '/' + totalDevices + '...';\n                        }\n                        \n                        if (completed === totalDevices) {\n                            finishTest3Api(deviceDistances, start, totalTripsProcessed);\n                        }\n                    }, function(e) {\n                        completed++;\n                        if (completed === totalDevices) {\n                            finishTest3Api(deviceDistances, start, totalTripsProcessed);\n                        }\n                    });\n                });\n            }, function(e) {\n                document.getElementById('t3-api-status').textContent = 'Error';\n                debug('t3-debug', 'API ERROR: ' + JSON.stringify(e));\n            });\n        }\n        \n        function finishTest3Api(deviceDistances, startTime, totalTrips) {\n            var elapsed = Date.now() - startTime;\n            \n            var sorted = Object.values(deviceDistances).sort(function(a, b) {\n                return b.distanceMiles - a.distanceMiles;\n            });\n            \n            var top3 = sorted.slice(0, 3);\n            var totalMiles = sorted.reduce(function(sum, d) { return sum + d.distanceMiles; }, 0);\n            var totalKm = sorted.reduce(function(sum, d) { return sum + d.distanceKm; }, 0);\n            var devicesWithTrips = sorted.filter(function(d) { return d.trips > 0; }).length;\n            \n            result('t3-api-result', '=== API Results (Per-Device Queries) ===');\n            result('t3-api-result', sorted.length + ' devices queried, ' + devicesWithTrips + ' with trips');\n            result('t3-api-result', 'Total trips: ' + totalTrips);\n            result('t3-api-result', 'Total: ' + totalKm.toFixed(1) + ' km = ' + totalMiles.toFixed(1) + ' miles');\n            result('t3-api-result', '---');\n            top3.forEach(function(d, i) {\n                result('t3-api-result', (i + 1) + '. ' + d.name + ': ' + d.distanceMiles.toFixed(1) + ' mi (' + d.trips + ' trips)');\n            });\n            \n            document.getElementById('t3-api-status').textContent = devicesWithTrips + ' devices w/trips';\n            document.getElementById('t3-api-time').textContent = elapsed + 'ms, ' + totalTrips + ' trips';\n            log('Test3 API: ' + totalTrips + ' trips from ' + devicesWithTrips + ' devices');\n        }\n\n        function runTest3Ace(api) {\n            var now = new Date();\n            var fromDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);\n            var fromStr = fromDate.toISOString().split('T')[0];\n            var toStr = now.toISOString().split('T')[0];\n            var question = 'What are the top 3 vehicles by total distance traveled from ' + fromStr + ' to ' + toStr + '? Return as JSON array with keys: device_name, miles.';\n            \n            var start = Date.now();\n\n            aceQuery(api, question, 't3', function(res) {\n                var elapsed = Date.now() - start;\n                \n                debug('t3-debug', '---');\n                debug('t3-debug', 'Ace completed in ' + Math.round(elapsed/1000) + 's');\n                debug('t3-debug', 'RAW DATA: ' + JSON.stringify(res.data, null, 2));\n                debug('t3-debug', 'RAW MESSAGES: ' + JSON.stringify(res.rawMessages, null, 2));\n                if (res.reasoning) debug('t3-debug', 'REASONING: ' + res.reasoning);\n\n                result('t3-ace-result', '=== Ace Results ===');\n\n                if (res.data && res.data.length > 0) {\n                    res.data.forEach(function(row, i) {\n                        var name = row.device_name || row.DeviceName || row.vehicleName || row.name || 'Unknown';\n                        var dist = row.miles || row.Miles || row.Distance_mi || row.distance || row.totalDistance || '?';\n                        result('t3-ace-result', (i + 1) + '. ' + name + ': ' + dist + ' mi');\n                    });\n                    result('t3-ace-result', '---');\n                    result('t3-ace-result', 'Raw rows:');\n                    res.data.forEach(function(row) {\n                        result('t3-ace-result', JSON.stringify(row));\n                    });\n                } else {\n                    result('t3-ace-result', 'No table data returned');\n                    if (res.reasoning) {\n                        result('t3-ace-result', '---');\n                        result('t3-ace-result', 'Reasoning: ' + res.reasoning.substring(0, 300) + '...');\n                    }\n                }\n\n                document.getElementById('t3-ace-status').textContent = res.data && res.data.length > 0 ? res.data.length + ' rows' : 'No data';\n                document.getElementById('t3-ace-time').textContent = Math.round(elapsed / 1000) + 's';\n                log('Test3 Ace: completed in ' + Math.round(elapsed/1000) + 's');\n            }, function(e) {\n                document.getElementById('t3-ace-status').textContent = 'Error';\n                debug('t3-debug', 'Ace ERROR: ' + e);\n                result('t3-ace-result', 'ERROR: ' + e);\n            });\n        }\n\n        // ============================================\n        // ACE QUERY HELPER\n        // ============================================\n        function aceQuery(api, question, testId, onSuccess, onError) {\n            log('Ace [' + testId + ']: \"' + question.substring(0, 50) + '...\"');\n\n            function tryCreateChat(attempt) {\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'create-chat',\n                    functionParameters: {}\n                }, function(r) {\n                    var d = getAceData(r);\n                    var chatId = d.chat_id;\n\n                    if (!chatId) {\n                        if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {\n                            log('Ace [' + testId + ']: Retrying create-chat...');\n                            setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);\n                        } else {\n                            onError('No chat_id after ' + ACE_CREATE_CHAT_RETRIES + ' attempts');\n                        }\n                        return;\n                    }\n                    onChatCreated(chatId);\n                }, function(e) {\n                    if (attempt + 1 < ACE_CREATE_CHAT_RETRIES) {\n                        setTimeout(function() { tryCreateChat(attempt + 1); }, ACE_RETRY_DELAY);\n                    } else {\n                        onError('create-chat failed: ' + JSON.stringify(e));\n                    }\n                });\n            }\n\n            function onChatCreated(chatId) {\n                log('Ace [' + testId + ']: Got chat_id');\n\n                api.call('GetAceResults', {\n                    serviceName: 'dna-planet-orchestration',\n                    functionName: 'send-prompt',\n                    functionParameters: {\n                        chat_id: chatId,\n                        prompt: question\n                    }\n                }, function(r2) {\n                    var d2 = getAceData(r2);\n                    var mgId = d2.message_group_id || ((d2.message_group || {}).id);\n\n                    if (!mgId) {\n                        onError('No message_group_id');\n                        return;\n                    }\n                    log('Ace [' + testId + ']: Polling...');\n\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, 0);\n                    }, ACE_INITIAL_POLL_DELAY);\n                }, function(e) {\n                    onError('send-prompt: ' + JSON.stringify(e));\n                });\n            }\n\n            tryCreateChat(0);\n        }\n\n        function pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt) {\n            if (attempt >= ACE_MAX_POLL_ATTEMPTS) {\n                onError('Timeout after ' + attempt + ' attempts');\n                return;\n            }\n\n            api.call('GetAceResults', {\n                serviceName: 'dna-planet-orchestration',\n                functionName: 'get-message-group',\n                functionParameters: {\n                    chat_id: chatId,\n                    message_group_id: mgId\n                }\n            }, function(r) {\n                var d = getAceData(r);\n                var mg = d.message_group || {};\n                var st = mg.status ? mg.status.status : 'UNKNOWN';\n\n                if (st === 'DONE') {\n                    var msgs = mg.messages || {};\n                    var res = { data: null, reasoning: null, rawMessages: msgs };\n                    var keys = Object.keys(msgs);\n\n                    keys.forEach(function(k) {\n                        var m = msgs[k];\n                        if (m.preview_array && m.preview_array.length > 0) {\n                            res.data = m.preview_array;\n                        }\n                        if (m.reasoning) {\n                            res.reasoning = m.reasoning;\n                        }\n                    });\n\n                    onSuccess(res);\n                } else if (st === 'FAILED') {\n                    onError('FAILED: ' + (mg.status.message || 'Unknown'));\n                } else {\n                    setTimeout(function() {\n                        pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                    }, ACE_POLL_INTERVAL);\n                }\n            }, function(e) {\n                setTimeout(function() {\n                    pollAce(api, chatId, mgId, testId, onSuccess, onError, attempt + 1);\n                }, ACE_POLL_INTERVAL);\n            });\n        }\n\n        console.log('Ace vs API Comparison v2.3 loaded');\n    </script>\n</body>\n</html>\n"
  }
}
