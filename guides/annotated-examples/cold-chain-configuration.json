{
  "name": "Cold Chain Historical View",
  "supportEmail": "https://github.com/fhoffa/geotab-vibe-guide",
  "version": "2.1",
  "items": [{
    "url": "coldchain.html",
    "path": "ActivityLink",
    "menuName": {
      "en": "Cold Chain Historical View"
    }
  }],
  "files": {
    "coldchain.html": "<!DOCTYPE html><html><head><meta charset='utf-8'><script src='https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js'></script><script src='https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js'></script><script src='https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js'></script><script src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'></script><script src='https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js'></script><script src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js'></script></head><body style='margin:0;padding:20px;font-family:sans-serif;background:#f4f7f9;'><div style='background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);'><h2 style='margin-top:0;color:#2c3e50;'>Cold Chain Historical View</h2><div style='display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap;align-items:flex-end;'><div style='display:flex;flex-direction:column;'><label style='font-size:12px;font-weight:bold;'>Select Vehicles (Ctrl+Click)</label><select id='devSelect' multiple style='padding:5px;border-radius:4px;border:1px solid #ccc;min-width:200px;height:85px;'></select></div><div style='display:flex;flex-direction:column;'><label style='font-size:12px;font-weight:bold;'>From</label><input type='datetime-local' id='fromDate' style='padding:7px;border-radius:4px;border:1px solid #ccc;'></div><div style='display:flex;flex-direction:column;'><label style='font-size:12px;font-weight:bold;'>To</label><input type='datetime-local' id='toDate' style='padding:7px;border-radius:4px;border:1px solid #ccc;'></div><button id='btnLoad' style='padding:8px 20px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;'>Plot Selection</button><button id='btnExport' style='padding:8px 20px;background:#e74c3c;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;'>Export PDF</button><button id='btnExcel' style='padding:8px 20px;background:#27ae60;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;'>Export Excel</button></div><div id='chartArea'></div><div id='status' style='margin-top:10px;font-size:14px;color:#666;'>Initializing...</div></div><script>geotab.addin['cold-chain-monitor']=function(){var chartInstances=[];var reportData=[];var diagActualId=null;var diagSetId=null;return{initialize:function(api,state,callback){var now=new Date();var yest=new Date();yest.setDate(now.getDate()-1);yest.setHours(0,0,0,0);var yestEnd=new Date();yestEnd.setDate(now.getDate()-1);yestEnd.setHours(23,59,59,999);var pad=function(n){return n<10?'0'+n:n;};var formatDT=function(d){return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate())+'T'+pad(d.getHours())+':'+pad(d.getMinutes());};document.getElementById('fromDate').value=formatDT(yest);document.getElementById('toDate').value=formatDT(yestEnd);api.multiCall([['Get',{typeName:'Device'}],['Get',{typeName:'Diagnostic',search:{name:'%Temperature%'}}]],function(res){var devs=res[0],diags=res[1];for(var i=0;i<diags.length;i++){var n=diags[i].name.toLowerCase();if(n.indexOf('set')>-1&&n.indexOf('zone 1')>-1)diagSetId=diags[i].id;if((n.indexOf('cargo')>-1||n.indexOf('air')>-1)&&n.indexOf('zone 1')>-1)diagActualId=diags[i].id;}var sel=document.getElementById('devSelect');devs.sort(function(a,b){return a.name.localeCompare(b.name);});devs.forEach(function(d){var o=document.createElement('option');o.value=d.id;o.innerHTML=d.name;sel.appendChild(o);});document.getElementById('status').innerHTML='Ready.';});document.getElementById('btnLoad').onclick=function(){var sel=document.getElementById('devSelect');var ids=[],names=[];for(var i=0;i<sel.options.length;i++){if(sel.options[i].selected){ids.push(sel.options[i].value);names.push(sel.options[i].text);}}if(!ids.length)return;document.getElementById('chartArea').innerHTML='';chartInstances=[];reportData=[];document.getElementById('status').innerHTML='Loading...';ids.forEach(function(id,idx){var fr=new Date(document.getElementById('fromDate').value).toISOString();var to=new Date(document.getElementById('toDate').value).toISOString();var calls=[];if(diagActualId)calls.push(['Get',{typeName:'StatusData',search:{deviceSearch:{id:id},diagnosticSearch:{id:diagActualId},fromDate:fr,toDate:to}}]);if(diagSetId)calls.push(['Get',{typeName:'StatusData',search:{deviceSearch:{id:id},diagnosticSearch:{id:diagSetId},fromDate:fr,toDate:to}}]);api.multiCall(calls,function(res){var act=res[0]||[],set=res[1]||[];reportData.push({name:names[idx],actuals:act,setpoints:set});var wrapper=document.createElement('div');wrapper.style.marginBottom='40px';wrapper.innerHTML='<h4 style=\"margin-bottom:5px;\">'+names[idx]+'</h4><div style=\"height:300px;width:100%;background:#fff;border:1px solid #eee;\"><canvas id=\"chart-'+idx+'\"></canvas></div>';document.getElementById('chartArea').appendChild(wrapper);var ctx=document.getElementById('chart-'+idx).getContext('2d');var c=new Chart(ctx,{type:'line',data:{datasets:[{label:'Cargo Temperature',data:act.map(function(p){return{x:moment(p.dateTime).toDate(),y:p.data};}),borderColor:'#ff4757',backgroundColor:'rgba(255,71,87,0.1)',fill:true,borderWidth:2},{label:'Setpoint',data:set.map(function(p){return{x:moment(p.dateTime).toDate(),y:p.data};}),borderColor:'#2f3542',borderDash:[5,5],borderWidth:2}]},options:{animation:false,responsive:true,maintainAspectRatio:false,scales:{x:{type:'time',time:{unit:'hour',displayFormats:{hour:'HH:mm'}}}}}});chartInstances.push({chart:c,canvasId:'chart-'+idx,name:names[idx]});});});};document.getElementById('btnExport').onclick=function(){var doc=new jspdf.jsPDF('p','mm','a4');doc.setFontSize(18);doc.text('Cold Chain Historical Report',14,15);chartInstances.forEach(function(ci,i){if(i>0)doc.addPage();var can=document.getElementById(ci.canvasId);var img=can.toDataURL('image/png',1.0);doc.setFontSize(14);doc.text('Vehicle: '+ci.name,14,25);doc.addImage(img,'PNG',10,30,190,90);var rows=[];var data=reportData.find(function(r){return r.name===ci.name;});data.actuals.forEach(function(r){rows.push([moment(r.dateTime).format('YYYY-MM-DD HH:mm'),r.data.toFixed(1)]);});doc.autoTable({head:[['Time (24h)','Cargo Temp (°C)']],body:rows.slice(0,100),startY:125,theme:'striped',headStyles:{fillColor:[44,62,80]}});});doc.save('ColdChain_Historical_Report.pdf');};document.getElementById('btnExcel').onclick=function(){var wb=XLSX.utils.book_new();reportData.forEach(function(d){var data=[];d.actuals.forEach(function(r){data.push({'Timestamp':moment(r.dateTime).format('YYYY-MM-DD HH:mm'),'Cargo Temperature (°C)':r.data.toFixed(1)});});var ws=XLSX.utils.json_to_sheet(data);XLSX.utils.book_append_sheet(wb,ws,d.name.substring(0,31));});XLSX.writeFile(wb,'Fleet_ColdChain_Data.xlsx');};callback();},focus:function(api,state){},blur:function(api,state){}};};</script></body></html>"
  }
}
